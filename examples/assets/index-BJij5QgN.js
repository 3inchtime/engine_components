var T=Object.defineProperty;var N=(g,m,e)=>m in g?T(g,m,{enumerable:!0,configurable:!0,writable:!0,value:e}):g[m]=e;var f=(g,m,e)=>(N(g,typeof m!="symbol"?m+"":m,e),e);import{az as k,aA as z,aB as P,aC as B,ag as v,ad as S,m as _,ae as W,af as O,N as R,C as U,a as $,c as V,e as C,ah as j}from"./web-ifc-api-DH5A5LIH.js";import{S as J,I as X,C as Y}from"./ifc-metadata-reader-Gnixi9ug.js";import{I as q}from"./ifc-fragment-settings-B1HGQKzE.js";import{F as H}from"./index-JlpMfDan.js";import{a as K,E as G,C as Q}from"./index-CyDQMoMp.js";import{G as Z}from"./ifc-geometry-types-C3SKrzrZ.js";class tt{async export(m,e,a=!1,r=!0){const n={},o=new Set(m.GetIfcEntityList(e)),i=new Set([k,z,P,B,v]);for(const t of i)o.add(t);for(const t of o){if(Z.has(t))continue;const c=i.has(t)&&r,p=m.GetLineIDsWithType(e,t);for(const h of p){const s=m.GetLine(0,h,c,a);n[s.expressID]=s}}return n}}const l=class l extends K{constructor(e){super(e);f(this,"onIfcStartedLoading",new G);f(this,"onSetup",new G);f(this,"onDisposed",new G);f(this,"settings",new q);f(this,"enabled",!0);f(this,"webIfc",new S);f(this,"_material",new _);f(this,"_spatialTree",new J);f(this,"_metaData",new X);f(this,"_fragmentInstances",new Map);f(this,"_civil",new Y);f(this,"_propertyExporter",new tt);f(this,"_visitedFragments",new Map);f(this,"_materialT",new _({transparent:!0,opacity:.5}));this.components.add(l.uuid,this),this.settings.excludedCategories.add(W)}dispose(){this.webIfc=null,this.onDisposed.trigger(l.uuid),this.onDisposed.reset()}async setup(e){this.settings={...this.settings,...e},this.settings.autoSetWasm&&await this.autoSetWasm(),this.onSetup.trigger()}async load(e,a=!0){const r=performance.now();this.onIfcStartedLoading.trigger(),await this.readIfcFile(e);const n=await this.getAllGeometries(),o=await this._propertyExporter.export(this.webIfc,0);n.setLocalProperties(o),this.cleanUp();const i=this.components.get(H);i.groups.set(n.uuid,n);for(const t of n.items)i.list.set(t.id,t),t.mesh.uuid=t.id,t.group=n;return i.onFragmentsLoaded.trigger(n),a&&i.coordinate([n]),console.log(`Streaming the IFC took ${performance.now()-r} ms!`),n}async readIfcFile(e){const{path:a,absolute:r,logLevel:n}=this.settings.wasm;return this.webIfc.SetWasmPath(a,r),await this.webIfc.Init(),n&&this.webIfc.SetLogLevel(n),this.webIfc.OpenModel(e,this.settings.webIfc)}async getAllGeometries(){this._spatialTree.setUp(this.webIfc);const e=this.webIfc.GetIfcEntityList(0),a=new O,{FILE_NAME:r,FILE_DESCRIPTION:n}=j;a.ifcMetadata={name:this._metaData.get(this.webIfc,r),description:this._metaData.get(this.webIfc,n),schema:this.webIfc.GetModelSchema(0)||"IFC2X3",maxExpressID:this.webIfc.GetMaxExpressID(0)};const o=[];for(const t of e){if(!this.webIfc.IsIfcElement(t)&&t!==v||this.settings.excludedCategories.has(t))continue;const c=this.webIfc.GetLineIDsWithType(0,t),p=c.size();for(let h=0;h<p;h++){const s=c.get(h);o.push(s);const w=this._spatialTree.itemsByFloor[s]||0;a.data.set(s,[[],[w,t]])}}this._spatialTree.cleanUp(),this.webIfc.StreamMeshes(0,o,t=>{this.getMesh(t,a)});for(const t of this._visitedFragments){const{index:c,fragment:p}=t[1];a.keyFragments.set(c,p.id)}for(const t of a.items){const c=this._fragmentInstances.get(t.id);if(!c)throw new Error("Fragment not found!");const p=[];for(const[h,s]of c)p.push(s);t.add(p)}const i=this.webIfc.GetCoordinationMatrix(0);return a.coordinationMatrix.fromArray(i),a.civilData=this._civil.read(this.webIfc),a}cleanUp(){this.webIfc=null,this.webIfc=new S,this._visitedFragments.clear(),this._fragmentInstances.clear()}getMesh(e,a){const r=e.geometries.size(),n=e.expressID;for(let o=0;o<r;o++){const i=e.geometries.get(o),{x:t,y:c,z:p,w:h}=i.color,s=h!==1,{geometryExpressID:w}=i,u=`${w}-${s}`;if(!this._visitedFragments.has(u)){const d=this.getGeometry(this.webIfc,w),A=s?this._materialT:this._material,E=new R(d,A,1);a.add(E.mesh),a.items.push(E);const L=this._visitedFragments.size;this._visitedFragments.set(u,{index:L,fragment:E})}const D=new U().setRGB(t,c,p,"srgb"),y=new $;y.fromArray(i.flatTransformation);const b=this._visitedFragments.get(u);if(b===void 0)throw new Error("Error getting geometry data for streaming!");const F=a.data.get(n);if(!F)throw new Error("Data not found!");F[0].push(b.index);const{fragment:x}=b;this._fragmentInstances.has(x.id)||this._fragmentInstances.set(x.id,new Map);const I=this._fragmentInstances.get(x.id);if(!I)throw new Error("Instances not found!");if(I.has(n)){const d=I.get(n);if(!d)throw new Error("Instance not found!");d.transforms.push(y),d.colors&&d.colors.push(D)}else I.set(n,{id:n,transforms:[y],colors:[D]})}}getGeometry(e,a){const r=e.GetGeometry(0,a),n=e.GetIndexArray(r.GetIndexData(),r.GetIndexDataSize()),o=e.GetVertexArray(r.GetVertexData(),r.GetVertexDataSize()),i=new Float32Array(o.length/2),t=new Float32Array(o.length/2);for(let s=0;s<o.length;s+=6)i[s/2]=o[s],i[s/2+1]=o[s+1],i[s/2+2]=o[s+2],t[s/2]=o[s+3],t[s/2+1]=o[s+4],t[s/2+2]=o[s+5];const c=new V,p=new C(i,3),h=new C(t,3);return c.setAttribute("position",p),c.setAttribute("normal",h),c.setIndex(Array.from(n)),r.delete(),c}async autoSetWasm(){const e=await fetch(`https://unpkg.com/openbim-components@${Q.release}/package.json`);if(!e.ok){console.warn("Couldn't get openbim-components package.json. Set wasm settings manually.");return}const a=await e.json();if(!("web-ifc"in a.peerDependencies))console.warn("Couldn't get web-ifc from peer dependencies in openbim-components. Set wasm settings manually.");else{const r=a.peerDependencies["web-ifc"];this.settings.wasm.path=`https://unpkg.com/web-ifc@${r}/`,this.settings.wasm.absolute=!0}}};f(l,"uuid","a659add7-1418-4771-a0d6-7d4d438e4624");let M=l;export{M as F};
