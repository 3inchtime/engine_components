var Pt=Object.defineProperty;var Rt=(l,t,e)=>t in l?Pt(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var R=(l,t,e)=>(Rt(l,typeof t!="symbol"?t+"":t,e),e);import{C as lt,V as ft,p as Ft,D as zt,A as Mt,q as It,a7 as bt,a8 as Ht,f as kt,$ as Yt,Q as Vt,a as Bt,a9 as Zt,r as Nt,w as Xt,R as Kt,h as Qt}from"./web-ifc-api-DH5A5LIH.js";import{B as Gt,E as N,a as Wt}from"./index-CyDQMoMp.js";class Lt extends Gt{constructor(e){super(e);R(this,"worlds",new Map);R(this,"onWorldChanged",new N);R(this,"currentWorld",null);this.onWorldChanged.add(({world:s,action:r})=>{r==="removed"&&this.worlds.delete(s.uuid)})}}class qt extends Lt{constructor(){super(...arguments);R(this,"hasCameraControls",()=>"controls"in this)}}const tt=class tt extends Wt{constructor(e){super(e);R(this,"_disposedComponents",new Set);R(this,"enabled",!0);e.add(tt.uuid,this)}get(){return this._disposedComponents}destroy(e,s=!0,r=!0){e.removeFromParent();const n=e;n.dispose&&n.dispose(),this.disposeGeometryAndMaterials(e,s),r&&n.children&&n.children.length&&this.disposeChildren(n),e.children.length=0}disposeGeometry(e){const s=e;s.boundsTree&&s.disposeBoundsTree(),e.dispose()}disposeGeometryAndMaterials(e,s){const r=e;r.geometry&&this.disposeGeometry(r.geometry),s&&r.material&&tt.disposeMaterial(r),r.material=[],r.geometry=null}disposeChildren(e){for(const s of e.children)this.destroy(s)}static disposeMaterial(e){if(e.material)if(Array.isArray(e.material))for(const s of e.material)s.dispose();else e.material.dispose()}};R(tt,"uuid","76e9cd8e-ad8f-4753-9ef6-cbc60f7247fe");let gt=tt;class jt extends Lt{constructor(e){super(e);R(this,"onDisposed",new N)}dispose(){const e=this.components.get(gt);for(const s of this.three.children){const r=s;r.geometry&&e.destroy(r)}this.three.children=[],this.onDisposed.trigger(),this.onDisposed.reset()}}class re extends jt{constructor(e){super(e);R(this,"isSetup",!1);R(this,"three");R(this,"onSetup",new N);R(this,"config",{directionalLight:{color:new lt("white"),intensity:1.5,position:new ft(5,10,3)},ambientLight:{color:new lt("white"),intensity:1}});this.three=new Ft,this.three.background=new lt(2107698)}setup(e){this.config={...this.config,...e};const s=new zt(this.config.directionalLight.color,this.config.directionalLight.intensity);s.position.copy(this.config.directionalLight.position);const r=new Mt(this.config.ambientLight.color,this.config.ambientLight.intensity);this.three.add(s,r),this.isSetup=!0,this.onSetup.trigger(this)}}/*!
 * camera-controls
 * https://github.com/yomotsu/camera-controls
 * (c) 2017 @yomotsu
 * Released under the MIT License.
 */const d={LEFT:1,RIGHT:2,MIDDLE:4},i=Object.freeze({NONE:0,ROTATE:1,TRUCK:2,OFFSET:4,DOLLY:8,ZOOM:16,TOUCH_ROTATE:32,TOUCH_TRUCK:64,TOUCH_OFFSET:128,TOUCH_DOLLY:256,TOUCH_ZOOM:512,TOUCH_DOLLY_TRUCK:1024,TOUCH_DOLLY_OFFSET:2048,TOUCH_DOLLY_ROTATE:4096,TOUCH_ZOOM_TRUCK:8192,TOUCH_ZOOM_OFFSET:16384,TOUCH_ZOOM_ROTATE:32768}),X={NONE:0,IN:1,OUT:-1};function B(l){return l.isPerspectiveCamera}function V(l){return l.isOrthographicCamera}const K=Math.PI*2,Et=Math.PI/2,xt=1e-5,W=Math.PI/180;function H(l,t,e){return Math.max(t,Math.min(e,l))}function x(l,t=xt){return Math.abs(l)<t}function L(l,t,e=xt){return x(l-t,e)}function yt(l,t){return Math.round(l/t)*t}function q(l){return isFinite(l)?l:l<0?-Number.MAX_VALUE:Number.MAX_VALUE}function j(l){return Math.abs(l)<Number.MAX_VALUE?l:l*(1/0)}function ot(l,t,e,s,r=1/0,n){s=Math.max(1e-4,s);const a=2/s,h=a*n,m=1/(1+h+.48*h*h+.235*h*h*h);let p=l-t;const O=t,f=r*s;p=H(p,-f,f),t=l-p;const D=(e.value+a*p)*n;e.value=(e.value-a*D)*m;let g=t+(p+D)*m;return O-l>0==g>O&&(g=O,e.value=(g-O)/n),g}function Tt(l,t,e,s,r=1/0,n,a){s=Math.max(1e-4,s);const h=2/s,m=h*n,p=1/(1+m+.48*m*m+.235*m*m*m);let O=t.x,f=t.y,D=t.z,g=l.x-O,w=l.y-f,C=l.z-D;const S=O,P=f,A=D,z=r*s,o=z*z,c=g*g+w*w+C*C;if(c>o){const ht=Math.sqrt(c);g=g/ht*z,w=w/ht*z,C=C/ht*z}O=l.x-g,f=l.y-w,D=l.z-C;const y=(e.x+h*g)*n,u=(e.y+h*w)*n,U=(e.z+h*C)*n;e.x=(e.x-h*y)*p,e.y=(e.y-h*u)*p,e.z=(e.z-h*U)*p,a.x=O+(g+y)*p,a.y=f+(w+u)*p,a.z=D+(C+U)*p;const T=S-l.x,F=P-l.y,I=A-l.z,st=a.x-S,it=a.y-P,St=a.z-A;return T*st+F*it+I*St>0&&(a.x=S,a.y=P,a.z=A,e.x=(a.x-S)/n,e.y=(a.y-P)/n,e.z=(a.z-A)/n),a}function ct(l,t){t.set(0,0),l.forEach(e=>{t.x+=e.clientX,t.y+=e.clientY}),t.x/=l.length,t.y/=l.length}function _t(l,t){return V(l)?(console.warn(`${t} is not supported in OrthographicCamera`),!0):!1}class Jt{constructor(){this._listeners={}}addEventListener(t,e){const s=this._listeners;s[t]===void 0&&(s[t]=[]),s[t].indexOf(e)===-1&&s[t].push(e)}hasEventListener(t,e){const s=this._listeners;return s[t]!==void 0&&s[t].indexOf(e)!==-1}removeEventListener(t,e){const r=this._listeners[t];if(r!==void 0){const n=r.indexOf(e);n!==-1&&r.splice(n,1)}}removeAllEventListeners(t){if(!t){this._listeners={};return}Array.isArray(this._listeners[t])&&(this._listeners[t].length=0)}dispatchEvent(t){const s=this._listeners[t.type];if(s!==void 0){t.target=this;const r=s.slice(0);for(let n=0,a=r.length;n<a;n++)r[n].call(this,t)}}}const $t="2.7.3",rt=1/8,wt=typeof window<"u",te=wt&&/Mac/.test(navigator.platform),ee=!(wt&&"PointerEvent"in window);let _,Ot,nt,dt,M,E,v,Q,J,k,Y,Z,Ct,vt,b,$,G,Ut,mt,Dt,pt,ut,at;class et extends Jt{static install(t){_=t.THREE,Ot=Object.freeze(new _.Vector3(0,0,0)),nt=Object.freeze(new _.Vector3(0,1,0)),dt=Object.freeze(new _.Vector3(0,0,1)),M=new _.Vector2,E=new _.Vector3,v=new _.Vector3,Q=new _.Vector3,J=new _.Vector3,k=new _.Vector3,Y=new _.Vector3,Z=new _.Vector3,Ct=new _.Vector3,vt=new _.Vector3,b=new _.Spherical,$=new _.Spherical,G=new _.Box3,Ut=new _.Box3,mt=new _.Sphere,Dt=new _.Quaternion,pt=new _.Quaternion,ut=new _.Matrix4,at=new _.Raycaster}static get ACTION(){return i}constructor(t,e){super(),this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.minDistance=Number.EPSILON,this.maxDistance=1/0,this.infinityDolly=!1,this.minZoom=.01,this.maxZoom=1/0,this.smoothTime=.25,this.draggingSmoothTime=.125,this.maxSpeed=1/0,this.azimuthRotateSpeed=1,this.polarRotateSpeed=1,this.dollySpeed=1,this.dollyDragInverted=!1,this.truckSpeed=2,this.dollyToCursor=!1,this.dragToOffset=!1,this.verticalDragToForward=!1,this.boundaryFriction=0,this.restThreshold=.01,this.colliderMeshes=[],this.cancel=()=>{},this._enabled=!0,this._state=i.NONE,this._viewport=null,this._changedDolly=0,this._changedZoom=0,this._hasRested=!0,this._boundaryEnclosesCamera=!1,this._needsUpdate=!0,this._updatedLastTime=!1,this._elementRect=new DOMRect,this._isDragging=!1,this._dragNeedsUpdate=!0,this._activePointers=[],this._lockedPointer=null,this._interactiveArea=new DOMRect(0,0,1,1),this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._isUserControllingOffset=!1,this._isUserControllingZoom=!1,this._lastDollyDirection=X.NONE,this._thetaVelocity={value:0},this._phiVelocity={value:0},this._radiusVelocity={value:0},this._targetVelocity=new _.Vector3,this._focalOffsetVelocity=new _.Vector3,this._zoomVelocity={value:0},this._truckInternal=(o,c,y)=>{let u,U;if(B(this._camera)){const T=E.copy(this._camera.position).sub(this._target),F=this._camera.getEffectiveFOV()*W,I=T.length()*Math.tan(F*.5);u=this.truckSpeed*o*I/this._elementRect.height,U=this.truckSpeed*c*I/this._elementRect.height}else if(V(this._camera)){const T=this._camera;u=o*(T.right-T.left)/T.zoom/this._elementRect.width,U=c*(T.top-T.bottom)/T.zoom/this._elementRect.height}else return;this.verticalDragToForward?(y?this.setFocalOffset(this._focalOffsetEnd.x+u,this._focalOffsetEnd.y,this._focalOffsetEnd.z,!0):this.truck(u,0,!0),this.forward(-U,!0)):y?this.setFocalOffset(this._focalOffsetEnd.x+u,this._focalOffsetEnd.y+U,this._focalOffsetEnd.z,!0):this.truck(u,U,!0)},this._rotateInternal=(o,c)=>{const y=K*this.azimuthRotateSpeed*o/this._elementRect.height,u=K*this.polarRotateSpeed*c/this._elementRect.height;this.rotate(y,u,!0)},this._dollyInternal=(o,c,y)=>{const u=Math.pow(.95,-o*this.dollySpeed),U=this._sphericalEnd.radius,T=this._sphericalEnd.radius*u,F=H(T,this.minDistance,this.maxDistance),I=F-T;this.infinityDolly&&this.dollyToCursor?this._dollyToNoClamp(T,!0):this.infinityDolly&&!this.dollyToCursor?(this.dollyInFixed(I,!0),this._dollyToNoClamp(F,!0)):this._dollyToNoClamp(F,!0),this.dollyToCursor&&(this._changedDolly+=(this.infinityDolly?T:F)-U,this._dollyControlCoord.set(c,y)),this._lastDollyDirection=Math.sign(-o)},this._zoomInternal=(o,c,y)=>{const u=Math.pow(.95,o*this.dollySpeed),U=this._zoom,T=this._zoom*u;this.zoomTo(T,!0),this.dollyToCursor&&(this._changedZoom+=T-U,this._dollyControlCoord.set(c,y))},typeof _>"u"&&console.error("camera-controls: `THREE` is undefined. You must first run `CameraControls.install( { THREE: THREE } )`. Check the docs for further information."),this._camera=t,this._yAxisUpSpace=new _.Quaternion().setFromUnitVectors(this._camera.up,nt),this._yAxisUpSpaceInverse=this._yAxisUpSpace.clone().invert(),this._state=i.NONE,this._target=new _.Vector3,this._targetEnd=this._target.clone(),this._focalOffset=new _.Vector3,this._focalOffsetEnd=this._focalOffset.clone(),this._spherical=new _.Spherical().setFromVector3(E.copy(this._camera.position).applyQuaternion(this._yAxisUpSpace)),this._sphericalEnd=this._spherical.clone(),this._lastDistance=this._spherical.radius,this._zoom=this._camera.zoom,this._zoomEnd=this._zoom,this._lastZoom=this._zoom,this._nearPlaneCorners=[new _.Vector3,new _.Vector3,new _.Vector3,new _.Vector3],this._updateNearPlaneCorners(),this._boundary=new _.Box3(new _.Vector3(-1/0,-1/0,-1/0),new _.Vector3(1/0,1/0,1/0)),this._cameraUp0=this._camera.up.clone(),this._target0=this._target.clone(),this._position0=this._camera.position.clone(),this._zoom0=this._zoom,this._focalOffset0=this._focalOffset.clone(),this._dollyControlCoord=new _.Vector2,this.mouseButtons={left:i.ROTATE,middle:i.DOLLY,right:i.TRUCK,wheel:B(this._camera)?i.DOLLY:V(this._camera)?i.ZOOM:i.NONE},this.touches={one:i.TOUCH_ROTATE,two:B(this._camera)?i.TOUCH_DOLLY_TRUCK:V(this._camera)?i.TOUCH_ZOOM_TRUCK:i.NONE,three:i.TOUCH_TRUCK};const s=new _.Vector2,r=new _.Vector2,n=new _.Vector2,a=o=>{if(!this._enabled||!this._domElement)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const u=this._domElement.getBoundingClientRect(),U=o.clientX/u.width,T=o.clientY/u.height;if(U<this._interactiveArea.left||U>this._interactiveArea.right||T<this._interactiveArea.top||T>this._interactiveArea.bottom)return}const c=o.pointerType!=="mouse"?null:(o.buttons&d.LEFT)===d.LEFT?d.LEFT:(o.buttons&d.MIDDLE)===d.MIDDLE?d.MIDDLE:(o.buttons&d.RIGHT)===d.RIGHT?d.RIGHT:null;if(c!==null){const u=this._findPointerByMouseButton(c);u&&this._disposePointer(u)}if((o.buttons&d.LEFT)===d.LEFT&&this._lockedPointer)return;const y={pointerId:o.pointerId,clientX:o.clientX,clientY:o.clientY,deltaX:0,deltaY:0,mouseButton:c};this._activePointers.push(y),this._domElement.ownerDocument.removeEventListener("pointermove",m,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",O),this._domElement.ownerDocument.addEventListener("pointermove",m,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",O),this._isDragging=!0,C(o)},h=o=>{if(!this._enabled||!this._domElement||this._lockedPointer)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const u=this._domElement.getBoundingClientRect(),U=o.clientX/u.width,T=o.clientY/u.height;if(U<this._interactiveArea.left||U>this._interactiveArea.right||T<this._interactiveArea.top||T>this._interactiveArea.bottom)return}const c=(o.buttons&d.LEFT)===d.LEFT?d.LEFT:(o.buttons&d.MIDDLE)===d.MIDDLE?d.MIDDLE:(o.buttons&d.RIGHT)===d.RIGHT?d.RIGHT:null;if(c!==null){const u=this._findPointerByMouseButton(c);u&&this._disposePointer(u)}const y={pointerId:1,clientX:o.clientX,clientY:o.clientY,deltaX:0,deltaY:0,mouseButton:(o.buttons&d.LEFT)===d.LEFT?d.LEFT:(o.buttons&d.MIDDLE)===d.LEFT?d.MIDDLE:(o.buttons&d.RIGHT)===d.LEFT?d.RIGHT:null};this._activePointers.push(y),this._domElement.ownerDocument.removeEventListener("mousemove",p),this._domElement.ownerDocument.removeEventListener("mouseup",f),this._domElement.ownerDocument.addEventListener("mousemove",p),this._domElement.ownerDocument.addEventListener("mouseup",f),this._isDragging=!0,C(o)},m=o=>{o.cancelable&&o.preventDefault();const c=o.pointerId,y=this._lockedPointer||this._findPointerById(c);if(y){if(y.clientX=o.clientX,y.clientY=o.clientY,y.deltaX=o.movementX,y.deltaY=o.movementY,this._state=0,o.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else(!this._isDragging&&this._lockedPointer||this._isDragging&&(o.buttons&d.LEFT)===d.LEFT)&&(this._state=this._state|this.mouseButtons.left),this._isDragging&&(o.buttons&d.MIDDLE)===d.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),this._isDragging&&(o.buttons&d.RIGHT)===d.RIGHT&&(this._state=this._state|this.mouseButtons.right);S()}},p=o=>{const c=this._lockedPointer||this._findPointerById(1);c&&(c.clientX=o.clientX,c.clientY=o.clientY,c.deltaX=o.movementX,c.deltaY=o.movementY,this._state=0,(this._lockedPointer||(o.buttons&d.LEFT)===d.LEFT)&&(this._state=this._state|this.mouseButtons.left),(o.buttons&d.MIDDLE)===d.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),(o.buttons&d.RIGHT)===d.RIGHT&&(this._state=this._state|this.mouseButtons.right),S())},O=o=>{const c=this._findPointerById(o.pointerId);if(!(c&&c===this._lockedPointer)){if(c&&this._disposePointer(c),o.pointerType==="touch")switch(this._activePointers.length){case 0:this._state=i.NONE;break;case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else this._state=i.NONE;P()}},f=()=>{const o=this._findPointerById(1);o&&o===this._lockedPointer||(o&&this._disposePointer(o),this._state=i.NONE,P())};let D=-1;const g=o=>{if(!this._domElement||!this._enabled||this.mouseButtons.wheel===i.NONE)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const T=this._domElement.getBoundingClientRect(),F=o.clientX/T.width,I=o.clientY/T.height;if(F<this._interactiveArea.left||F>this._interactiveArea.right||I<this._interactiveArea.top||I>this._interactiveArea.bottom)return}if(o.preventDefault(),this.dollyToCursor||this.mouseButtons.wheel===i.ROTATE||this.mouseButtons.wheel===i.TRUCK){const T=performance.now();D-T<1e3&&this._getClientRect(this._elementRect),D=T}const c=te?-1:-3,y=o.deltaMode===1?o.deltaY/c:o.deltaY/(c*10),u=this.dollyToCursor?(o.clientX-this._elementRect.x)/this._elementRect.width*2-1:0,U=this.dollyToCursor?(o.clientY-this._elementRect.y)/this._elementRect.height*-2+1:0;switch(this.mouseButtons.wheel){case i.ROTATE:{this._rotateInternal(o.deltaX,o.deltaY),this._isUserControllingRotate=!0;break}case i.TRUCK:{this._truckInternal(o.deltaX,o.deltaY,!1),this._isUserControllingTruck=!0;break}case i.OFFSET:{this._truckInternal(o.deltaX,o.deltaY,!0),this._isUserControllingOffset=!0;break}case i.DOLLY:{this._dollyInternal(-y,u,U),this._isUserControllingDolly=!0;break}case i.ZOOM:{this._zoomInternal(-y,u,U),this._isUserControllingZoom=!0;break}}this.dispatchEvent({type:"control"})},w=o=>{if(!(!this._domElement||!this._enabled)){if(this.mouseButtons.right===et.ACTION.NONE){const c=o instanceof PointerEvent?o.pointerId:(o instanceof MouseEvent,0),y=this._findPointerById(c);y&&this._disposePointer(y),this._domElement.ownerDocument.removeEventListener("pointermove",m,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",O),this._domElement.ownerDocument.removeEventListener("mousemove",p),this._domElement.ownerDocument.removeEventListener("mouseup",f);return}o.preventDefault()}},C=o=>{if(!this._enabled)return;if(ct(this._activePointers,M),this._getClientRect(this._elementRect),s.copy(M),r.copy(M),this._activePointers.length>=2){const y=M.x-this._activePointers[1].clientX,u=M.y-this._activePointers[1].clientY,U=Math.sqrt(y*y+u*u);n.set(0,U);const T=(this._activePointers[0].clientX+this._activePointers[1].clientX)*.5,F=(this._activePointers[0].clientY+this._activePointers[1].clientY)*.5;r.set(T,F)}if(this._state=0,!o)this._lockedPointer&&(this._state=this._state|this.mouseButtons.left);else if("pointerType"in o&&o.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else!this._lockedPointer&&(o.buttons&d.LEFT)===d.LEFT&&(this._state=this._state|this.mouseButtons.left),(o.buttons&d.MIDDLE)===d.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),(o.buttons&d.RIGHT)===d.RIGHT&&(this._state=this._state|this.mouseButtons.right);((this._state&i.ROTATE)===i.ROTATE||(this._state&i.TOUCH_ROTATE)===i.TOUCH_ROTATE||(this._state&i.TOUCH_DOLLY_ROTATE)===i.TOUCH_DOLLY_ROTATE||(this._state&i.TOUCH_ZOOM_ROTATE)===i.TOUCH_ZOOM_ROTATE)&&(this._sphericalEnd.theta=this._spherical.theta,this._sphericalEnd.phi=this._spherical.phi,this._thetaVelocity.value=0,this._phiVelocity.value=0),((this._state&i.TRUCK)===i.TRUCK||(this._state&i.TOUCH_TRUCK)===i.TOUCH_TRUCK||(this._state&i.TOUCH_DOLLY_TRUCK)===i.TOUCH_DOLLY_TRUCK||(this._state&i.TOUCH_ZOOM_TRUCK)===i.TOUCH_ZOOM_TRUCK)&&(this._targetEnd.copy(this._target),this._targetVelocity.set(0,0,0)),((this._state&i.DOLLY)===i.DOLLY||(this._state&i.TOUCH_DOLLY)===i.TOUCH_DOLLY||(this._state&i.TOUCH_DOLLY_TRUCK)===i.TOUCH_DOLLY_TRUCK||(this._state&i.TOUCH_DOLLY_OFFSET)===i.TOUCH_DOLLY_OFFSET||(this._state&i.TOUCH_DOLLY_ROTATE)===i.TOUCH_DOLLY_ROTATE)&&(this._sphericalEnd.radius=this._spherical.radius,this._radiusVelocity.value=0),((this._state&i.ZOOM)===i.ZOOM||(this._state&i.TOUCH_ZOOM)===i.TOUCH_ZOOM||(this._state&i.TOUCH_ZOOM_TRUCK)===i.TOUCH_ZOOM_TRUCK||(this._state&i.TOUCH_ZOOM_OFFSET)===i.TOUCH_ZOOM_OFFSET||(this._state&i.TOUCH_ZOOM_ROTATE)===i.TOUCH_ZOOM_ROTATE)&&(this._zoomEnd=this._zoom,this._zoomVelocity.value=0),((this._state&i.OFFSET)===i.OFFSET||(this._state&i.TOUCH_OFFSET)===i.TOUCH_OFFSET||(this._state&i.TOUCH_DOLLY_OFFSET)===i.TOUCH_DOLLY_OFFSET||(this._state&i.TOUCH_ZOOM_OFFSET)===i.TOUCH_ZOOM_OFFSET)&&(this._focalOffsetEnd.copy(this._focalOffset),this._focalOffsetVelocity.set(0,0,0)),this.dispatchEvent({type:"controlstart"})},S=()=>{if(!this._enabled||!this._dragNeedsUpdate)return;this._dragNeedsUpdate=!1,ct(this._activePointers,M);const c=this._domElement&&document.pointerLockElement===this._domElement?this._lockedPointer||this._activePointers[0]:null,y=c?-c.deltaX:r.x-M.x,u=c?-c.deltaY:r.y-M.y;if(r.copy(M),((this._state&i.ROTATE)===i.ROTATE||(this._state&i.TOUCH_ROTATE)===i.TOUCH_ROTATE||(this._state&i.TOUCH_DOLLY_ROTATE)===i.TOUCH_DOLLY_ROTATE||(this._state&i.TOUCH_ZOOM_ROTATE)===i.TOUCH_ZOOM_ROTATE)&&(this._rotateInternal(y,u),this._isUserControllingRotate=!0),(this._state&i.DOLLY)===i.DOLLY||(this._state&i.ZOOM)===i.ZOOM){const U=this.dollyToCursor?(s.x-this._elementRect.x)/this._elementRect.width*2-1:0,T=this.dollyToCursor?(s.y-this._elementRect.y)/this._elementRect.height*-2+1:0,F=this.dollyDragInverted?-1:1;(this._state&i.DOLLY)===i.DOLLY?(this._dollyInternal(F*u*rt,U,T),this._isUserControllingDolly=!0):(this._zoomInternal(F*u*rt,U,T),this._isUserControllingZoom=!0)}if((this._state&i.TOUCH_DOLLY)===i.TOUCH_DOLLY||(this._state&i.TOUCH_ZOOM)===i.TOUCH_ZOOM||(this._state&i.TOUCH_DOLLY_TRUCK)===i.TOUCH_DOLLY_TRUCK||(this._state&i.TOUCH_ZOOM_TRUCK)===i.TOUCH_ZOOM_TRUCK||(this._state&i.TOUCH_DOLLY_OFFSET)===i.TOUCH_DOLLY_OFFSET||(this._state&i.TOUCH_ZOOM_OFFSET)===i.TOUCH_ZOOM_OFFSET||(this._state&i.TOUCH_DOLLY_ROTATE)===i.TOUCH_DOLLY_ROTATE||(this._state&i.TOUCH_ZOOM_ROTATE)===i.TOUCH_ZOOM_ROTATE){const U=M.x-this._activePointers[1].clientX,T=M.y-this._activePointers[1].clientY,F=Math.sqrt(U*U+T*T),I=n.y-F;n.set(0,F);const st=this.dollyToCursor?(r.x-this._elementRect.x)/this._elementRect.width*2-1:0,it=this.dollyToCursor?(r.y-this._elementRect.y)/this._elementRect.height*-2+1:0;(this._state&i.TOUCH_DOLLY)===i.TOUCH_DOLLY||(this._state&i.TOUCH_DOLLY_ROTATE)===i.TOUCH_DOLLY_ROTATE||(this._state&i.TOUCH_DOLLY_TRUCK)===i.TOUCH_DOLLY_TRUCK||(this._state&i.TOUCH_DOLLY_OFFSET)===i.TOUCH_DOLLY_OFFSET?(this._dollyInternal(I*rt,st,it),this._isUserControllingDolly=!0):(this._zoomInternal(I*rt,st,it),this._isUserControllingZoom=!0)}((this._state&i.TRUCK)===i.TRUCK||(this._state&i.TOUCH_TRUCK)===i.TOUCH_TRUCK||(this._state&i.TOUCH_DOLLY_TRUCK)===i.TOUCH_DOLLY_TRUCK||(this._state&i.TOUCH_ZOOM_TRUCK)===i.TOUCH_ZOOM_TRUCK)&&(this._truckInternal(y,u,!1),this._isUserControllingTruck=!0),((this._state&i.OFFSET)===i.OFFSET||(this._state&i.TOUCH_OFFSET)===i.TOUCH_OFFSET||(this._state&i.TOUCH_DOLLY_OFFSET)===i.TOUCH_DOLLY_OFFSET||(this._state&i.TOUCH_ZOOM_OFFSET)===i.TOUCH_ZOOM_OFFSET)&&(this._truckInternal(y,u,!0),this._isUserControllingOffset=!0),this.dispatchEvent({type:"control"})},P=()=>{ct(this._activePointers,M),r.copy(M),this._dragNeedsUpdate=!1,(this._activePointers.length===0||this._activePointers.length===1&&this._activePointers[0]===this._lockedPointer)&&(this._isDragging=!1),this._activePointers.length===0&&this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointermove",m,{passive:!1}),this._domElement.ownerDocument.removeEventListener("mousemove",p),this._domElement.ownerDocument.removeEventListener("pointerup",O),this._domElement.ownerDocument.removeEventListener("mouseup",f),this.dispatchEvent({type:"controlend"}))};this.lockPointer=()=>{!this._enabled||!this._domElement||(this.cancel(),this._lockedPointer={pointerId:-1,clientX:0,clientY:0,deltaX:0,deltaY:0,mouseButton:null},this._activePointers.push(this._lockedPointer),this._domElement.ownerDocument.removeEventListener("pointermove",m,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",O),this._domElement.requestPointerLock(),this._domElement.ownerDocument.addEventListener("pointerlockchange",A),this._domElement.ownerDocument.addEventListener("pointerlockerror",z),this._domElement.ownerDocument.addEventListener("pointermove",m,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",O),C())},this.unlockPointer=()=>{this._lockedPointer!==null&&(this._disposePointer(this._lockedPointer),this._lockedPointer=null),document.exitPointerLock(),this.cancel(),this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointerlockchange",A),this._domElement.ownerDocument.removeEventListener("pointerlockerror",z))};const A=()=>{this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement||this.unlockPointer()},z=()=>{this.unlockPointer()};this._addAllEventListeners=o=>{this._domElement=o,this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none",this._domElement.addEventListener("pointerdown",a),ee&&this._domElement.addEventListener("mousedown",h),this._domElement.addEventListener("pointercancel",O),this._domElement.addEventListener("wheel",g,{passive:!1}),this._domElement.addEventListener("contextmenu",w)},this._removeAllEventListeners=()=>{this._domElement&&(this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect="",this._domElement.removeEventListener("pointerdown",a),this._domElement.removeEventListener("mousedown",h),this._domElement.removeEventListener("pointercancel",O),this._domElement.removeEventListener("wheel",g,{passive:!1}),this._domElement.removeEventListener("contextmenu",w),this._domElement.ownerDocument.removeEventListener("pointermove",m,{passive:!1}),this._domElement.ownerDocument.removeEventListener("mousemove",p),this._domElement.ownerDocument.removeEventListener("pointerup",O),this._domElement.ownerDocument.removeEventListener("mouseup",f),this._domElement.ownerDocument.removeEventListener("pointerlockchange",A),this._domElement.ownerDocument.removeEventListener("pointerlockerror",z))},this.cancel=()=>{this._state!==i.NONE&&(this._state=i.NONE,this._activePointers.length=0,P())},e&&this.connect(e),this.update(0)}get camera(){return this._camera}set camera(t){this._camera=t,this.updateCameraUp(),this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this._domElement&&(t?(this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none"):(this.cancel(),this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect=""))}get active(){return!this._hasRested}get currentAction(){return this._state}get distance(){return this._spherical.radius}set distance(t){this._spherical.radius===t&&this._sphericalEnd.radius===t||(this._spherical.radius=t,this._sphericalEnd.radius=t,this._needsUpdate=!0)}get azimuthAngle(){return this._spherical.theta}set azimuthAngle(t){this._spherical.theta===t&&this._sphericalEnd.theta===t||(this._spherical.theta=t,this._sphericalEnd.theta=t,this._needsUpdate=!0)}get polarAngle(){return this._spherical.phi}set polarAngle(t){this._spherical.phi===t&&this._sphericalEnd.phi===t||(this._spherical.phi=t,this._sphericalEnd.phi=t,this._needsUpdate=!0)}get boundaryEnclosesCamera(){return this._boundaryEnclosesCamera}set boundaryEnclosesCamera(t){this._boundaryEnclosesCamera=t,this._needsUpdate=!0}set interactiveArea(t){this._interactiveArea.width=H(t.width,0,1),this._interactiveArea.height=H(t.height,0,1),this._interactiveArea.x=H(t.x,0,1-this._interactiveArea.width),this._interactiveArea.y=H(t.y,0,1-this._interactiveArea.height)}addEventListener(t,e){super.addEventListener(t,e)}removeEventListener(t,e){super.removeEventListener(t,e)}rotate(t,e,s=!1){return this.rotateTo(this._sphericalEnd.theta+t,this._sphericalEnd.phi+e,s)}rotateAzimuthTo(t,e=!1){return this.rotateTo(t,this._sphericalEnd.phi,e)}rotatePolarTo(t,e=!1){return this.rotateTo(this._sphericalEnd.theta,t,e)}rotateTo(t,e,s=!1){this._isUserControllingRotate=!1;const r=H(t,this.minAzimuthAngle,this.maxAzimuthAngle),n=H(e,this.minPolarAngle,this.maxPolarAngle);this._sphericalEnd.theta=r,this._sphericalEnd.phi=n,this._sphericalEnd.makeSafe(),this._needsUpdate=!0,s||(this._spherical.theta=this._sphericalEnd.theta,this._spherical.phi=this._sphericalEnd.phi);const a=!s||L(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&L(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold);return this._createOnRestPromise(a)}dolly(t,e=!1){return this.dollyTo(this._sphericalEnd.radius-t,e)}dollyTo(t,e=!1){return this._isUserControllingDolly=!1,this._lastDollyDirection=X.NONE,this._changedDolly=0,this._dollyToNoClamp(H(t,this.minDistance,this.maxDistance),e)}_dollyToNoClamp(t,e=!1){const s=this._sphericalEnd.radius;if(this.colliderMeshes.length>=1){const a=this._collisionTest(),h=L(a,this._spherical.radius);if(!(s>t)&&h)return Promise.resolve();this._sphericalEnd.radius=Math.min(t,a)}else this._sphericalEnd.radius=t;this._needsUpdate=!0,e||(this._spherical.radius=this._sphericalEnd.radius);const n=!e||L(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(n)}dollyInFixed(t,e=!1){this._targetEnd.add(this._getCameraDirection(J).multiplyScalar(t)),e||this._target.copy(this._targetEnd);const s=!e||L(this._target.x,this._targetEnd.x,this.restThreshold)&&L(this._target.y,this._targetEnd.y,this.restThreshold)&&L(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(s)}zoom(t,e=!1){return this.zoomTo(this._zoomEnd+t,e)}zoomTo(t,e=!1){this._isUserControllingZoom=!1,this._zoomEnd=H(t,this.minZoom,this.maxZoom),this._needsUpdate=!0,e||(this._zoom=this._zoomEnd);const s=!e||L(this._zoom,this._zoomEnd,this.restThreshold);return this._changedZoom=0,this._createOnRestPromise(s)}pan(t,e,s=!1){return console.warn("`pan` has been renamed to `truck`"),this.truck(t,e,s)}truck(t,e,s=!1){this._camera.updateMatrix(),k.setFromMatrixColumn(this._camera.matrix,0),Y.setFromMatrixColumn(this._camera.matrix,1),k.multiplyScalar(t),Y.multiplyScalar(-e);const r=E.copy(k).add(Y),n=v.copy(this._targetEnd).add(r);return this.moveTo(n.x,n.y,n.z,s)}forward(t,e=!1){E.setFromMatrixColumn(this._camera.matrix,0),E.crossVectors(this._camera.up,E),E.multiplyScalar(t);const s=v.copy(this._targetEnd).add(E);return this.moveTo(s.x,s.y,s.z,e)}elevate(t,e=!1){return E.copy(this._camera.up).multiplyScalar(t),this.moveTo(this._targetEnd.x+E.x,this._targetEnd.y+E.y,this._targetEnd.z+E.z,e)}moveTo(t,e,s,r=!1){this._isUserControllingTruck=!1;const n=E.set(t,e,s).sub(this._targetEnd);this._encloseToBoundary(this._targetEnd,n,this.boundaryFriction),this._needsUpdate=!0,r||this._target.copy(this._targetEnd);const a=!r||L(this._target.x,this._targetEnd.x,this.restThreshold)&&L(this._target.y,this._targetEnd.y,this.restThreshold)&&L(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(a)}lookInDirectionOf(t,e,s,r=!1){const h=E.set(t,e,s).sub(this._targetEnd).normalize().multiplyScalar(-this._sphericalEnd.radius);return this.setPosition(h.x,h.y,h.z,r)}fitToBox(t,e,{cover:s=!1,paddingLeft:r=0,paddingRight:n=0,paddingBottom:a=0,paddingTop:h=0}={}){const m=[],p=t.isBox3?G.copy(t):G.setFromObject(t);p.isEmpty()&&(console.warn("camera-controls: fitTo() cannot be used with an empty box. Aborting"),Promise.resolve());const O=yt(this._sphericalEnd.theta,Et),f=yt(this._sphericalEnd.phi,Et);m.push(this.rotateTo(O,f,e));const D=E.setFromSpherical(this._sphericalEnd).normalize(),g=Dt.setFromUnitVectors(D,dt),w=L(Math.abs(D.y),1);w&&g.multiply(pt.setFromAxisAngle(nt,O)),g.multiply(this._yAxisUpSpaceInverse);const C=Ut.makeEmpty();v.copy(p.min).applyQuaternion(g),C.expandByPoint(v),v.copy(p.min).setX(p.max.x).applyQuaternion(g),C.expandByPoint(v),v.copy(p.min).setY(p.max.y).applyQuaternion(g),C.expandByPoint(v),v.copy(p.max).setZ(p.min.z).applyQuaternion(g),C.expandByPoint(v),v.copy(p.min).setZ(p.max.z).applyQuaternion(g),C.expandByPoint(v),v.copy(p.max).setY(p.min.y).applyQuaternion(g),C.expandByPoint(v),v.copy(p.max).setX(p.min.x).applyQuaternion(g),C.expandByPoint(v),v.copy(p.max).applyQuaternion(g),C.expandByPoint(v),C.min.x-=r,C.min.y-=a,C.max.x+=n,C.max.y+=h,g.setFromUnitVectors(dt,D),w&&g.premultiply(pt.invert()),g.premultiply(this._yAxisUpSpace);const S=C.getSize(E),P=C.getCenter(v).applyQuaternion(g);if(B(this._camera)){const A=this.getDistanceToFitBox(S.x,S.y,S.z,s);m.push(this.moveTo(P.x,P.y,P.z,e)),m.push(this.dollyTo(A,e)),m.push(this.setFocalOffset(0,0,0,e))}else if(V(this._camera)){const A=this._camera,z=A.right-A.left,o=A.top-A.bottom,c=s?Math.max(z/S.x,o/S.y):Math.min(z/S.x,o/S.y);m.push(this.moveTo(P.x,P.y,P.z,e)),m.push(this.zoomTo(c,e)),m.push(this.setFocalOffset(0,0,0,e))}return Promise.all(m)}fitToSphere(t,e){const s=[],n=t instanceof _.Sphere?mt.copy(t):et.createBoundingSphere(t,mt);if(s.push(this.moveTo(n.center.x,n.center.y,n.center.z,e)),B(this._camera)){const a=this.getDistanceToFitSphere(n.radius);s.push(this.dollyTo(a,e))}else if(V(this._camera)){const a=this._camera.right-this._camera.left,h=this._camera.top-this._camera.bottom,m=2*n.radius,p=Math.min(a/m,h/m);s.push(this.zoomTo(p,e))}return s.push(this.setFocalOffset(0,0,0,e)),Promise.all(s)}setLookAt(t,e,s,r,n,a,h=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=X.NONE,this._changedDolly=0;const m=v.set(r,n,a),p=E.set(t,e,s);this._targetEnd.copy(m),this._sphericalEnd.setFromVector3(p.sub(m).applyQuaternion(this._yAxisUpSpace)),this.normalizeRotations(),this._needsUpdate=!0,h||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const O=!h||L(this._target.x,this._targetEnd.x,this.restThreshold)&&L(this._target.y,this._targetEnd.y,this.restThreshold)&&L(this._target.z,this._targetEnd.z,this.restThreshold)&&L(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&L(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&L(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(O)}lerpLookAt(t,e,s,r,n,a,h,m,p,O,f,D,g,w=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=X.NONE,this._changedDolly=0;const C=E.set(r,n,a),S=v.set(t,e,s);b.setFromVector3(S.sub(C).applyQuaternion(this._yAxisUpSpace));const P=Q.set(O,f,D),A=v.set(h,m,p);$.setFromVector3(A.sub(P).applyQuaternion(this._yAxisUpSpace)),this._targetEnd.copy(C.lerp(P,g));const z=$.theta-b.theta,o=$.phi-b.phi,c=$.radius-b.radius;this._sphericalEnd.set(b.radius+c*g,b.phi+o*g,b.theta+z*g),this.normalizeRotations(),this._needsUpdate=!0,w||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const y=!w||L(this._target.x,this._targetEnd.x,this.restThreshold)&&L(this._target.y,this._targetEnd.y,this.restThreshold)&&L(this._target.z,this._targetEnd.z,this.restThreshold)&&L(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&L(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&L(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(y)}setPosition(t,e,s,r=!1){return this.setLookAt(t,e,s,this._targetEnd.x,this._targetEnd.y,this._targetEnd.z,r)}setTarget(t,e,s,r=!1){const n=this.getPosition(E),a=this.setLookAt(n.x,n.y,n.z,t,e,s,r);return this._sphericalEnd.phi=H(this._sphericalEnd.phi,this.minPolarAngle,this.maxPolarAngle),a}setFocalOffset(t,e,s,r=!1){this._isUserControllingOffset=!1,this._focalOffsetEnd.set(t,e,s),this._needsUpdate=!0,r||this._focalOffset.copy(this._focalOffsetEnd);const n=!r||L(this._focalOffset.x,this._focalOffsetEnd.x,this.restThreshold)&&L(this._focalOffset.y,this._focalOffsetEnd.y,this.restThreshold)&&L(this._focalOffset.z,this._focalOffsetEnd.z,this.restThreshold);return this._createOnRestPromise(n)}setOrbitPoint(t,e,s){this._camera.updateMatrixWorld(),k.setFromMatrixColumn(this._camera.matrixWorldInverse,0),Y.setFromMatrixColumn(this._camera.matrixWorldInverse,1),Z.setFromMatrixColumn(this._camera.matrixWorldInverse,2);const r=E.set(t,e,s),n=r.distanceTo(this._camera.position),a=r.sub(this._camera.position);k.multiplyScalar(a.x),Y.multiplyScalar(a.y),Z.multiplyScalar(a.z),E.copy(k).add(Y).add(Z),E.z=E.z+n,this.dollyTo(n,!1),this.setFocalOffset(-E.x,E.y,-E.z,!1),this.moveTo(t,e,s,!1)}setBoundary(t){if(!t){this._boundary.min.set(-1/0,-1/0,-1/0),this._boundary.max.set(1/0,1/0,1/0),this._needsUpdate=!0;return}this._boundary.copy(t),this._boundary.clampPoint(this._targetEnd,this._targetEnd),this._needsUpdate=!0}setViewport(t,e,s,r){if(t===null){this._viewport=null;return}this._viewport=this._viewport||new _.Vector4,typeof t=="number"?this._viewport.set(t,e,s,r):this._viewport.copy(t)}getDistanceToFitBox(t,e,s,r=!1){if(_t(this._camera,"getDistanceToFitBox"))return this._spherical.radius;const n=t/e,a=this._camera.getEffectiveFOV()*W,h=this._camera.aspect;return((r?n>h:n<h)?e:t/h)*.5/Math.tan(a*.5)+s*.5}getDistanceToFitSphere(t){if(_t(this._camera,"getDistanceToFitSphere"))return this._spherical.radius;const e=this._camera.getEffectiveFOV()*W,s=Math.atan(Math.tan(e*.5)*this._camera.aspect)*2,r=1<this._camera.aspect?e:s;return t/Math.sin(r*.5)}getTarget(t,e=!0){return(t&&t.isVector3?t:new _.Vector3).copy(e?this._targetEnd:this._target)}getPosition(t,e=!0){return(t&&t.isVector3?t:new _.Vector3).setFromSpherical(e?this._sphericalEnd:this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(e?this._targetEnd:this._target)}getSpherical(t,e=!0){return(t&&t instanceof _.Spherical?t:new _.Spherical).copy(e?this._sphericalEnd:this._spherical)}getFocalOffset(t,e=!0){return(t&&t.isVector3?t:new _.Vector3).copy(e?this._focalOffsetEnd:this._focalOffset)}normalizeRotations(){this._sphericalEnd.theta=this._sphericalEnd.theta%K,this._sphericalEnd.theta<0&&(this._sphericalEnd.theta+=K),this._spherical.theta+=K*Math.round((this._sphericalEnd.theta-this._spherical.theta)/K)}reset(t=!1){if(!L(this._camera.up.x,this._cameraUp0.x)||!L(this._camera.up.y,this._cameraUp0.y)||!L(this._camera.up.z,this._cameraUp0.z)){this._camera.up.copy(this._cameraUp0);const s=this.getPosition(E);this.updateCameraUp(),this.setPosition(s.x,s.y,s.z)}const e=[this.setLookAt(this._position0.x,this._position0.y,this._position0.z,this._target0.x,this._target0.y,this._target0.z,t),this.setFocalOffset(this._focalOffset0.x,this._focalOffset0.y,this._focalOffset0.z,t),this.zoomTo(this._zoom0,t)];return Promise.all(e)}saveState(){this._cameraUp0.copy(this._camera.up),this.getTarget(this._target0),this.getPosition(this._position0),this._zoom0=this._zoom,this._focalOffset0.copy(this._focalOffset)}updateCameraUp(){this._yAxisUpSpace.setFromUnitVectors(this._camera.up,nt),this._yAxisUpSpaceInverse.copy(this._yAxisUpSpace).invert()}applyCameraUp(){const t=E.subVectors(this._target,this._camera.position).normalize(),e=v.crossVectors(t,this._camera.up);this._camera.up.crossVectors(e,t).normalize(),this._camera.updateMatrixWorld();const s=this.getPosition(E);this.updateCameraUp(),this.setPosition(s.x,s.y,s.z)}update(t){const e=this._sphericalEnd.theta-this._spherical.theta,s=this._sphericalEnd.phi-this._spherical.phi,r=this._sphericalEnd.radius-this._spherical.radius,n=Ct.subVectors(this._targetEnd,this._target),a=vt.subVectors(this._focalOffsetEnd,this._focalOffset),h=this._zoomEnd-this._zoom;if(x(e))this._thetaVelocity.value=0,this._spherical.theta=this._sphericalEnd.theta;else{const f=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.theta=ot(this._spherical.theta,this._sphericalEnd.theta,this._thetaVelocity,f,1/0,t),this._needsUpdate=!0}if(x(s))this._phiVelocity.value=0,this._spherical.phi=this._sphericalEnd.phi;else{const f=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.phi=ot(this._spherical.phi,this._sphericalEnd.phi,this._phiVelocity,f,1/0,t),this._needsUpdate=!0}if(x(r))this._radiusVelocity.value=0,this._spherical.radius=this._sphericalEnd.radius;else{const f=this._isUserControllingDolly?this.draggingSmoothTime:this.smoothTime;this._spherical.radius=ot(this._spherical.radius,this._sphericalEnd.radius,this._radiusVelocity,f,this.maxSpeed,t),this._needsUpdate=!0}if(x(n.x)&&x(n.y)&&x(n.z))this._targetVelocity.set(0,0,0),this._target.copy(this._targetEnd);else{const f=this._isUserControllingTruck?this.draggingSmoothTime:this.smoothTime;Tt(this._target,this._targetEnd,this._targetVelocity,f,this.maxSpeed,t,this._target),this._needsUpdate=!0}if(x(a.x)&&x(a.y)&&x(a.z))this._focalOffsetVelocity.set(0,0,0),this._focalOffset.copy(this._focalOffsetEnd);else{const f=this._isUserControllingOffset?this.draggingSmoothTime:this.smoothTime;Tt(this._focalOffset,this._focalOffsetEnd,this._focalOffsetVelocity,f,this.maxSpeed,t,this._focalOffset),this._needsUpdate=!0}if(x(h))this._zoomVelocity.value=0,this._zoom=this._zoomEnd;else{const f=this._isUserControllingZoom?this.draggingSmoothTime:this.smoothTime;this._zoom=ot(this._zoom,this._zoomEnd,this._zoomVelocity,f,1/0,t)}if(this.dollyToCursor){if(B(this._camera)&&this._changedDolly!==0){const f=this._spherical.radius-this._lastDistance,D=this._camera,g=this._getCameraDirection(J),w=E.copy(g).cross(D.up).normalize();w.lengthSq()===0&&(w.x=1);const C=v.crossVectors(w,g),S=this._sphericalEnd.radius*Math.tan(D.getEffectiveFOV()*W*.5),A=(this._sphericalEnd.radius-f-this._sphericalEnd.radius)/this._sphericalEnd.radius,z=Q.copy(this._targetEnd).add(w.multiplyScalar(this._dollyControlCoord.x*S*D.aspect)).add(C.multiplyScalar(this._dollyControlCoord.y*S)),o=E.copy(this._targetEnd).lerp(z,A),c=this._lastDollyDirection===X.IN&&this._spherical.radius<=this.minDistance,y=this._lastDollyDirection===X.OUT&&this.maxDistance<=this._spherical.radius;if(this.infinityDolly&&(c||y)){this._sphericalEnd.radius-=f,this._spherical.radius-=f;const U=v.copy(g).multiplyScalar(-f);o.add(U)}this._boundary.clampPoint(o,o);const u=v.subVectors(o,this._targetEnd);this._targetEnd.copy(o),this._target.add(u),this._changedDolly-=f,x(this._changedDolly)&&(this._changedDolly=0)}else if(V(this._camera)&&this._changedZoom!==0){const f=this._zoom-this._lastZoom,D=this._camera,g=E.set(this._dollyControlCoord.x,this._dollyControlCoord.y,(D.near+D.far)/(D.near-D.far)).unproject(D),w=v.set(0,0,-1).applyQuaternion(D.quaternion),C=Q.copy(g).add(w.multiplyScalar(-g.dot(D.up))),P=-(this._zoom-f-this._zoom)/this._zoom,A=this._getCameraDirection(J),z=this._targetEnd.dot(A),o=E.copy(this._targetEnd).lerp(C,P),c=o.dot(A),y=A.multiplyScalar(c-z);o.sub(y),this._boundary.clampPoint(o,o);const u=v.subVectors(o,this._targetEnd);this._targetEnd.copy(o),this._target.add(u),this._changedZoom-=f,x(this._changedZoom)&&(this._changedZoom=0)}}this._camera.zoom!==this._zoom&&(this._camera.zoom=this._zoom,this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0),this._dragNeedsUpdate=!0;const m=this._collisionTest();this._spherical.radius=Math.min(this._spherical.radius,m),this._spherical.makeSafe(),this._camera.position.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(this._target),this._camera.lookAt(this._target),(!x(this._focalOffset.x)||!x(this._focalOffset.y)||!x(this._focalOffset.z))&&(this._camera.updateMatrixWorld(),k.setFromMatrixColumn(this._camera.matrix,0),Y.setFromMatrixColumn(this._camera.matrix,1),Z.setFromMatrixColumn(this._camera.matrix,2),k.multiplyScalar(this._focalOffset.x),Y.multiplyScalar(-this._focalOffset.y),Z.multiplyScalar(this._focalOffset.z),E.copy(k).add(Y).add(Z),this._camera.position.add(E)),this._boundaryEnclosesCamera&&this._encloseToBoundary(this._camera.position.copy(this._target),E.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse),1);const O=this._needsUpdate;return O&&!this._updatedLastTime?(this._hasRested=!1,this.dispatchEvent({type:"wake"}),this.dispatchEvent({type:"update"})):O?(this.dispatchEvent({type:"update"}),x(e,this.restThreshold)&&x(s,this.restThreshold)&&x(r,this.restThreshold)&&x(n.x,this.restThreshold)&&x(n.y,this.restThreshold)&&x(n.z,this.restThreshold)&&x(a.x,this.restThreshold)&&x(a.y,this.restThreshold)&&x(a.z,this.restThreshold)&&x(h,this.restThreshold)&&!this._hasRested&&(this._hasRested=!0,this.dispatchEvent({type:"rest"}))):!O&&this._updatedLastTime&&this.dispatchEvent({type:"sleep"}),this._lastDistance=this._spherical.radius,this._lastZoom=this._zoom,this._updatedLastTime=O,this._needsUpdate=!1,O}toJSON(){return JSON.stringify({enabled:this._enabled,minDistance:this.minDistance,maxDistance:q(this.maxDistance),minZoom:this.minZoom,maxZoom:q(this.maxZoom),minPolarAngle:this.minPolarAngle,maxPolarAngle:q(this.maxPolarAngle),minAzimuthAngle:q(this.minAzimuthAngle),maxAzimuthAngle:q(this.maxAzimuthAngle),smoothTime:this.smoothTime,draggingSmoothTime:this.draggingSmoothTime,dollySpeed:this.dollySpeed,truckSpeed:this.truckSpeed,dollyToCursor:this.dollyToCursor,verticalDragToForward:this.verticalDragToForward,target:this._targetEnd.toArray(),position:E.setFromSpherical(this._sphericalEnd).add(this._targetEnd).toArray(),zoom:this._zoomEnd,focalOffset:this._focalOffsetEnd.toArray(),target0:this._target0.toArray(),position0:this._position0.toArray(),zoom0:this._zoom0,focalOffset0:this._focalOffset0.toArray()})}fromJSON(t,e=!1){const s=JSON.parse(t);this.enabled=s.enabled,this.minDistance=s.minDistance,this.maxDistance=j(s.maxDistance),this.minZoom=s.minZoom,this.maxZoom=j(s.maxZoom),this.minPolarAngle=s.minPolarAngle,this.maxPolarAngle=j(s.maxPolarAngle),this.minAzimuthAngle=j(s.minAzimuthAngle),this.maxAzimuthAngle=j(s.maxAzimuthAngle),this.smoothTime=s.smoothTime,this.draggingSmoothTime=s.draggingSmoothTime,this.dollySpeed=s.dollySpeed,this.truckSpeed=s.truckSpeed,this.dollyToCursor=s.dollyToCursor,this.verticalDragToForward=s.verticalDragToForward,this._target0.fromArray(s.target0),this._position0.fromArray(s.position0),this._zoom0=s.zoom0,this._focalOffset0.fromArray(s.focalOffset0),this.moveTo(s.target[0],s.target[1],s.target[2],e),b.setFromVector3(E.fromArray(s.position).sub(this._targetEnd).applyQuaternion(this._yAxisUpSpace)),this.rotateTo(b.theta,b.phi,e),this.dollyTo(b.radius,e),this.zoomTo(s.zoom,e),this.setFocalOffset(s.focalOffset[0],s.focalOffset[1],s.focalOffset[2],e),this._needsUpdate=!0}connect(t){if(this._domElement){console.warn("camera-controls is already connected.");return}t.setAttribute("data-camera-controls-version",$t),this._addAllEventListeners(t),this._getClientRect(this._elementRect)}disconnect(){this.cancel(),this._removeAllEventListeners(),this._domElement&&(this._domElement.removeAttribute("data-camera-controls-version"),this._domElement=void 0)}dispose(){this.removeAllEventListeners(),this.disconnect()}_getTargetDirection(t){return t.setFromSpherical(this._spherical).divideScalar(this._spherical.radius).applyQuaternion(this._yAxisUpSpaceInverse)}_getCameraDirection(t){return this._getTargetDirection(t).negate()}_findPointerById(t){return this._activePointers.find(e=>e.pointerId===t)}_findPointerByMouseButton(t){return this._activePointers.find(e=>e.mouseButton===t)}_disposePointer(t){this._activePointers.splice(this._activePointers.indexOf(t),1)}_encloseToBoundary(t,e,s){const r=e.lengthSq();if(r===0)return t;const n=v.copy(e).add(t),h=this._boundary.clampPoint(n,Q).sub(n),m=h.lengthSq();if(m===0)return t.add(e);if(m===r)return t;if(s===0)return t.add(e).add(h);{const p=1+s*m/e.dot(h);return t.add(v.copy(e).multiplyScalar(p)).add(h.multiplyScalar(1-s))}}_updateNearPlaneCorners(){if(B(this._camera)){const t=this._camera,e=t.near,s=t.getEffectiveFOV()*W,r=Math.tan(s*.5)*e,n=r*t.aspect;this._nearPlaneCorners[0].set(-n,-r,0),this._nearPlaneCorners[1].set(n,-r,0),this._nearPlaneCorners[2].set(n,r,0),this._nearPlaneCorners[3].set(-n,r,0)}else if(V(this._camera)){const t=this._camera,e=1/t.zoom,s=t.left*e,r=t.right*e,n=t.top*e,a=t.bottom*e;this._nearPlaneCorners[0].set(s,n,0),this._nearPlaneCorners[1].set(r,n,0),this._nearPlaneCorners[2].set(r,a,0),this._nearPlaneCorners[3].set(s,a,0)}}_collisionTest(){let t=1/0;if(!(this.colliderMeshes.length>=1)||_t(this._camera,"_collisionTest"))return t;const s=this._getTargetDirection(J);ut.lookAt(Ot,s,this._camera.up);for(let r=0;r<4;r++){const n=v.copy(this._nearPlaneCorners[r]);n.applyMatrix4(ut);const a=Q.addVectors(this._target,n);at.set(a,s),at.far=this._spherical.radius+1;const h=at.intersectObjects(this.colliderMeshes);h.length!==0&&h[0].distance<t&&(t=h[0].distance)}return t}_getClientRect(t){if(!this._domElement)return;const e=this._domElement.getBoundingClientRect();return t.x=e.left,t.y=e.top,this._viewport?(t.x+=this._viewport.x,t.y+=e.height-this._viewport.w-this._viewport.y,t.width=this._viewport.z,t.height=this._viewport.w):(t.width=e.width,t.height=e.height),t}_createOnRestPromise(t){return t?Promise.resolve():(this._hasRested=!1,this.dispatchEvent({type:"transitionstart"}),new Promise(e=>{const s=()=>{this.removeEventListener("rest",s),e()};this.addEventListener("rest",s)}))}_addAllEventListeners(t){}_removeAllEventListeners(){}get dampingFactor(){return console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead."),0}set dampingFactor(t){console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead.")}get draggingDampingFactor(){return console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead."),0}set draggingDampingFactor(t){console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead.")}static createBoundingSphere(t,e=new _.Sphere){const s=e,r=s.center;G.makeEmpty(),t.traverseVisible(a=>{a.isMesh&&G.expandByObject(a)}),G.getCenter(r);let n=0;return t.traverseVisible(a=>{if(!a.isMesh)return;const h=a,m=h.geometry.clone();m.applyMatrix4(h.matrixWorld);const O=m.attributes.position;for(let f=0,D=O.count;f<D;f++)E.fromBufferAttribute(O,f),n=Math.max(n,r.distanceToSquared(E))}),s.radius=Math.sqrt(n),s}}class At extends qt{constructor(e){super(e);R(this,"onBeforeUpdate",new N);R(this,"onAfterUpdate",new N);R(this,"onAspectUpdated",new N);R(this,"onDisposed",new N);R(this,"three");R(this,"_allControls",new Map);R(this,"updateAspect",()=>{var e;if(!(!this.currentWorld||!this.currentWorld.renderer)&&!(this.three instanceof It)&&(e=this.currentWorld.renderer)!=null&&e.isResizeable()){const s=this.currentWorld.renderer.getSize();this.three.aspect=s.width/s.height,this.three.updateProjectionMatrix(),this.onAspectUpdated.trigger()}});this.three=this.setupCamera(),this.setupEvents(!0),this.onWorldChanged.add(({action:s,world:r})=>{if(s==="added"){const n=this.newCameraControls();this._allControls.set(r.uuid,n)}if(s==="removed"){const n=this._allControls.get(r.uuid);n&&(n.dispose(),this._allControls.delete(r.uuid))}})}get controls(){if(!this.currentWorld)throw new Error("This camera needs a world to work!");const e=this._allControls.get(this.currentWorld.uuid);if(!e)throw new Error("Controls not found!");return e}get enabled(){return this.currentWorld===null?!1:this.controls.enabled}set enabled(e){this.controls.enabled=e}dispose(){this.setupEvents(!1),this.enabled=!1,this.onAspectUpdated.reset(),this.onBeforeUpdate.reset(),this.onAfterUpdate.reset(),this.three.removeFromParent(),this.onDisposed.trigger(),this.onDisposed.reset();for(const[e,s]of this._allControls)s.dispose()}update(e){this.enabled&&(this.onBeforeUpdate.trigger(this),this.controls.update(e),this.onAfterUpdate.trigger(this))}setupCamera(){const e=window.innerWidth/window.innerHeight,s=new bt(60,e,1,1e3);return s.position.set(50,50,50),s.lookAt(new ft(0,0,0)),s}newCameraControls(){if(!this.currentWorld)throw new Error("This camera needs a world to work!");if(!this.currentWorld.renderer)throw new Error("This camera needs a renderer to work!");et.install({THREE:At.getSubsetOfThree()});const{domElement:e}=this.currentWorld.renderer.three,s=new et(this.three,e);return s.smoothTime=.2,s.dollyToCursor=!0,s.infinityDolly=!0,s}setupEvents(e){e?window.addEventListener("resize",this.updateAspect):window.removeEventListener("resize",this.updateAspect)}static getSubsetOfThree(){return{MOUSE:Ht,Vector2:kt,Vector3:ft,Vector4:Yt,Quaternion:Vt,Matrix4:Bt,Spherical:Zt,Box3:Nt,Sphere:Xt,Raycaster:Kt,MathUtils:Qt}}}export{Lt as B,gt as D,re as S,At as a};
