var m=Object.defineProperty;var O=(d,l,e)=>l in d?m(d,l,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[l]=e;var c=(d,l,e)=>(O(d,typeof l!="symbol"?l+"":l,e),e);import{ai as p,aj as I,i as x,ak as M,bc as D}from"./web-ifc-api-CgBULNZm.js";import{C as A,E as w,d as v,b as N,I as F,U as L,a as B}from"./index-PN7JV3bA.js";import"./_commonjsHelpers-Cpj98o6Y.js";const f=class f extends A{constructor(e){super(e);c(this,"onDisposed",new w);c(this,"onRequestFile",new w);c(this,"ifcToExport",null);c(this,"onElementToPset",new w);c(this,"onPropToPset",new w);c(this,"onPsetRemoved",new w);c(this,"onDataChanged",new w);c(this,"wasm",{path:"/",absolute:!1});c(this,"enabled",!0);c(this,"attributeListeners",{});c(this,"selectedModel");c(this,"changeMap",{});this.components.add(f.uuid,this)}dispose(){this.selectedModel=void 0,this.attributeListeners={},this.changeMap={},this.onElementToPset.reset(),this.onPropToPset.reset(),this.onPsetRemoved.reset(),this.onDataChanged.reset(),this.onDisposed.trigger(f.uuid),this.onDisposed.reset()}static getIFCSchema(e){const t=e.ifcMetadata.schema;if(!t)throw new Error("IFC Schema not found");return t.startsWith("IFC2X3")?"IFC2X3":t.startsWith("IFC4")&&t.replace("IFC4","")===""?"IFC4":t.startsWith("IFC4X3")?"IFC4X3":t}async setData(e,...t){for(const s of t){const{expressID:n}=s;(!n||n===-1)&&(s.expressID=this.getNewExpressID(e)),await e.setProperties(s.expressID,s),this.registerChange(e,n)}}async newPset(e,t,s){const n=f.getIFCSchema(e),{ownerHistoryHandle:r}=await this.getOwnerHistory(e),i=this.newGUID(e),o=new p[n].IfcLabel(t),a=s?new p[n].IfcText(s):null,u=new p[n].IfcPropertySet(i,r,o,a,[]);u.expressID=this.getNewExpressID(e);const P=this.newGUID(e),y=new p[n].IfcRelDefinesByProperties(P,r,null,null,[],new I(u.expressID));return y.expressID=this.getNewExpressID(e),await this.setData(e,u,y),{pset:u,rel:y}}async removePset(e,...t){for(const s of t){const n=await e.getProperties(s);if((n==null?void 0:n.type)!==x)continue;const r=await v.getPsetRel(e,s);if(r&&(await e.setProperties(r,null),this.registerChange(e,r)),n){for(const i of n.HasProperties)await e.setProperties(i.value,null);await e.setProperties(s,null),this.onPsetRemoved.trigger({model:e,psetID:s}),this.registerChange(e,s)}}}newSingleStringProperty(e,t,s,n){return this.newSingleProperty(e,t,s,n)}newSingleNumericProperty(e,t,s,n){return this.newSingleProperty(e,t,s,n)}newSingleBooleanProperty(e,t,s,n){return this.newSingleProperty(e,t,s,n)}async removePsetProp(e,t,s){const n=await e.getProperties(t),r=await e.getProperties(s);!n||!r||n.type===x&&r&&(n.HasProperties=n.HasProperties.filter(i=>i.value!==s),await e.setProperties(s,null),this.registerChange(e,t,s))}async addElementToPset(e,t,...s){const n=await v.getPsetRel(e,t);if(!n)return;const r=await e.getProperties(n);if(!r)return;for(const o of s){const a=new I(o);r.RelatedObjects.push(a),this.onElementToPset.trigger({model:e,psetID:t,elementID:o})}this.registerChange(e,t);const i=this.components.get(N);for(const o of s)try{i.addEntityRelations(e,o,"IsDefinedBy",t)}catch{}}async addPropToPset(e,t,...s){const n=await e.getProperties(t);if(n){for(const r of s){if(n.HasProperties.includes(r))continue;const i=new I(r);n.HasProperties.push(i),this.onPropToPset.trigger({model:e,psetID:t,propID:r})}this.registerChange(e,t)}}async saveToIfc(e,t){const s=this.components.get(F),n=s.webIfc,r=await s.readIfcFile(t),i=this.changeMap[e.uuid]??[];for(const a of i){const u=await e.getProperties(a);if(u)try{n.WriteLine(r,u)}catch{}else try{n.DeleteLine(r,a)}catch{}}const o=n.SaveModel(r);return s.webIfc.CloseModel(r),s.cleanUp(),o}async getEntityRef(e,t){const s=await e.getAllPropertiesOfType(t);if(!s)return null;const n=[];for(const r in s){const i=new I(Number(r));n.push(i)}return n}async setAttributeListener(e,t,s){this.attributeListeners[e.uuid]||(this.attributeListeners[e.uuid]={});const n=this.attributeListeners[e.uuid][t]?this.attributeListeners[e.uuid][t][s]:null;if(n)return n;const r=await e.getProperties(t);if(!r)throw new Error(`Entity with expressID ${t} doesn't exists.`);const i=r[s];if(Array.isArray(i)||!i)throw new Error(`Attribute ${s} is array or null, and it can't have a listener.`);const o=i.value;if(o===void 0||o==null)throw new Error(`Attribute ${s} has a badly defined handle.`);const a=new w;return Object.defineProperty(r[s],"value",{get(){return this._value},async set(u){this._value=u,a.trigger(u)}}),r[s].value=o,this.attributeListeners[e.uuid][t]||(this.attributeListeners[e.uuid][t]={}),this.attributeListeners[e.uuid][t][s]=a,a}getNewExpressID(e){return e.ifcMetadata.maxExpressID++,e.ifcMetadata.maxExpressID}newGUID(e){const t=f.getIFCSchema(e);return new p[t].IfcGloballyUniqueId(L.create())}async getOwnerHistory(e){const t=await e.getAllPropertiesOfType(M);if(!t)throw new Error("No OwnerHistory was found.");const s=Object.keys(t).map(i=>parseInt(i,10)),n=t[s[0]],r=new I(n.expressID);return{ownerHistory:n,ownerHistoryHandle:r}}registerChange(e,...t){this.changeMap[e.uuid]||(this.changeMap[e.uuid]=new Set);for(const s of t)this.changeMap[e.uuid].add(s),this.onDataChanged.trigger({model:e,expressID:s})}async newSingleProperty(e,t,s,n){const r=f.getIFCSchema(e),i=new p[r].IfcIdentifier(s),o=new p[r][t](n),a=new p[r].IfcPropertySingleValue(i,null,o,null);return a.expressID=this.getNewExpressID(e),await this.setData(e,a),a}};c(f,"uuid","58c2d9f0-183c-48d6-a402-dfcf5b9a34df");let b=f;const T=new B,R=T.get(F);await R.setup();const G=await fetch("https://thatopen.github.io/engine_components/resources/small.ifc"),S=await G.arrayBuffer(),h=await R.load(new Uint8Array(S)),g=T.get(b),{pset:H}=await g.newPset(h,"CalculatedQuantities"),W=await g.newSingleNumericProperty(h,"IfcReal","Volume",12.25);await g.addPropToPset(h,H.expressID,W.expressID);await g.addElementToPset(h,H.expressID,186);const C=await h.getProperties(186);C&&(C.Name.value="New Wall Name",await g.setData(h,C));const j=new D.IfcTask(new D.IfcGloballyUniqueId(L.create()),null,null,null,null,null,null,null,null,new D.IfcBoolean(!1),null,null,null);await g.setData(h,j);const k=await g.saveToIfc(h,new Uint8Array(S)),U=new File([k],"small-modified.ifc"),E=document.createElement("a");E.href=URL.createObjectURL(U);E.download=U.name;URL.revokeObjectURL(E.href);
