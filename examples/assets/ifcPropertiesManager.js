var T=Object.defineProperty;var M=(d,h,e)=>h in d?T(d,h,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[h]=e;var c=(d,h,e)=>(M(d,typeof h!="symbol"?h+"":h,e),e);import{ah as p,ai as P,i as x,aj as U}from"./web-ifc-api-BXZoUgQp.js";import{C as m,E as w,d as v,b as O,I as E,U as A,a as j}from"./index-CvFR6O4A.js";import"./_commonjsHelpers-Cpj98o6Y.js";const f=class f extends m{constructor(e){super(e);c(this,"onDisposed",new w);c(this,"onRequestFile",new w);c(this,"ifcToExport",null);c(this,"onElementToPset",new w);c(this,"onPropToPset",new w);c(this,"onPsetRemoved",new w);c(this,"onDataChanged",new w);c(this,"wasm",{path:"/",absolute:!1});c(this,"enabled",!0);c(this,"attributeListeners",{});c(this,"selectedModel");c(this,"changeMap",{});this.components.add(f.uuid,this)}dispose(){this.selectedModel=void 0,this.attributeListeners={},this.changeMap={},this.onElementToPset.reset(),this.onPropToPset.reset(),this.onPsetRemoved.reset(),this.onDataChanged.reset(),this.onDisposed.trigger(f.uuid),this.onDisposed.reset()}static getIFCSchema(e){const t=e.ifcMetadata.schema;if(!t)throw new Error("IFC Schema not found");return t.startsWith("IFC2X3")?"IFC2X3":t.startsWith("IFC4")&&t.replace("IFC4","")===""?"IFC4":t.startsWith("IFC4X3")?"IFC4X3":t}async setData(e,...t){for(const s of t){const n=s.expressID;n&&(await e.setProperties(n,s),this.registerChange(e,n))}}async newPset(e,t,s){const n=f.getIFCSchema(e),{ownerHistoryHandle:r}=await this.getOwnerHistory(e),i=this.newGUID(e),a=new p[n].IfcLabel(t),o=s?new p[n].IfcText(s):null,u=new p[n].IfcPropertySet(i,r,a,o,[]);u.expressID=this.increaseMaxID(e);const I=this.newGUID(e),y=new p[n].IfcRelDefinesByProperties(I,r,null,null,[],new P(u.expressID));return y.expressID=this.increaseMaxID(e),await this.setData(e,u,y),{pset:u,rel:y}}async removePset(e,...t){for(const s of t){const n=await e.getProperties(s);if((n==null?void 0:n.type)!==x)continue;const r=await v.getPsetRel(e,s);if(r&&(await e.setProperties(r,null),this.registerChange(e,r)),n){for(const i of n.HasProperties)await e.setProperties(i.value,null);await e.setProperties(s,null),this.onPsetRemoved.trigger({model:e,psetID:s}),this.registerChange(e,s)}}}newSingleStringProperty(e,t,s,n){return this.newSingleProperty(e,t,s,n)}newSingleNumericProperty(e,t,s,n){return this.newSingleProperty(e,t,s,n)}newSingleBooleanProperty(e,t,s,n){return this.newSingleProperty(e,t,s,n)}async removePsetProp(e,t,s){const n=await e.getProperties(t),r=await e.getProperties(s);!n||!r||n.type===x&&r&&(n.HasProperties=n.HasProperties.filter(i=>i.value!==s),await e.setProperties(s,null),this.registerChange(e,t,s))}async addElementToPset(e,t,...s){const n=await v.getPsetRel(e,t);if(!n)return;const r=await e.getProperties(n);if(!r)return;for(const a of s){const o=new P(a);r.RelatedObjects.push(o),this.onElementToPset.trigger({model:e,psetID:t,elementID:a})}this.registerChange(e,t);const i=this.components.get(O);for(const a of s)i.addEntityRelations(e,a,"IsDefinedBy",t)}async addPropToPset(e,t,...s){const n=await e.getProperties(t);if(n){for(const r of s){if(n.HasProperties.includes(r))continue;const i=new P(r);n.HasProperties.push(i),this.onPropToPset.trigger({model:e,psetID:t,propID:r})}this.registerChange(e,t)}}async saveToIfc(e,t){const s=this.components.get(E),n=s.webIfc,r=await s.readIfcFile(t),i=this.changeMap[e.uuid]??[];for(const o of i){const u=await e.getProperties(o);if(u)try{n.WriteLine(r,u)}catch{}else try{n.DeleteLine(r,o)}catch{}}const a=n.SaveModel(r);return s.webIfc.CloseModel(r),s.cleanUp(),a}async setAttributeListener(e,t,s){this.attributeListeners[e.uuid]||(this.attributeListeners[e.uuid]={});const n=this.attributeListeners[e.uuid][t]?this.attributeListeners[e.uuid][t][s]:null;if(n)return n;const r=await e.getProperties(t);if(!r)throw new Error(`Entity with expressID ${t} doesn't exists.`);const i=r[s];if(Array.isArray(i)||!i)throw new Error(`Attribute ${s} is array or null, and it can't have a listener.`);const a=i.value;if(a===void 0||a==null)throw new Error(`Attribute ${s} has a badly defined handle.`);const o=new w;return Object.defineProperty(r[s],"value",{get(){return this._value},async set(u){this._value=u,o.trigger(u)}}),r[s].value=a,this.attributeListeners[e.uuid][t]||(this.attributeListeners[e.uuid][t]={}),this.attributeListeners[e.uuid][t][s]=o,o}increaseMaxID(e){return e.ifcMetadata.maxExpressID++,e.ifcMetadata.maxExpressID}newGUID(e){const t=f.getIFCSchema(e);return new p[t].IfcGloballyUniqueId(A.create())}async getOwnerHistory(e){const t=await e.getAllPropertiesOfType(U);if(!t)throw new Error("No OwnerHistory was found.");const s=Object.keys(t).map(i=>parseInt(i,10)),n=t[s[0]],r=new P(n.expressID);return{ownerHistory:n,ownerHistoryHandle:r}}registerChange(e,...t){this.changeMap[e.uuid]||(this.changeMap[e.uuid]=new Set);for(const s of t)this.changeMap[e.uuid].add(s),this.onDataChanged.trigger({model:e,expressID:s})}async newSingleProperty(e,t,s,n){const r=f.getIFCSchema(e),i=new p[r].IfcIdentifier(s),a=new p[r][t](n),o=new p[r].IfcPropertySingleValue(i,null,a,null);return o.expressID=this.increaseMaxID(e),await this.setData(e,o),o}};c(f,"uuid","58c2d9f0-183c-48d6-a402-dfcf5b9a34df");let C=f;const L=new j,S=L.get(E);await S.setup();const G=await fetch("https://thatopen.github.io/engine_components/resources/small.ifc"),F=await G.arrayBuffer(),l=await S.load(new Uint8Array(F)),g=L.get(C),{pset:H}=await g.newPset(l,"CalculatedQuantities"),W=await g.newSingleNumericProperty(l,"IfcReal","Volume",12.25);await g.addPropToPset(l,H.expressID,W.expressID);await g.addElementToPset(l,H.expressID,186);const D=await l.getProperties(186);D&&(D.Name.value="New Wall Name",await g.setData(l,D));const B=await g.saveToIfc(l,new Uint8Array(F)),R=new File([B],"small-modified.ifc"),b=document.createElement("a");b.href=URL.createObjectURL(R);b.download=R.name;URL.revokeObjectURL(b.href);
