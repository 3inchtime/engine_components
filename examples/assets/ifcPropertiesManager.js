var R=Object.defineProperty;var M=(d,p,e)=>p in d?R(d,p,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[p]=e;var a=(d,p,e)=>(M(d,typeof p!="symbol"?p+"":p,e),e);import{ac as w,ad as U,ae as P,af as x}from"./web-ifc-api-BffFJDIm.js";import{C as F,E as f,U as O,a as A}from"./index-BSAL1QGz.js";import{a as v}from"./index-EnshWEFz.js";import{I as E}from"./index-CvFWk4AU.js";import"./index-DCGuIamj.js";const h=class h extends F{constructor(e){super(e);a(this,"onDisposed",new f);a(this,"onRequestFile",new f);a(this,"ifcToExport",null);a(this,"onElementToPset",new f);a(this,"onPropToPset",new f);a(this,"onPsetRemoved",new f);a(this,"onDataChanged",new f);a(this,"wasm",{path:"/",absolute:!1});a(this,"enabled",!0);a(this,"attributeListeners",{});a(this,"selectedModel");a(this,"changeMap",{});this.components.add(h.uuid,this)}dispose(){this.selectedModel=void 0,this.attributeListeners={},this.changeMap={},this.onElementToPset.reset(),this.onPropToPset.reset(),this.onPsetRemoved.reset(),this.onDataChanged.reset(),this.onDisposed.trigger(h.uuid),this.onDisposed.reset()}increaseMaxID(e){return e.ifcMetadata.maxExpressID++,e.ifcMetadata.maxExpressID}static getIFCSchema(e){const s=e.ifcMetadata.schema;if(!s)throw new Error("IFC Schema not found");return s}newGUID(e){const s=h.getIFCSchema(e);return new w[s].IfcGloballyUniqueId(O.create())}async getOwnerHistory(e){const s=await e.getAllPropertiesOfType(U);if(!s)throw new Error("No OwnerHistory was found.");const t=Object.keys(s).map(i=>parseInt(i,10)),r=s[t[0]],n=new P(r.expressID);return{ownerHistory:r,ownerHistoryHandle:n}}registerChange(e,...s){this.changeMap[e.uuid]||(this.changeMap[e.uuid]=new Set);for(const t of s)this.changeMap[e.uuid].add(t),this.onDataChanged.trigger({model:e,expressID:t})}async setData(e,...s){for(const t of s){const r=t.expressID;r&&(await e.setProperties(r,t),this.registerChange(e,r))}}async newPset(e,s,t){const r=h.getIFCSchema(e),{ownerHistoryHandle:n}=await this.getOwnerHistory(e),i=this.newGUID(e),c=new w[r].IfcLabel(s),o=t?new w[r].IfcText(t):null,u=new w[r].IfcPropertySet(i,n,c,o,[]);u.expressID=this.increaseMaxID(e);const y=this.newGUID(e),I=new w[r].IfcRelDefinesByProperties(y,n,null,null,[],new P(u.expressID));return I.expressID=this.increaseMaxID(e),await this.setData(e,u,I),{pset:u,rel:I}}async removePset(e,...s){for(const t of s){const r=await e.getProperties(t);if((r==null?void 0:r.type)!==x)continue;const n=await v.getPsetRel(e,t);if(n&&(await e.setProperties(n,null),this.registerChange(e,n)),r){for(const i of r.HasProperties)await e.setProperties(i.value,null);await e.setProperties(t,null),this.onPsetRemoved.trigger({model:e,psetID:t}),this.registerChange(e,t)}}}async newSingleProperty(e,s,t,r){const n=h.getIFCSchema(e),i=new w[n].IfcIdentifier(t),c=new w[n][s](r),o=new w[n].IfcPropertySingleValue(i,null,c,null);return o.expressID=this.increaseMaxID(e),await this.setData(e,o),o}newSingleStringProperty(e,s,t,r){return this.newSingleProperty(e,s,t,r)}newSingleNumericProperty(e,s,t,r){return this.newSingleProperty(e,s,t,r)}newSingleBooleanProperty(e,s,t,r){return this.newSingleProperty(e,s,t,r)}async removePsetProp(e,s,t){const r=await e.getProperties(s),n=await e.getProperties(t);!r||!n||r.type===x&&n&&(r.HasProperties=r.HasProperties.filter(i=>i.value!==t),await e.setProperties(t,null),this.registerChange(e,s,t))}async addElementToPset(e,s,...t){const r=await v.getPsetRel(e,s);if(!r)return;const n=await e.getProperties(r);if(n){for(const i of t){const c=new P(i);n.RelatedObjects.push(c),this.onElementToPset.trigger({model:e,psetID:s,elementID:i})}this.registerChange(e,s)}}async addPropToPset(e,s,...t){const r=await e.getProperties(s);if(r){for(const n of t){if(r.HasProperties.includes(n))continue;const i=new P(n);r.HasProperties.push(i),this.onPropToPset.trigger({model:e,psetID:s,propID:n})}this.registerChange(e,s)}}async saveToIfc(e,s){const t=this.components.get(E),r=t.webIfc,n=await t.readIfcFile(s),i=this.changeMap[e.uuid]??[];for(const o of i){const u=await e.getProperties(o);if(u)try{r.WriteLine(n,u)}catch{}else try{r.DeleteLine(n,o)}catch{}}const c=r.SaveModel(n);return t.webIfc.CloseModel(n),t.cleanUp(),c}async setAttributeListener(e,s,t){this.attributeListeners[e.uuid]||(this.attributeListeners[e.uuid]={});const r=this.attributeListeners[e.uuid][s]?this.attributeListeners[e.uuid][s][t]:null;if(r)return r;const n=await e.getProperties(s);if(!n)throw new Error(`Entity with expressID ${s} doesn't exists.`);const i=n[t];if(Array.isArray(i)||!i)throw new Error(`Attribute ${t} is array or null, and it can't have a listener.`);const c=i.value;if(c===void 0||c==null)throw new Error(`Attribute ${t} has a badly defined handle.`);const o=new f;return Object.defineProperty(n[t],"value",{get(){return this._value},async set(u){this._value=u,o.trigger(u)}}),n[t].value=c,this.attributeListeners[e.uuid][s]||(this.attributeListeners[e.uuid][s]={}),this.attributeListeners[e.uuid][s][t]=o,o}};a(h,"uuid","58c2d9f0-183c-48d6-a402-dfcf5b9a34df");let b=h;const L=new A,S=L.get(E);await S.setup();const G=await fetch("/resources/small.ifc"),H=await G.arrayBuffer(),l=await S.load(new Uint8Array(H)),g=L.get(b),{pset:T}=await g.newPset(l,"CalculatedQuantities"),j=await g.newSingleNumericProperty(l,"IfcReal","Volume",12.25);await g.addPropToPset(l,T.expressID,j.expressID);await g.addElementToPset(l,T.expressID,186);const D=await l.getProperties(186);D&&(D.Name.value="New Wall Name",await g.setData(l,D));const B=await g.saveToIfc(l,new Uint8Array(H)),m=new File([B],"small-modified.ifc"),C=document.createElement("a");C.href=URL.createObjectURL(m);C.download=m.name;URL.revokeObjectURL(C.href);
