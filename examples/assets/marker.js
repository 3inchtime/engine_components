var C=Object.defineProperty;var L=(l,o,t)=>o in l?C(l,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[o]=t;var i=(l,o,t)=>(L(l,typeof o!="symbol"?o+"":o,t),t);import{V as m,B as _,b as S,M as x}from"./unzipit.module-aSGGZIxN.js";import{U as E,C as F,o as M,a as P,h as A,k as z,R as N,z as B,p as D}from"./N8AO-CvP0s81v.js";import"./serializer-BuFxedjR.js";import"./stream-serializer-CqeLpR-5.js";import"./_commonjsHelpers-Cpj98o6Y.js";class b{constructor(o,t,e){i(this,"three");i(this,"world");i(this,"onDisposed",new E);this.world=o;let s;t?s=t:(s=document.createElement("div"),s.className="w-[15px] h-[15px] border-3 border-solid border-red-600"),this.three=new F(s),(e||o.scene.three).add(this.three),this.visible=!0}set visible(o){this.three.visible=o}get visible(){return this.three.visible}toggleVisibility(){this.visible=!this.visible}dispose(){this.three.removeFromParent(),this.three.element.remove(),this.onDisposed.trigger(),this.onDisposed.reset()}}const g=class g extends M{constructor(t){super(t);i(this,"enabled",!0);i(this,"threshold",50);i(this,"autoCluster",!0);i(this,"list",new Map);i(this,"clusterLabels",new Set);i(this,"currentKeys",new Set);i(this,"_color","white");i(this,"_markerKey",0);i(this,"_clusterKey",0);i(this,"isNavigating",!1);i(this,"_setupWorlds",new Set);t.add(g.uuid,this)}get color(){return this._color}set color(t){this._color=t;for(const[e,s]of this.list)s.label.three.element.style.color=t}create(t,e,s){this.setupEvents(t,!0);const r=document.createElement("span");r.innerHTML=e,r.style.color=this._color;const n=new b(t,r);n.three.position.copy(s);const a=this._markerKey.toString();return this.list.set(a,{key:a,label:n,merged:!1,static:!1}),this._markerKey++,a}delete(t){const e=this.list.get(t);e&&e.label.dispose(),this.list.delete(t)}clear(t){const e=[...this.list.keys()];for(const s of e){const r=this.list.get(s);t&&r.type!==t||(r.label.dispose(),this.list.delete(s))}this.list.clear(),this._markerKey=0}dispose(){for(const[t,e]of this.list)e.label.dispose();this.list.clear(),this._markerKey=0;for(const t of this.clusterLabels)t.label.dispose();this.clusterLabels.clear(),this._clusterKey=0,this.currentKeys.clear()}setupEvents(t,e){e&&this._setupWorlds.has(t.uuid)||t.camera.hasCameraControls()&&(e?(t.camera.controls.addEventListener("sleep",()=>{this.manageCluster()}),t.camera.controls.addEventListener("rest",()=>{this.isNavigating&&(this.manageCluster(),this.isNavigating=!1)})):(t.camera.controls.removeEventListener("sleep",()=>{this.manageCluster()}),t.camera.controls.removeEventListener("rest",()=>{this.isNavigating&&(this.manageCluster(),this.isNavigating=!1)})))}resetMarkers(){for(const[t,e]of this.list)e.merged=!1;for(const t of this.clusterLabels)t.label.dispose();this.clusterLabels.clear(),this._clusterKey=0}removeMergeMarkers(){for(const[t,e]of this.list)e.merged?e.label.dispose():e.label.world.scene.three.add(e.label.three);for(const t of this.clusterLabels)if(t.markerKeys.length===1){const e=this.list.get(t.markerKeys[0]);e&&(e.label.world.scene.three.add(e.label.three),e.merged=!1),t.label.dispose(),this.clusterLabels.delete(t)}}manageCluster(){if(this.autoCluster){this.resetMarkers();for(const[t,e]of this.list)if(!e.merged&&!e.static){this.currentKeys.clear();for(const[s,r]of this.list)r.static||e.key!==r.key&&!r.merged&&this.distance(e.label,r.label)<this.threshold&&(this.currentKeys.add(r.key),r.merged=!0);if(this.currentKeys.size>0){this.currentKeys.add(e.key),e.merged=!0;const s=Array.from(this.currentKeys),r=this.getAveragePositionFromLabels(s),n=new b(e.label.world,this.createClusterElement(this._clusterKey.toString())),{element:a}=n.three;a.textContent=s.length.toString(),n.three.position.copy(r),this.clusterLabels.add({key:this._clusterKey.toString(),markerKeys:s,label:n}),this._clusterKey++}}this.removeMergeMarkers()}}getAveragePositionFromLabels(t){const e=t.map(s=>{const r=this.list.get(s);return r?r.label.three.position:new m});return e.reduce((s,r)=>s.add(r),new m).divideScalar(e.length)}createClusterElement(t){const e=document.createElement("div");return e.textContent=t,e.style.color="#000000",e.style.background="#FFFFFF",e.style.fontSize="1.2rem",e.style.fontWeight="500",e.style.pointerEvents="auto",e.style.borderRadius="50%",e.style.padding="5px 11px",e.style.textAlign="center",e.style.cursor="pointer",e.addEventListener("pointerdown",()=>{this.navigateToCluster(t)}),e.addEventListener("pointerover",()=>{e.style.background="#BCF124"}),e.addEventListener("pointerout",()=>{e.style.background="#FFFFFF"}),e}getScreenPosition(t){const e=new m;if(!t.world.renderer)throw new Error("Renderer not found!");const s=t.three.position.clone();s.project(t.world.camera.three);const r=t.world.renderer.getSize();return e.x=s.x*r.x/2+r.x/2,e.y=-(s.y*r.y/2)+r.y/2,e}distance(t,e){const s=this.getScreenPosition(t),r=this.getScreenPosition(e),n=s.x-r.x,a=s.y-r.y,d=Math.sqrt(n*n+a*a)*.5;return d===0?this.threshold+1:d}navigateToCluster(t){const e=[],s=Array.from(this.clusterLabels).find(f=>f.key===t);if(!s)return;const r=s.label.world.camera;if(!r.hasCameraControls()){console.warn("Zoom to clusters only supported with Camera Controls!");return}for(const f of s.markerKeys){const p=this.list.get(f);if(p){const{x:v,y:w,z:K}=p.label.three.position;e.push(v,w,K)}}s.label.dispose(),this.clusterLabels.delete(s);const n=new _,a=new Float32Array(e),d=new S(a,3);n.setAttribute("position",d);const u=new x(n);u.geometry.computeBoundingSphere(),u.geometry.boundingSphere&&r.controls.fitToSphere(u,!0),this.isNavigating=!0,n.dispose(),u.clear(),e.length=0}};i(g,"uuid","4079eb91-79b0-4ede-bcf2-15b837129236");let y=g;const R=document.getElementById("container"),c=new P,T=c.get(A),h=T.create();h.scene=new z(c);h.renderer=new N(c,R);h.camera=new B(c);c.init();h.camera.controls.setLookAt(5,5,5,0,0,0);const W=c.get(D);W.create(h);const k=c.get(y);k.threshold=10;for(let l=0;l<20;l++){const o=Math.random()*5,t=Math.random()*5,e=Math.random()*5;k.create(h,"ðŸš€",new m(o,t,e))}
