var rn=Object.defineProperty;var on=(r,t,e)=>t in r?rn(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var G=(r,t,e)=>(on(r,typeof t!="symbol"?t+"":t,e),e);import{L as bt,B as ot,R as Ys,E as an,M as et,V as O,a as _t,P as Zs,T as _e,S as ki,b as U,C as we,c as ve,D as hn,A as ln,d as cn,e as dn,f as un,Q as ft,g as pn,h as mn,i as fn,j as ss,W as Ms,k as Vs,l as _n,m as Me,n as Jt,I as be,o as gn,p as tt,O as Ee,q as as,r as Hi,F as Gs,s as yn,t as wn,u as $,v as $s,w as Se,x as Tt,y as xn,z as se,G as vn,H as bn}from"./three.module-CYx2Afzj.js";var En=Object.defineProperty,Tn=(r,t,e)=>t in r?En(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,v=(r,t,e)=>(Tn(r,typeof t!="symbol"?t+"":t,e),e);const Yi=0,Pn=1,Cn=2,Js=2,hs=1.25,ti=1,ts=6*4+4+4,rs=65535,Mn=Math.pow(2,-24),ls=Symbol("SKIP_GENERATION");function On(r){return r.index?r.index.count:r.attributes.position.count}function te(r){return On(r)/3}function An(r,t=ArrayBuffer){return r>65535?new Uint32Array(new t(4*r)):new Uint16Array(new t(2*r))}function Dn(r,t){if(!r.index){const e=r.attributes.position.count,s=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=An(e,s);r.setIndex(new Hi(i,1));for(let n=0;n<e;n++)i[n]=n}}function Zi(r){const t=te(r),e=r.drawRange,s=e.start/3,i=(e.start+e.count)/3,n=Math.max(0,s),o=Math.min(t,i)-n;return[{offset:Math.floor(n),count:Math.floor(o)}]}function Vi(r){if(!r.groups||!r.groups.length)return Zi(r);const t=[],e=new Set,s=r.drawRange,i=s.start/3,n=(s.start+s.count)/3;for(const a of r.groups){const h=a.start/3,l=(a.start+a.count)/3;e.add(Math.max(i,h)),e.add(Math.min(n,l))}const o=Array.from(e.values()).sort((a,h)=>a-h);for(let a=0;a<o.length-1;a++){const h=o[a],l=o[a+1];t.push({offset:Math.floor(h),count:Math.floor(l-h)})}return t}function Sn(r){if(r.groups.length===0)return!1;const t=te(r),e=Vi(r).sort((n,o)=>n.offset-o.offset),s=e[e.length-1];s.count=Math.min(t-s.offset,s.count);let i=0;return e.forEach(({count:n})=>i+=n),t!==i}function Q(r,t,e){return e.min.x=t[r],e.min.y=t[r+1],e.min.z=t[r+2],e.max.x=t[r+3],e.max.y=t[r+4],e.max.z=t[r+5],e}function Un(r){r[0]=r[1]=r[2]=1/0,r[3]=r[4]=r[5]=-1/0}function ei(r){let t=-1,e=-1/0;for(let s=0;s<3;s++){const i=r[s+3]-r[s];i>e&&(e=i,t=s)}return t}function si(r,t){t.set(r)}function ii(r,t,e){let s,i;for(let n=0;n<3;n++){const o=n+3;s=r[n],i=t[n],e[n]=s<i?s:i,s=r[o],i=t[o],e[o]=s>i?s:i}}function Ue(r,t,e){for(let s=0;s<3;s++){const i=t[r+2*s],n=t[r+2*s+1],o=i-n,a=i+n;o<e[s]&&(e[s]=o),a>e[s+3]&&(e[s+3]=a)}}function ie(r){const t=r[3]-r[0],e=r[4]-r[1],s=r[5]-r[2];return 2*(t*e+e*s+s*t)}function cs(r,t,e,s,i=null){let n=1/0,o=1/0,a=1/0,h=-1/0,l=-1/0,c=-1/0,u=1/0,d=1/0,p=1/0,y=-1/0,g=-1/0,f=-1/0;const _=i!==null;for(let w=t*6,b=(t+e)*6;w<b;w+=6){const m=r[w+0],x=r[w+1],P=m-x,E=m+x;P<n&&(n=P),E>h&&(h=E),_&&m<u&&(u=m),_&&m>y&&(y=m);const T=r[w+2],M=r[w+3],A=T-M,S=T+M;A<o&&(o=A),S>l&&(l=S),_&&T<d&&(d=T),_&&T>g&&(g=T);const D=r[w+4],B=r[w+5],z=D-B,H=D+B;z<a&&(a=z),H>c&&(c=H),_&&D<p&&(p=D),_&&D>f&&(f=D)}s[0]=n,s[1]=o,s[2]=a,s[3]=h,s[4]=l,s[5]=c,_&&(i[0]=u,i[1]=d,i[2]=p,i[3]=y,i[4]=g,i[5]=f)}function Bn(r,t,e,s){let i=1/0,n=1/0,o=1/0,a=-1/0,h=-1/0,l=-1/0;for(let c=t*6,u=(t+e)*6;c<u;c+=6){const d=r[c+0];d<i&&(i=d),d>a&&(a=d);const p=r[c+2];p<n&&(n=p),p>h&&(h=p);const y=r[c+4];y<o&&(o=y),y>l&&(l=y)}s[0]=i,s[1]=n,s[2]=o,s[3]=a,s[4]=h,s[5]=l}function Ln(r,t){Un(t);const e=r.attributes.position,s=r.index?r.index.array:null,i=te(r),n=new Float32Array(i*6),o=e.normalized,a=e.array,h=e.offset||0;let l=3;e.isInterleavedBufferAttribute&&(l=e.data.stride);const c=["getX","getY","getZ"];for(let u=0;u<i;u++){const d=u*3,p=u*6;let y=d+0,g=d+1,f=d+2;s&&(y=s[y],g=s[g],f=s[f]),o||(y=y*l+h,g=g*l+h,f=f*l+h);for(let _=0;_<3;_++){let w,b,m;o?(w=e[c[_]](y),b=e[c[_]](g),m=e[c[_]](f)):(w=a[y+_],b=a[g+_],m=a[f+_]);let x=w;b<x&&(x=b),m<x&&(x=m);let P=w;b>P&&(P=b),m>P&&(P=m);const E=(P-x)/2,T=_*2;n[p+T+0]=x+E,n[p+T+1]=E+(Math.abs(x)+E)*Mn,x<t[_]&&(t[_]=x),P>t[_+3]&&(t[_+3]=P)}}return n}const vt=32,zn=(r,t)=>r.candidate-t.candidate,Pt=new Array(vt).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),Be=new Float32Array(6);function Fn(r,t,e,s,i,n){let o=-1,a=0;if(n===Yi)o=ei(t),o!==-1&&(a=(t[o]+t[o+3])/2);else if(n===Pn)o=ei(r),o!==-1&&(a=In(e,s,i,o));else if(n===Cn){const h=ie(r);let l=hs*i;const c=s*6,u=(s+i)*6;for(let d=0;d<3;d++){const p=t[d],y=(t[d+3]-p)/vt;if(i<vt/4){const g=[...Pt];g.length=i;let f=0;for(let w=c;w<u;w+=6,f++){const b=g[f];b.candidate=e[w+2*d],b.count=0;const{bounds:m,leftCacheBounds:x,rightCacheBounds:P}=b;for(let E=0;E<3;E++)P[E]=1/0,P[E+3]=-1/0,x[E]=1/0,x[E+3]=-1/0,m[E]=1/0,m[E+3]=-1/0;Ue(w,e,m)}g.sort(zn);let _=i;for(let w=0;w<_;w++){const b=g[w];for(;w+1<_&&g[w+1].candidate===b.candidate;)g.splice(w+1,1),_--}for(let w=c;w<u;w+=6){const b=e[w+2*d];for(let m=0;m<_;m++){const x=g[m];b>=x.candidate?Ue(w,e,x.rightCacheBounds):(Ue(w,e,x.leftCacheBounds),x.count++)}}for(let w=0;w<_;w++){const b=g[w],m=b.count,x=i-b.count,P=b.leftCacheBounds,E=b.rightCacheBounds;let T=0;m!==0&&(T=ie(P)/h);let M=0;x!==0&&(M=ie(E)/h);const A=ti+hs*(T*m+M*x);A<l&&(o=d,l=A,a=b.candidate)}}else{for(let _=0;_<vt;_++){const w=Pt[_];w.count=0,w.candidate=p+y+_*y;const b=w.bounds;for(let m=0;m<3;m++)b[m]=1/0,b[m+3]=-1/0}for(let _=c;_<u;_+=6){let w=~~((e[_+2*d]-p)/y);w>=vt&&(w=vt-1);const b=Pt[w];b.count++,Ue(_,e,b.bounds)}const g=Pt[vt-1];si(g.bounds,g.rightCacheBounds);for(let _=vt-2;_>=0;_--){const w=Pt[_],b=Pt[_+1];ii(w.bounds,b.rightCacheBounds,w.rightCacheBounds)}let f=0;for(let _=0;_<vt-1;_++){const w=Pt[_],b=w.count,m=w.bounds,x=Pt[_+1].rightCacheBounds;b!==0&&(f===0?si(m,Be):ii(m,Be,Be)),f+=b;let P=0,E=0;f!==0&&(P=ie(Be)/h);const T=i-f;T!==0&&(E=ie(x)/h);const M=ti+hs*(P*f+E*T);M<l&&(o=d,l=M,a=w.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${n} used.`);return{axis:o,pos:a}}function In(r,t,e,s){let i=0;for(let n=t,o=t+e;n<o;n++)i+=r[n*6+s*2];return i/e}class Le{constructor(){}}function Rn(r,t,e,s,i,n){let o=s,a=s+i-1;const h=n.pos,l=n.axis*2;for(;;){for(;o<=a&&e[o*6+l]<h;)o++;for(;o<=a&&e[a*6+l]>=h;)a--;if(o<a){for(let c=0;c<3;c++){let u=t[o*3+c];t[o*3+c]=t[a*3+c],t[a*3+c]=u}for(let c=0;c<6;c++){let u=e[o*6+c];e[o*6+c]=e[a*6+c],e[a*6+c]=u}o++,a--}else return o}}function kn(r,t,e,s,i,n){let o=s,a=s+i-1;const h=n.pos,l=n.axis*2;for(;;){for(;o<=a&&e[o*6+l]<h;)o++;for(;o<=a&&e[a*6+l]>=h;)a--;if(o<a){let c=r[o];r[o]=r[a],r[a]=c;for(let u=0;u<6;u++){let d=e[o*6+u];e[o*6+u]=e[a*6+u],e[a*6+u]=d}o++,a--}else return o}}function Hn(r,t){const e=(r.index?r.index.count:r.attributes.position.count)/3,s=e>2**16,i=s?4:2,n=t?new SharedArrayBuffer(e*i):new ArrayBuffer(e*i),o=s?new Uint32Array(n):new Uint16Array(n);for(let a=0,h=o.length;a<h;a++)o[a]=a;return o}function Yn(r,t){const e=r.geometry,s=e.index?e.index.array:null,i=t.maxDepth,n=t.verbose,o=t.maxLeafTris,a=t.strategy,h=t.onProgress,l=te(e),c=r._indirectBuffer;let u=!1;const d=new Float32Array(6),p=new Float32Array(6),y=Ln(e,d),g=t.indirect?kn:Rn,f=[],_=t.indirect?Zi(e):Vi(e);if(_.length===1){const m=_[0],x=new Le;x.boundingData=d,Bn(y,m.offset,m.count,p),b(x,m.offset,m.count,p),f.push(x)}else for(let m of _){const x=new Le;x.boundingData=new Float32Array(6),cs(y,m.offset,m.count,x.boundingData,p),b(x,m.offset,m.count,p),f.push(x)}return f;function w(m){h&&h(m/l)}function b(m,x,P,E=null,T=0){if(!u&&T>=i&&(u=!0,n&&(console.warn(`MeshBVH: Max depth of ${i} reached when generating BVH. Consider increasing maxDepth.`),console.warn(e))),P<=o||T>=i)return w(x+P),m.offset=x,m.count=P,m;const M=Fn(m.boundingData,E,y,x,P,a);if(M.axis===-1)return w(x+P),m.offset=x,m.count=P,m;const A=g(c,s,y,x,P,M);if(A===x||A===x+P)w(x+P),m.offset=x,m.count=P;else{m.splitAxis=M.axis;const S=new Le,D=x,B=A-x;m.left=S,S.boundingData=new Float32Array(6),cs(y,D,B,S.boundingData,p),b(S,D,B,p,T+1);const z=new Le,H=A,Z=P-B;m.right=z,z.boundingData=new Float32Array(6),cs(y,H,Z,z.boundingData,p),b(z,H,Z,p,T+1)}return m}}function Zn(r,t){const e=r.geometry;t.indirect&&(r._indirectBuffer=Hn(e,t.useSharedArrayBuffer),Sn(e)&&!t.verbose&&console.warn('MeshBVH: Provided geometry contains groups that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),r._indirectBuffer||Dn(e,t);const s=Yn(r,t);let i,n,o;const a=[],h=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;for(let u=0;u<s.length;u++){const d=s[u];let p=l(d);const y=new h(ts*p);i=new Float32Array(y),n=new Uint32Array(y),o=new Uint16Array(y),c(0,d),a.push(y)}r._roots=a;return;function l(u){return u.count?1:1+l(u.left)+l(u.right)}function c(u,d){const p=u/4,y=u/2,g=!!d.count,f=d.boundingData;for(let _=0;_<6;_++)i[p+_]=f[_];if(g){const _=d.offset,w=d.count;return n[p+6]=_,o[y+14]=w,o[y+15]=rs,u+ts}else{const _=d.left,w=d.right,b=d.splitAxis;let m;if(m=c(u+ts,_),m/4>Math.pow(2,32))throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return n[p+6]=m/4,m=c(m,w),n[p+7]=b,m}}}class Et{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(t,e){let s=1/0,i=-1/0;for(let n=0,o=t.length;n<o;n++){const a=t[n][e];s=a<s?a:s,i=a>i?a:i}this.min=s,this.max=i}setFromPoints(t,e){let s=1/0,i=-1/0;for(let n=0,o=e.length;n<o;n++){const a=e[n],h=t.dot(a);s=h<s?h:s,i=h>i?h:i}this.min=s,this.max=i}isSeparated(t){return this.min>t.max||t.min>this.max}}Et.prototype.setFromBox=function(){const r=new O;return function(t,e){const s=e.min,i=e.max;let n=1/0,o=-1/0;for(let a=0;a<=1;a++)for(let h=0;h<=1;h++)for(let l=0;l<=1;l++){r.x=s.x*a+i.x*(1-a),r.y=s.y*h+i.y*(1-h),r.z=s.z*l+i.z*(1-l);const c=t.dot(r);n=Math.min(c,n),o=Math.max(c,o)}this.min=n,this.max=o}}();const Vn=function(){const r=new O,t=new O,e=new O;return function(s,i,n){const o=s.start,a=r,h=i.start,l=t;e.subVectors(o,h),r.subVectors(s.end,s.start),t.subVectors(i.end,i.start);const c=e.dot(l),u=l.dot(a),d=l.dot(l),p=e.dot(a),y=a.dot(a)*d-u*u;let g,f;y!==0?g=(c*u-p*d)/y:g=0,f=(c+g*u)/d,n.x=g,n.y=f}}(),Ns=function(){const r=new _t,t=new O,e=new O;return function(s,i,n,o){Vn(s,i,r);let a=r.x,h=r.y;if(a>=0&&a<=1&&h>=0&&h<=1){s.at(a,n),i.at(h,o);return}else if(a>=0&&a<=1){h<0?i.at(0,o):i.at(1,o),s.closestPointToPoint(o,!0,n);return}else if(h>=0&&h<=1){a<0?s.at(0,n):s.at(1,n),i.closestPointToPoint(n,!0,o);return}else{let l;a<0?l=s.start:l=s.end;let c;h<0?c=i.start:c=i.end;const u=t,d=e;if(s.closestPointToPoint(c,!0,t),i.closestPointToPoint(l,!0,e),u.distanceToSquared(c)<=d.distanceToSquared(l)){n.copy(u),o.copy(c);return}else{n.copy(l),o.copy(d);return}}}}(),Nn=function(){const r=new O,t=new O,e=new Zs,s=new bt;return function(i,n){const{radius:o,center:a}=i,{a:h,b:l,c}=n;if(s.start=h,s.end=l,s.closestPointToPoint(a,!0,r).distanceTo(a)<=o||(s.start=h,s.end=c,s.closestPointToPoint(a,!0,r).distanceTo(a)<=o)||(s.start=l,s.end=c,s.closestPointToPoint(a,!0,r).distanceTo(a)<=o))return!0;const u=n.getPlane(e);if(Math.abs(u.distanceToPoint(a))<=o){const d=u.projectPoint(a,t);if(n.containsPoint(d))return!0}return!1}}(),Xn=1e-15;function ds(r){return Math.abs(r)<Xn}class gt extends _e{constructor(...t){super(...t),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new O),this.satBounds=new Array(4).fill().map(()=>new Et),this.points=[this.a,this.b,this.c],this.sphere=new ki,this.plane=new Zs,this.needsUpdate=!0}intersectsSphere(t){return Nn(t,this)}update(){const t=this.a,e=this.b,s=this.c,i=this.points,n=this.satAxes,o=this.satBounds,a=n[0],h=o[0];this.getNormal(a),h.setFromPoints(a,i);const l=n[1],c=o[1];l.subVectors(t,e),c.setFromPoints(l,i);const u=n[2],d=o[2];u.subVectors(e,s),d.setFromPoints(u,i);const p=n[3],y=o[3];p.subVectors(s,t),y.setFromPoints(p,i),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(a,t),this.needsUpdate=!1}}gt.prototype.closestPointToSegment=function(){const r=new O,t=new O,e=new bt;return function(s,i=null,n=null){const{start:o,end:a}=s,h=this.points;let l,c=1/0;for(let u=0;u<3;u++){const d=(u+1)%3;e.start.copy(h[u]),e.end.copy(h[d]),Ns(e,s,r,t),l=r.distanceToSquared(t),l<c&&(c=l,i&&i.copy(r),n&&n.copy(t))}return this.closestPointToPoint(o,r),l=o.distanceToSquared(r),l<c&&(c=l,i&&i.copy(r),n&&n.copy(o)),this.closestPointToPoint(a,r),l=a.distanceToSquared(r),l<c&&(c=l,i&&i.copy(r),n&&n.copy(a)),Math.sqrt(c)}}();gt.prototype.intersectsTriangle=function(){const r=new gt,t=new Array(3),e=new Array(3),s=new Et,i=new Et,n=new O,o=new O,a=new O,h=new O,l=new O,c=new bt,u=new bt,d=new bt,p=new O;function y(g,f,_){const w=g.points;let b=0,m=-1;for(let x=0;x<3;x++){const{start:P,end:E}=c;P.copy(w[x]),E.copy(w[(x+1)%3]),c.delta(o);const T=ds(f.distanceToPoint(P));if(ds(f.normal.dot(o))&&T){_.copy(c),b=2;break}const M=f.intersectLine(c,p);if(!M&&T&&p.copy(P),(M||T)&&!ds(p.distanceTo(E))){if(b<=1)(b===1?_.start:_.end).copy(p),T&&(m=b);else if(b>=2){(m===1?_.start:_.end).copy(p),b=2;break}if(b++,b===2&&m===-1)break}}return b}return function(g,f=null,_=!1){this.needsUpdate&&this.update(),g.isExtendedTriangle?g.needsUpdate&&g.update():(r.copy(g),r.update(),g=r);const w=this.plane,b=g.plane;if(Math.abs(w.normal.dot(b.normal))>1-1e-10){const m=this.satBounds,x=this.satAxes;e[0]=g.a,e[1]=g.b,e[2]=g.c;for(let T=0;T<4;T++){const M=m[T],A=x[T];if(s.setFromPoints(A,e),M.isSeparated(s))return!1}const P=g.satBounds,E=g.satAxes;t[0]=this.a,t[1]=this.b,t[2]=this.c;for(let T=0;T<4;T++){const M=P[T],A=E[T];if(s.setFromPoints(A,t),M.isSeparated(s))return!1}for(let T=0;T<4;T++){const M=x[T];for(let A=0;A<4;A++){const S=E[A];if(n.crossVectors(M,S),s.setFromPoints(n,t),i.setFromPoints(n,e),s.isSeparated(i))return!1}}return f&&(_||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),f.start.set(0,0,0),f.end.set(0,0,0)),!0}else{const m=y(this,b,u);if(m===1&&g.containsPoint(u.end))return f&&(f.start.copy(u.end),f.end.copy(u.end)),!0;if(m!==2)return!1;const x=y(g,w,d);if(x===1&&this.containsPoint(d.end))return f&&(f.start.copy(d.end),f.end.copy(d.end)),!0;if(x!==2)return!1;if(u.delta(a),d.delta(h),a.dot(h)<0){let D=d.start;d.start=d.end,d.end=D}const P=u.start.dot(a),E=u.end.dot(a),T=d.start.dot(a),M=d.end.dot(a),A=E<T,S=P<M;return P!==M&&T!==E&&A===S?!1:(f&&(l.subVectors(u.start,d.start),l.dot(a)>0?f.start.copy(u.start):f.start.copy(d.start),l.subVectors(u.end,d.end),l.dot(a)<0?f.end.copy(u.end):f.end.copy(d.end)),!0)}}}();gt.prototype.distanceToPoint=function(){const r=new O;return function(t){return this.closestPointToPoint(t,r),t.distanceTo(r)}}();gt.prototype.distanceToTriangle=function(){const r=new O,t=new O,e=["a","b","c"],s=new bt,i=new bt;return function(n,o=null,a=null){const h=o||a?s:null;if(this.intersectsTriangle(n,h))return(o||a)&&(o&&h.getCenter(o),a&&h.getCenter(a)),0;let l=1/0;for(let c=0;c<3;c++){let u;const d=e[c],p=n[d];this.closestPointToPoint(p,r),u=p.distanceToSquared(r),u<l&&(l=u,o&&o.copy(r),a&&a.copy(p));const y=this[d];n.closestPointToPoint(y,r),u=y.distanceToSquared(r),u<l&&(l=u,o&&o.copy(y),a&&a.copy(r))}for(let c=0;c<3;c++){const u=e[c],d=e[(c+1)%3];s.set(this[u],this[d]);for(let p=0;p<3;p++){const y=e[p],g=e[(p+1)%3];i.set(n[y],n[g]),Ns(s,i,r,t);const f=r.distanceToSquared(t);f<l&&(l=f,o&&o.copy(r),a&&a.copy(t))}}return Math.sqrt(l)}}();class st{constructor(t,e,s){this.isOrientedBox=!0,this.min=new O,this.max=new O,this.matrix=new et,this.invMatrix=new et,this.points=new Array(8).fill().map(()=>new O),this.satAxes=new Array(3).fill().map(()=>new O),this.satBounds=new Array(3).fill().map(()=>new Et),this.alignedSatBounds=new Array(3).fill().map(()=>new Et),this.needsUpdate=!1,t&&this.min.copy(t),e&&this.max.copy(e),s&&this.matrix.copy(s)}set(t,e,s){this.min.copy(t),this.max.copy(e),this.matrix.copy(s),this.needsUpdate=!0}copy(t){this.min.copy(t.min),this.max.copy(t.max),this.matrix.copy(t.matrix),this.needsUpdate=!0}}st.prototype.update=function(){return function(){const r=this.matrix,t=this.min,e=this.max,s=this.points;for(let h=0;h<=1;h++)for(let l=0;l<=1;l++)for(let c=0;c<=1;c++){const u=1*h|2*l|4*c,d=s[u];d.x=h?e.x:t.x,d.y=l?e.y:t.y,d.z=c?e.z:t.z,d.applyMatrix4(r)}const i=this.satBounds,n=this.satAxes,o=s[0];for(let h=0;h<3;h++){const l=n[h],c=i[h],u=1<<h,d=s[u];l.subVectors(o,d),c.setFromPoints(l,s)}const a=this.alignedSatBounds;a[0].setFromPointsField(s,"x"),a[1].setFromPointsField(s,"y"),a[2].setFromPointsField(s,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}}();st.prototype.intersectsBox=function(){const r=new Et;return function(t){this.needsUpdate&&this.update();const e=t.min,s=t.max,i=this.satBounds,n=this.satAxes,o=this.alignedSatBounds;if(r.min=e.x,r.max=s.x,o[0].isSeparated(r)||(r.min=e.y,r.max=s.y,o[1].isSeparated(r))||(r.min=e.z,r.max=s.z,o[2].isSeparated(r)))return!1;for(let a=0;a<3;a++){const h=n[a],l=i[a];if(r.setFromBox(h,t),l.isSeparated(r))return!1}return!0}}();st.prototype.intersectsTriangle=function(){const r=new gt,t=new Array(3),e=new Et,s=new Et,i=new O;return function(n){this.needsUpdate&&this.update(),n.isExtendedTriangle?n.needsUpdate&&n.update():(r.copy(n),r.update(),n=r);const o=this.satBounds,a=this.satAxes;t[0]=n.a,t[1]=n.b,t[2]=n.c;for(let u=0;u<3;u++){const d=o[u],p=a[u];if(e.setFromPoints(p,t),d.isSeparated(e))return!1}const h=n.satBounds,l=n.satAxes,c=this.points;for(let u=0;u<3;u++){const d=h[u],p=l[u];if(e.setFromPoints(p,c),d.isSeparated(e))return!1}for(let u=0;u<3;u++){const d=a[u];for(let p=0;p<4;p++){const y=l[p];if(i.crossVectors(d,y),e.setFromPoints(i,t),s.setFromPoints(i,c),e.isSeparated(s))return!1}}return!0}}();st.prototype.closestPointToPoint=function(){return function(r,t){return this.needsUpdate&&this.update(),t.copy(r).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t}}();st.prototype.distanceToPoint=function(){const r=new O;return function(t){return this.closestPointToPoint(t,r),t.distanceTo(r)}}();st.prototype.distanceToBox=function(){const r=["x","y","z"],t=new Array(12).fill().map(()=>new bt),e=new Array(12).fill().map(()=>new bt),s=new O,i=new O;return function(n,o=0,a=null,h=null){if(this.needsUpdate&&this.update(),this.intersectsBox(n))return(a||h)&&(n.getCenter(i),this.closestPointToPoint(i,s),n.closestPointToPoint(s,i),a&&a.copy(s),h&&h.copy(i)),0;const l=o*o,c=n.min,u=n.max,d=this.points;let p=1/0;for(let g=0;g<8;g++){const f=d[g];i.copy(f).clamp(c,u);const _=f.distanceToSquared(i);if(_<p&&(p=_,a&&a.copy(f),h&&h.copy(i),_<l))return Math.sqrt(_)}let y=0;for(let g=0;g<3;g++)for(let f=0;f<=1;f++)for(let _=0;_<=1;_++){const w=(g+1)%3,b=(g+2)%3,m=f<<w|_<<b,x=1<<g|f<<w|_<<b,P=d[m],E=d[x];t[y].set(P,E);const T=r[g],M=r[w],A=r[b],S=e[y],D=S.start,B=S.end;D[T]=c[T],D[M]=f?c[M]:u[M],D[A]=_?c[A]:u[M],B[T]=u[T],B[M]=f?c[M]:u[M],B[A]=_?c[A]:u[M],y++}for(let g=0;g<=1;g++)for(let f=0;f<=1;f++)for(let _=0;_<=1;_++){i.x=g?u.x:c.x,i.y=f?u.y:c.y,i.z=_?u.z:c.z,this.closestPointToPoint(i,s);const w=i.distanceToSquared(s);if(w<p&&(p=w,a&&a.copy(s),h&&h.copy(i),w<l))return Math.sqrt(w)}for(let g=0;g<12;g++){const f=t[g];for(let _=0;_<12;_++){const w=e[_];Ns(f,w,s,i);const b=s.distanceToSquared(i);if(b<p&&(p=b,a&&a.copy(s),h&&h.copy(i),b<l))return Math.sqrt(b)}}return Math.sqrt(p)}}();class Xs{constructor(t){this._getNewPrimitive=t,this._primitives=[]}getPrimitive(){const t=this._primitives;return t.length===0?this._getNewPrimitive():t.pop()}releasePrimitive(t){this._primitives.push(t)}}class Wn extends Xs{constructor(){super(()=>new gt)}}const lt=new Wn;function nt(r,t){return t[r+15]===65535}function rt(r,t){return t[r+6]}function ct(r,t){return t[r+14]}function dt(r){return r+8}function ut(r,t){return t[r+6]}function Ni(r,t){return t[r+7]}class Qn{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const t=[];let e=null;this.setBuffer=s=>{e&&t.push(e),e=s,this.float32Array=new Float32Array(s),this.uint16Array=new Uint16Array(s),this.uint32Array=new Uint32Array(s)},this.clearBuffer=()=>{e=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,t.length!==0&&this.setBuffer(t.pop())}}}const X=new Qn;let At,$t;const It=[],ze=new Xs(()=>new ot);function qn(r,t,e,s,i,n){At=ze.getPrimitive(),$t=ze.getPrimitive(),It.push(At,$t),X.setBuffer(r._roots[t]);const o=Os(0,r.geometry,e,s,i,n);X.clearBuffer(),ze.releasePrimitive(At),ze.releasePrimitive($t),It.pop(),It.pop();const a=It.length;return a>0&&($t=It[a-1],At=It[a-2]),o}function Os(r,t,e,s,i=null,n=0,o=0){const{float32Array:a,uint16Array:h,uint32Array:l}=X;let c=r*2;if(nt(c,h)){const u=rt(r,l),d=ct(c,h);return Q(r,a,At),s(u,d,!1,o,n+r,At)}else{let u=function(S){const{uint16Array:D,uint32Array:B}=X;let z=S*2;for(;!nt(z,D);)S=dt(S),z=S*2;return rt(S,B)},d=function(S){const{uint16Array:D,uint32Array:B}=X;let z=S*2;for(;!nt(z,D);)S=ut(S,B),z=S*2;return rt(S,B)+ct(z,D)};const p=dt(r),y=ut(r,l);let g=p,f=y,_,w,b,m;if(i&&(b=At,m=$t,Q(g,a,b),Q(f,a,m),_=i(b),w=i(m),w<_)){g=y,f=p;const S=_;_=w,w=S,b=m}b||(b=At,Q(g,a,b));const x=nt(g*2,h),P=e(b,x,_,o+1,n+g);let E;if(P===Js){const S=u(g),D=d(g)-S;E=s(S,D,!0,o+1,n+g,b)}else E=P&&Os(g,t,e,s,i,n,o+1);if(E)return!0;m=$t,Q(f,a,m);const T=nt(f*2,h),M=e(m,T,w,o+1,n+f);let A;if(M===Js){const S=u(f),D=d(f)-S;A=s(S,D,!0,o+1,n+f,m)}else A=M&&Os(f,t,e,s,i,n,o+1);return!!A}}const ne=new O,us=new O;function Kn(r,t,e={},s=0,i=1/0){const n=s*s,o=i*i;let a=1/0,h=null;if(r.shapecast({boundsTraverseOrder:c=>(ne.copy(t).clamp(c.min,c.max),ne.distanceToSquared(t)),intersectsBounds:(c,u,d)=>d<a&&d<o,intersectsTriangle:(c,u)=>{c.closestPointToPoint(t,ne);const d=t.distanceToSquared(ne);return d<a&&(us.copy(ne),a=d,h=u),d<n}}),a===1/0)return null;const l=Math.sqrt(a);return e.point?e.point.copy(us):e.point=us.clone(),e.distance=l,e.faceIndex=h,e}const Rt=new O,kt=new O,Ht=new O,Fe=new _t,Ie=new _t,Re=new _t,ni=new O,ri=new O,oi=new O,ke=new O;function jn(r,t,e,s,i,n){let o;return n===bn?o=r.intersectTriangle(s,e,t,!0,i):o=r.intersectTriangle(t,e,s,n!==Me,i),o===null?null:{distance:r.origin.distanceTo(i),point:i.clone()}}function Gn(r,t,e,s,i,n,o,a,h){Rt.fromBufferAttribute(t,n),kt.fromBufferAttribute(t,o),Ht.fromBufferAttribute(t,a);const l=jn(r,Rt,kt,Ht,ke,h);if(l){s&&(Fe.fromBufferAttribute(s,n),Ie.fromBufferAttribute(s,o),Re.fromBufferAttribute(s,a),l.uv=_e.getInterpolation(ke,Rt,kt,Ht,Fe,Ie,Re,new _t)),i&&(Fe.fromBufferAttribute(i,n),Ie.fromBufferAttribute(i,o),Re.fromBufferAttribute(i,a),l.uv1=_e.getInterpolation(ke,Rt,kt,Ht,Fe,Ie,Re,new _t)),e&&(ni.fromBufferAttribute(e,n),ri.fromBufferAttribute(e,o),oi.fromBufferAttribute(e,a),l.normal=_e.getInterpolation(ke,Rt,kt,Ht,ni,ri,oi,new O),l.normal.dot(r.direction)>0&&l.normal.multiplyScalar(-1));const c={a:n,b:o,c:a,normal:new O,materialIndex:0};_e.getNormal(Rt,kt,Ht,c.normal),l.face=c,l.faceIndex=n}return l}function os(r,t,e,s,i){const n=s*3;let o=n+0,a=n+1,h=n+2;const l=r.index;r.index&&(o=l.getX(o),a=l.getX(a),h=l.getX(h));const{position:c,normal:u,uv:d,uv1:p}=r.attributes,y=Gn(e,c,u,d,p,o,a,h,t);return y?(y.faceIndex=s,i&&i.push(y),y):null}function K(r,t,e,s){const i=r.a,n=r.b,o=r.c;let a=t,h=t+1,l=t+2;e&&(a=e.getX(a),h=e.getX(h),l=e.getX(l)),i.x=s.getX(a),i.y=s.getY(a),i.z=s.getZ(a),n.x=s.getX(h),n.y=s.getY(h),n.z=s.getZ(h),o.x=s.getX(l),o.y=s.getY(l),o.z=s.getZ(l)}function $n(r,t,e,s,i,n){const{geometry:o,_indirectBuffer:a}=r;for(let h=s,l=s+i;h<l;h++)os(o,t,e,h,n)}function Jn(r,t,e,s,i){const{geometry:n,_indirectBuffer:o}=r;let a=1/0,h=null;for(let l=s,c=s+i;l<c;l++){let u;u=os(n,t,e,l),u&&u.distance<a&&(h=u,a=u.distance)}return h}function tr(r,t,e,s,i,n,o){const{geometry:a}=e,{index:h}=a,l=a.attributes.position;for(let c=r,u=t+r;c<u;c++){let d;if(d=c,K(o,d*3,h,l),o.needsUpdate=!0,s(o,d,i,n))return!0}return!1}function er(r,t=null){t&&Array.isArray(t)&&(t=new Set(t));const e=r.geometry,s=e.index?e.index.array:null,i=e.attributes.position;let n,o,a,h,l=0;const c=r._roots;for(let d=0,p=c.length;d<p;d++)n=c[d],o=new Uint32Array(n),a=new Uint16Array(n),h=new Float32Array(n),u(0,l),l+=n.byteLength;function u(d,p,y=!1){const g=d*2;if(a[g+15]===rs){const f=o[d+6],_=a[g+14];let w=1/0,b=1/0,m=1/0,x=-1/0,P=-1/0,E=-1/0;for(let T=3*f,M=3*(f+_);T<M;T++){let A=s[T];const S=i.getX(A),D=i.getY(A),B=i.getZ(A);S<w&&(w=S),S>x&&(x=S),D<b&&(b=D),D>P&&(P=D),B<m&&(m=B),B>E&&(E=B)}return h[d+0]!==w||h[d+1]!==b||h[d+2]!==m||h[d+3]!==x||h[d+4]!==P||h[d+5]!==E?(h[d+0]=w,h[d+1]=b,h[d+2]=m,h[d+3]=x,h[d+4]=P,h[d+5]=E,!0):!1}else{const f=d+8,_=o[d+6],w=f+p,b=_+p;let m=y,x=!1,P=!1;t?m||(x=t.has(w),P=t.has(b),m=!x&&!P):(x=!0,P=!0);const E=m||x,T=m||P;let M=!1;E&&(M=u(f,p,m));let A=!1;T&&(A=u(_,p,m));const S=M||A;if(S)for(let D=0;D<3;D++){const B=f+D,z=_+D,H=h[B],Z=h[B+3],at=h[z],q=h[z+3];h[d+D]=H<at?H:at,h[d+D+3]=Z>q?Z:q}return S}}}const ai=new ot;function Dt(r,t,e,s){return Q(r,t,ai),e.intersectBox(ai,s)}function sr(r,t,e,s,i,n){const{geometry:o,_indirectBuffer:a}=r;for(let h=s,l=s+i;h<l;h++){let c=a?a[h]:h;os(o,t,e,c,n)}}function ir(r,t,e,s,i){const{geometry:n,_indirectBuffer:o}=r;let a=1/0,h=null;for(let l=s,c=s+i;l<c;l++){let u;u=os(n,t,e,o?o[l]:l),u&&u.distance<a&&(h=u,a=u.distance)}return h}function nr(r,t,e,s,i,n,o){const{geometry:a}=e,{index:h}=a,l=a.attributes.position;for(let c=r,u=t+r;c<u;c++){let d;if(d=e.resolveTriangleIndex(c),K(o,d*3,h,l),o.needsUpdate=!0,s(o,d,i,n))return!0}return!1}const hi=new O;function rr(r,t,e,s,i){X.setBuffer(r._roots[t]),As(0,r,e,s,i),X.clearBuffer()}function As(r,t,e,s,i){const{float32Array:n,uint16Array:o,uint32Array:a}=X,h=r*2;if(nt(h,o)){const l=rt(r,a),c=ct(h,o);$n(t,e,s,l,c,i)}else{const l=dt(r);Dt(l,n,s,hi)&&As(l,t,e,s,i);const c=ut(r,a);Dt(c,n,s,hi)&&As(c,t,e,s,i)}}const li=new O,or=["x","y","z"];function ar(r,t,e,s){X.setBuffer(r._roots[t]);const i=Ds(0,r,e,s);return X.clearBuffer(),i}function Ds(r,t,e,s){const{float32Array:i,uint16Array:n,uint32Array:o}=X;let a=r*2;if(nt(a,n)){const h=rt(r,o),l=ct(a,n);return Jn(t,e,s,h,l)}else{const h=Ni(r,o),l=or[h],c=s.direction[l]>=0;let u,d;c?(u=dt(r),d=ut(r,o)):(u=ut(r,o),d=dt(r));const p=Dt(u,i,s,li)?Ds(u,t,e,s):null;if(p){const g=p.point[l];if(c?g<=i[d+h]:g>=i[d+h+3])return p}const y=Dt(d,i,s,li)?Ds(d,t,e,s):null;return p&&y?p.distance<=y.distance?p:y:p||y||null}}const He=new ot,Yt=new gt,Zt=new gt,re=new et,ci=new st,Ye=new st;function hr(r,t,e,s){X.setBuffer(r._roots[t]);const i=Ss(0,r,e,s);return X.clearBuffer(),i}function Ss(r,t,e,s,i=null){const{float32Array:n,uint16Array:o,uint32Array:a}=X;let h=r*2;if(i===null&&(e.boundingBox||e.computeBoundingBox(),ci.set(e.boundingBox.min,e.boundingBox.max,s),i=ci),nt(h,o)){const l=t.geometry,c=l.index,u=l.attributes.position,d=e.index,p=e.attributes.position,y=rt(r,a),g=ct(h,o);if(re.copy(s).invert(),e.boundsTree)return Q(r,n,Ye),Ye.matrix.copy(re),Ye.needsUpdate=!0,e.boundsTree.shapecast({intersectsBounds:f=>Ye.intersectsBox(f),intersectsTriangle:f=>{f.a.applyMatrix4(s),f.b.applyMatrix4(s),f.c.applyMatrix4(s),f.needsUpdate=!0;for(let _=y*3,w=(g+y)*3;_<w;_+=3)if(K(Zt,_,c,u),Zt.needsUpdate=!0,f.intersectsTriangle(Zt))return!0;return!1}});for(let f=y*3,_=(g+y)*3;f<_;f+=3){K(Yt,f,c,u),Yt.a.applyMatrix4(re),Yt.b.applyMatrix4(re),Yt.c.applyMatrix4(re),Yt.needsUpdate=!0;for(let w=0,b=d.count;w<b;w+=3)if(K(Zt,w,d,p),Zt.needsUpdate=!0,Yt.intersectsTriangle(Zt))return!0}}else{const l=r+8,c=a[r+6];return Q(l,n,He),!!(i.intersectsBox(He)&&Ss(l,t,e,s,i)||(Q(c,n,He),i.intersectsBox(He)&&Ss(c,t,e,s,i)))}}const Ze=new et,ps=new st,oe=new st,lr=new O,cr=new O,dr=new O,ur=new O;function pr(r,t,e,s={},i={},n=0,o=1/0){t.boundingBox||t.computeBoundingBox(),ps.set(t.boundingBox.min,t.boundingBox.max,e),ps.needsUpdate=!0;const a=r.geometry,h=a.attributes.position,l=a.index,c=t.attributes.position,u=t.index,d=lt.getPrimitive(),p=lt.getPrimitive();let y=lr,g=cr,f=null,_=null;i&&(f=dr,_=ur);let w=1/0,b=null,m=null;return Ze.copy(e).invert(),oe.matrix.copy(Ze),r.shapecast({boundsTraverseOrder:x=>ps.distanceToBox(x),intersectsBounds:(x,P,E)=>E<w&&E<o?(P&&(oe.min.copy(x.min),oe.max.copy(x.max),oe.needsUpdate=!0),!0):!1,intersectsRange:(x,P)=>{if(t.boundsTree)return t.boundsTree.shapecast({boundsTraverseOrder:E=>oe.distanceToBox(E),intersectsBounds:(E,T,M)=>M<w&&M<o,intersectsRange:(E,T)=>{for(let M=E,A=E+T;M<A;M++){K(p,3*M,u,c),p.a.applyMatrix4(e),p.b.applyMatrix4(e),p.c.applyMatrix4(e),p.needsUpdate=!0;for(let S=x,D=x+P;S<D;S++){K(d,3*S,l,h),d.needsUpdate=!0;const B=d.distanceToTriangle(p,y,f);if(B<w&&(g.copy(y),_&&_.copy(f),w=B,b=S,m=M),B<n)return!0}}}});{const E=te(t);for(let T=0,M=E;T<M;T++){K(p,3*T,u,c),p.a.applyMatrix4(e),p.b.applyMatrix4(e),p.c.applyMatrix4(e),p.needsUpdate=!0;for(let A=x,S=x+P;A<S;A++){K(d,3*A,l,h),d.needsUpdate=!0;const D=d.distanceToTriangle(p,y,f);if(D<w&&(g.copy(y),_&&_.copy(f),w=D,b=A,m=T),D<n)return!0}}}}}),lt.releasePrimitive(d),lt.releasePrimitive(p),w===1/0?null:(s.point?s.point.copy(g):s.point=g.clone(),s.distance=w,s.faceIndex=b,i&&(i.point?i.point.copy(_):i.point=_.clone(),i.point.applyMatrix4(Ze),g.applyMatrix4(Ze),i.distance=g.sub(i.point).length(),i.faceIndex=m),s)}function mr(r,t=null){t&&Array.isArray(t)&&(t=new Set(t));const e=r.geometry,s=e.index?e.index.array:null,i=e.attributes.position;let n,o,a,h,l=0;const c=r._roots;for(let d=0,p=c.length;d<p;d++)n=c[d],o=new Uint32Array(n),a=new Uint16Array(n),h=new Float32Array(n),u(0,l),l+=n.byteLength;function u(d,p,y=!1){const g=d*2;if(a[g+15]===rs){const f=o[d+6],_=a[g+14];let w=1/0,b=1/0,m=1/0,x=-1/0,P=-1/0,E=-1/0;for(let T=f,M=f+_;T<M;T++){const A=3*r.resolveTriangleIndex(T);for(let S=0;S<3;S++){let D=A+S;D=s?s[D]:D;const B=i.getX(D),z=i.getY(D),H=i.getZ(D);B<w&&(w=B),B>x&&(x=B),z<b&&(b=z),z>P&&(P=z),H<m&&(m=H),H>E&&(E=H)}}return h[d+0]!==w||h[d+1]!==b||h[d+2]!==m||h[d+3]!==x||h[d+4]!==P||h[d+5]!==E?(h[d+0]=w,h[d+1]=b,h[d+2]=m,h[d+3]=x,h[d+4]=P,h[d+5]=E,!0):!1}else{const f=d+8,_=o[d+6],w=f+p,b=_+p;let m=y,x=!1,P=!1;t?m||(x=t.has(w),P=t.has(b),m=!x&&!P):(x=!0,P=!0);const E=m||x,T=m||P;let M=!1;E&&(M=u(f,p,m));let A=!1;T&&(A=u(_,p,m));const S=M||A;if(S)for(let D=0;D<3;D++){const B=f+D,z=_+D,H=h[B],Z=h[B+3],at=h[z],q=h[z+3];h[d+D]=H<at?H:at,h[d+D+3]=Z>q?Z:q}return S}}}const di=new O;function fr(r,t,e,s,i){X.setBuffer(r._roots[t]),Us(0,r,e,s,i),X.clearBuffer()}function Us(r,t,e,s,i){const{float32Array:n,uint16Array:o,uint32Array:a}=X,h=r*2;if(nt(h,o)){const l=rt(r,a),c=ct(h,o);sr(t,e,s,l,c,i)}else{const l=dt(r);Dt(l,n,s,di)&&Us(l,t,e,s,i);const c=ut(r,a);Dt(c,n,s,di)&&Us(c,t,e,s,i)}}const ui=new O,_r=["x","y","z"];function gr(r,t,e,s){X.setBuffer(r._roots[t]);const i=Bs(0,r,e,s);return X.clearBuffer(),i}function Bs(r,t,e,s){const{float32Array:i,uint16Array:n,uint32Array:o}=X;let a=r*2;if(nt(a,n)){const h=rt(r,o),l=ct(a,n);return ir(t,e,s,h,l)}else{const h=Ni(r,o),l=_r[h],c=s.direction[l]>=0;let u,d;c?(u=dt(r),d=ut(r,o)):(u=ut(r,o),d=dt(r));const p=Dt(u,i,s,ui)?Bs(u,t,e,s):null;if(p){const g=p.point[l];if(c?g<=i[d+h]:g>=i[d+h+3])return p}const y=Dt(d,i,s,ui)?Bs(d,t,e,s):null;return p&&y?p.distance<=y.distance?p:y:p||y||null}}const Ve=new ot,Vt=new gt,Nt=new gt,ae=new et,pi=new st,Ne=new st;function yr(r,t,e,s){X.setBuffer(r._roots[t]);const i=Ls(0,r,e,s);return X.clearBuffer(),i}function Ls(r,t,e,s,i=null){const{float32Array:n,uint16Array:o,uint32Array:a}=X;let h=r*2;if(i===null&&(e.boundingBox||e.computeBoundingBox(),pi.set(e.boundingBox.min,e.boundingBox.max,s),i=pi),nt(h,o)){const l=t.geometry,c=l.index,u=l.attributes.position,d=e.index,p=e.attributes.position,y=rt(r,a),g=ct(h,o);if(ae.copy(s).invert(),e.boundsTree)return Q(r,n,Ne),Ne.matrix.copy(ae),Ne.needsUpdate=!0,e.boundsTree.shapecast({intersectsBounds:f=>Ne.intersectsBox(f),intersectsTriangle:f=>{f.a.applyMatrix4(s),f.b.applyMatrix4(s),f.c.applyMatrix4(s),f.needsUpdate=!0;for(let _=y,w=g+y;_<w;_++)if(K(Nt,3*t.resolveTriangleIndex(_),c,u),Nt.needsUpdate=!0,f.intersectsTriangle(Nt))return!0;return!1}});for(let f=y,_=g+y;f<_;f++){const w=t.resolveTriangleIndex(f);K(Vt,3*w,c,u),Vt.a.applyMatrix4(ae),Vt.b.applyMatrix4(ae),Vt.c.applyMatrix4(ae),Vt.needsUpdate=!0;for(let b=0,m=d.count;b<m;b+=3)if(K(Nt,b,d,p),Nt.needsUpdate=!0,Vt.intersectsTriangle(Nt))return!0}}else{const l=r+8,c=a[r+6];return Q(l,n,Ve),!!(i.intersectsBox(Ve)&&Ls(l,t,e,s,i)||(Q(c,n,Ve),i.intersectsBox(Ve)&&Ls(c,t,e,s,i)))}}const Xe=new et,ms=new st,he=new st,wr=new O,xr=new O,vr=new O,br=new O;function Er(r,t,e,s={},i={},n=0,o=1/0){t.boundingBox||t.computeBoundingBox(),ms.set(t.boundingBox.min,t.boundingBox.max,e),ms.needsUpdate=!0;const a=r.geometry,h=a.attributes.position,l=a.index,c=t.attributes.position,u=t.index,d=lt.getPrimitive(),p=lt.getPrimitive();let y=wr,g=xr,f=null,_=null;i&&(f=vr,_=br);let w=1/0,b=null,m=null;return Xe.copy(e).invert(),he.matrix.copy(Xe),r.shapecast({boundsTraverseOrder:x=>ms.distanceToBox(x),intersectsBounds:(x,P,E)=>E<w&&E<o?(P&&(he.min.copy(x.min),he.max.copy(x.max),he.needsUpdate=!0),!0):!1,intersectsRange:(x,P)=>{if(t.boundsTree){const E=t.boundsTree;return E.shapecast({boundsTraverseOrder:T=>he.distanceToBox(T),intersectsBounds:(T,M,A)=>A<w&&A<o,intersectsRange:(T,M)=>{for(let A=T,S=T+M;A<S;A++){const D=E.resolveTriangleIndex(A);K(p,3*D,u,c),p.a.applyMatrix4(e),p.b.applyMatrix4(e),p.c.applyMatrix4(e),p.needsUpdate=!0;for(let B=x,z=x+P;B<z;B++){const H=r.resolveTriangleIndex(B);K(d,3*H,l,h),d.needsUpdate=!0;const Z=d.distanceToTriangle(p,y,f);if(Z<w&&(g.copy(y),_&&_.copy(f),w=Z,b=B,m=A),Z<n)return!0}}}})}else{const E=te(t);for(let T=0,M=E;T<M;T++){K(p,3*T,u,c),p.a.applyMatrix4(e),p.b.applyMatrix4(e),p.c.applyMatrix4(e),p.needsUpdate=!0;for(let A=x,S=x+P;A<S;A++){const D=r.resolveTriangleIndex(A);K(d,3*D,l,h),d.needsUpdate=!0;const B=d.distanceToTriangle(p,y,f);if(B<w&&(g.copy(y),_&&_.copy(f),w=B,b=A,m=T),B<n)return!0}}}}}),lt.releasePrimitive(d),lt.releasePrimitive(p),w===1/0?null:(s.point?s.point.copy(g):s.point=g.clone(),s.distance=w,s.faceIndex=b,i&&(i.point?i.point.copy(_):i.point=_.clone(),i.point.applyMatrix4(Xe),g.applyMatrix4(Xe),i.distance=g.sub(i.point).length(),i.faceIndex=m),s)}function Tr(){return typeof SharedArrayBuffer<"u"}const xe=new X.constructor,is=new X.constructor,Ot=new Xs(()=>new ot),Xt=new ot,Wt=new ot,fs=new ot,_s=new ot;let gs=!1;function Pr(r,t,e,s){if(gs)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");gs=!0;const i=r._roots,n=t._roots;let o,a=0,h=0;const l=new et().copy(e).invert();for(let c=0,u=i.length;c<u;c++){xe.setBuffer(i[c]),h=0;const d=Ot.getPrimitive();Q(0,xe.float32Array,d),d.applyMatrix4(l);for(let p=0,y=n.length;p<y&&(is.setBuffer(n[c]),o=pt(0,0,e,l,s,a,h,0,0,d),is.clearBuffer(),h+=n[p].length,!o);p++);if(Ot.releasePrimitive(d),xe.clearBuffer(),a+=i[c].length,o)break}return gs=!1,o}function pt(r,t,e,s,i,n=0,o=0,a=0,h=0,l=null,c=!1){let u,d;c?(u=is,d=xe):(u=xe,d=is);const p=u.float32Array,y=u.uint32Array,g=u.uint16Array,f=d.float32Array,_=d.uint32Array,w=d.uint16Array,b=r*2,m=t*2,x=nt(b,g),P=nt(m,w);let E=!1;if(P&&x)c?E=i(rt(t,_),ct(t*2,w),rt(r,y),ct(r*2,g),h,o+t,a,n+r):E=i(rt(r,y),ct(r*2,g),rt(t,_),ct(t*2,w),a,n+r,h,o+t);else if(P){const T=Ot.getPrimitive();Q(t,f,T),T.applyMatrix4(e);const M=dt(r),A=ut(r,y);Q(M,p,Xt),Q(A,p,Wt);const S=T.intersectsBox(Xt),D=T.intersectsBox(Wt);E=S&&pt(t,M,s,e,i,o,n,h,a+1,T,!c)||D&&pt(t,A,s,e,i,o,n,h,a+1,T,!c),Ot.releasePrimitive(T)}else{const T=dt(t),M=ut(t,_);Q(T,f,fs),Q(M,f,_s);const A=l.intersectsBox(fs),S=l.intersectsBox(_s);if(A&&S)E=pt(r,T,e,s,i,n,o,a,h+1,l,c)||pt(r,M,e,s,i,n,o,a,h+1,l,c);else if(A)if(x)E=pt(r,T,e,s,i,n,o,a,h+1,l,c);else{const D=Ot.getPrimitive();D.copy(fs).applyMatrix4(e);const B=dt(r),z=ut(r,y);Q(B,p,Xt),Q(z,p,Wt);const H=D.intersectsBox(Xt),Z=D.intersectsBox(Wt);E=H&&pt(T,B,s,e,i,o,n,h,a+1,D,!c)||Z&&pt(T,z,s,e,i,o,n,h,a+1,D,!c),Ot.releasePrimitive(D)}else if(S)if(x)E=pt(r,M,e,s,i,n,o,a,h+1,l,c);else{const D=Ot.getPrimitive();D.copy(_s).applyMatrix4(e);const B=dt(r),z=ut(r,y);Q(B,p,Xt),Q(z,p,Wt);const H=D.intersectsBox(Xt),Z=D.intersectsBox(Wt);E=H&&pt(M,B,s,e,i,o,n,h,a+1,D,!c)||Z&&pt(M,z,s,e,i,o,n,h,a+1,D,!c),Ot.releasePrimitive(D)}}return E}const We=new st,mi=new ot;class Ws{static serialize(t,e={}){e={cloneBuffers:!0,...e};const s=t.geometry,i=t._roots,n=t._indirectBuffer,o=s.getIndex();let a;return e.cloneBuffers?a={roots:i.map(h=>h.slice()),index:o.array.slice(),indirectBuffer:n?n.slice():null}:a={roots:i,index:o.array,indirectBuffer:n},a}static deserialize(t,e,s={}){s={setIndex:!0,indirect:!!t.indirectBuffer,...s};const{index:i,roots:n,indirectBuffer:o}=t,a=new Ws(e,{...s,[ls]:!0});if(a._roots=n,a._indirectBuffer=o||null,s.setIndex){const h=e.getIndex();if(h===null){const l=new Hi(t.index,1,!1);e.setIndex(l)}else h.array!==i&&(h.array.set(i),h.needsUpdate=!0)}return a}get indirect(){return!!this._indirectBuffer}constructor(t,e={}){if(t.isBufferGeometry){if(t.index&&t.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("MeshBVH: Only BufferGeometries are supported.");if(e=Object.assign({strategy:Yi,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,[ls]:!1},e),e.useSharedArrayBuffer&&!Tr())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=t,this._roots=null,this._indirectBuffer=null,e[ls]||(Zn(this,e),!t.boundingBox&&e.setBoundingBox&&(t.boundingBox=this.getBoundingBox(new ot)));const{_indirectBuffer:s}=this;this.resolveTriangleIndex=e.indirect?i=>s[i]:i=>i}refit(t=null){return(this.indirect?mr:er)(this,t)}traverse(t,e=0){const s=this._roots[e],i=new Uint32Array(s),n=new Uint16Array(s);o(0);function o(a,h=0){const l=a*2,c=n[l+15]===rs;if(c){const u=i[a+6],d=n[l+14];t(h,c,new Float32Array(s,a*4,6),u,d)}else{const u=a+ts/4,d=i[a+6],p=i[a+7];t(h,c,new Float32Array(s,a*4,6),p)||(o(u,h+1),o(d,h+1))}}}raycast(t,e=Gs){const s=this._roots,i=this.geometry,n=[],o=e.isMaterial,a=Array.isArray(e),h=i.groups,l=o?e.side:e,c=this.indirect?fr:rr;for(let u=0,d=s.length;u<d;u++){const p=a?e[h[u].materialIndex].side:l,y=n.length;if(c(this,u,p,t,n),a){const g=h[u].materialIndex;for(let f=y,_=n.length;f<_;f++)n[f].face.materialIndex=g}}return n}raycastFirst(t,e=Gs){const s=this._roots,i=this.geometry,n=e.isMaterial,o=Array.isArray(e);let a=null;const h=i.groups,l=n?e.side:e,c=this.indirect?gr:ar;for(let u=0,d=s.length;u<d;u++){const p=o?e[h[u].materialIndex].side:l,y=c(this,u,p,t);y!=null&&(a==null||y.distance<a.distance)&&(a=y,o&&(y.face.materialIndex=h[u].materialIndex))}return a}intersectsGeometry(t,e){let s=!1;const i=this._roots,n=this.indirect?yr:hr;for(let o=0,a=i.length;o<a&&(s=n(this,o,t,e),!s);o++);return s}shapecast(t){const e=lt.getPrimitive(),s=this.indirect?nr:tr;let{boundsTraverseOrder:i,intersectsBounds:n,intersectsRange:o,intersectsTriangle:a}=t;if(o&&a){const u=o;o=(d,p,y,g,f)=>u(d,p,y,g,f)?!0:s(d,p,this,a,y,g,e)}else o||(a?o=(u,d,p,y)=>s(u,d,this,a,p,y,e):o=(u,d,p)=>p);let h=!1,l=0;const c=this._roots;for(let u=0,d=c.length;u<d;u++){const p=c[u];if(h=qn(this,u,n,o,i,l),h)break;l+=p.byteLength}return lt.releasePrimitive(e),h}bvhcast(t,e,s){let{intersectsRanges:i,intersectsTriangles:n}=s;const o=lt.getPrimitive(),a=this.geometry.index,h=this.geometry.attributes.position,l=this.indirect?y=>{const g=this.resolveTriangleIndex(y);K(o,g*3,a,h)}:y=>{K(o,y*3,a,h)},c=lt.getPrimitive(),u=t.geometry.index,d=t.geometry.attributes.position,p=t.indirect?y=>{const g=t.resolveTriangleIndex(y);K(c,g*3,u,d)}:y=>{K(c,y*3,u,d)};if(n){const y=(g,f,_,w,b,m,x,P)=>{for(let E=_,T=_+w;E<T;E++){p(E),c.a.applyMatrix4(e),c.b.applyMatrix4(e),c.c.applyMatrix4(e),c.needsUpdate=!0;for(let M=g,A=g+f;M<A;M++)if(l(M),o.needsUpdate=!0,n(o,c,M,E,b,m,x,P))return!0}return!1};if(i){const g=i;i=function(f,_,w,b,m,x,P,E){return g(f,_,w,b,m,x,P,E)?!0:y(f,_,w,b,m,x,P,E)}}else i=y}return Pr(this,t,e,i)}intersectsBox(t,e){return We.set(t.min,t.max,e),We.needsUpdate=!0,this.shapecast({intersectsBounds:s=>We.intersectsBox(s),intersectsTriangle:s=>We.intersectsTriangle(s)})}intersectsSphere(t){return this.shapecast({intersectsBounds:e=>t.intersectsBox(e),intersectsTriangle:e=>e.intersectsSphere(t)})}closestPointToGeometry(t,e,s={},i={},n=0,o=1/0){return(this.indirect?Er:pr)(this,t,e,s,i,n,o)}closestPointToPoint(t,e={},s=0,i=1/0){return Kn(this,t,e,s,i)}getBoundingBox(t){return t.makeEmpty(),this._roots.forEach(e=>{Q(0,new Float32Array(e),mi),t.union(mi)}),t}}function fi(r,t,e){return r===null||(r.point.applyMatrix4(t.matrixWorld),r.distance=r.point.distanceTo(e.ray.origin),r.object=t,r.distance<e.near||r.distance>e.far)?null:r}const ys=new yn,_i=new et,Cr=U.prototype.raycast;function Mr(r,t){if(this.geometry.boundsTree){if(this.material===void 0)return;_i.copy(this.matrixWorld).invert(),ys.copy(r.ray).applyMatrix4(_i);const e=this.geometry.boundsTree;if(r.firstHitOnly===!0){const s=fi(e.raycastFirst(ys,this.material),this,r);s&&t.push(s)}else{const s=e.raycast(ys,this.material);for(let i=0,n=s.length;i<n;i++){const o=fi(s[i],this,r);o&&t.push(o)}}}else Cr.call(this,r,t)}function Or(r){return this.boundsTree=new Ws(this,r),this.boundsTree}function Ar(){this.boundsTree=null}class I{constructor(){v(this,"trigger",t=>{const e=this.handlers.slice(0);for(const s of e)s(t)}),v(this,"handlers",[])}add(t){this.handlers.push(t)}remove(t){this.handlers=this.handlers.filter(e=>e!==t)}reset(){this.handlers.length=0}}class Qs{constructor(t){v(this,"isDisposeable",()=>"dispose"in this&&"onDisposed"in this),v(this,"isResizeable",()=>"resize"in this&&"getSize"in this),v(this,"isUpdateable",()=>"onAfterUpdate"in this&&"onBeforeUpdate"in this&&"update"in this),v(this,"isHideable",()=>"visible"in this),v(this,"isConfigurable",()=>"setup"in this&&"config"in this&&"onSetup"in this),this.components=t}}class St extends Qs{}class qs extends Qs{constructor(t){super(t),v(this,"worlds",new Map),v(this,"onWorldChanged",new I),v(this,"currentWorld",null),this.onWorldChanged.add(({world:e,action:s})=>{s==="removed"&&this.worlds.delete(e.uuid)})}}class Dr extends qs{constructor(){super(...arguments),v(this,"hasCameraControls",()=>"controls"in this)}}class Sr extends qs{constructor(){super(...arguments),v(this,"onAfterUpdate",new I),v(this,"onBeforeUpdate",new I),v(this,"onDisposed",new I),v(this,"onResize",new I),v(this,"onClippingPlanesUpdated",new I),v(this,"clippingPlanes",[])}updateClippingPlanes(){this.onClippingPlanesUpdated.trigger()}setPlane(t,e,s){e.isLocal=s;const i=this.clippingPlanes.indexOf(e);t&&i===-1?this.clippingPlanes.push(e):!t&&i>-1&&this.clippingPlanes.splice(i,1),this.three.clippingPlanes=this.clippingPlanes.filter(n=>!n.isLocal)}}const Xi=class zs extends St{constructor(t){super(t),v(this,"_disposedComponents",new Set),v(this,"enabled",!0),t.add(zs.uuid,this)}get(){return this._disposedComponents}destroy(t,e=!0,s=!0){t.removeFromParent();const i=t;i.dispose&&i.dispose(),this.disposeGeometryAndMaterials(t,e),s&&i.children&&i.children.length&&this.disposeChildren(i),t.children.length=0}disposeGeometry(t){const e=t;e.boundsTree&&e.disposeBoundsTree(),t.dispose()}disposeGeometryAndMaterials(t,e){const s=t;s.geometry&&this.disposeGeometry(s.geometry),e&&s.material&&zs.disposeMaterial(s),s.material=[],s.geometry=null}disposeChildren(t){for(const e of t.children)this.destroy(e)}static disposeMaterial(t){if(t.material)if(Array.isArray(t.material))for(const e of t.material)e.dispose();else t.material.dispose()}};v(Xi,"uuid","76e9cd8e-ad8f-4753-9ef6-cbc60f7247fe");let Te=Xi;class Ur extends qs{constructor(t){super(t),v(this,"onDisposed",new I)}dispose(){const t=this.components.get(Te);for(const e of this.three.children){const s=e;s.geometry&&t.destroy(s)}this.three.children=[],this.onDisposed.trigger(),this.onDisposed.reset()}}const Fs=class j{static create(){const t=Math.random()*4294967295|0,e=Math.random()*4294967295|0,s=Math.random()*4294967295|0,i=Math.random()*4294967295|0;return`${j._lut[t&255]+j._lut[t>>8&255]+j._lut[t>>16&255]+j._lut[t>>24&255]}-${j._lut[e&255]}${j._lut[e>>8&255]}-${j._lut[e>>16&15|64]}${j._lut[e>>24&255]}-${j._lut[s&63|128]}${j._lut[s>>8&255]}-${j._lut[s>>16&255]}${j._lut[s>>24&255]}${j._lut[i&255]}${j._lut[i>>8&255]}${j._lut[i>>16&255]}${j._lut[i>>24&255]}`.toLowerCase()}static validate(t){if(!j._pattern.test(t))throw new Error(`${t} is not a valid UUID v4.

- If you're the tool creator, you can take one from https://www.uuidgenerator.net/.

- If you're using a platform tool, verify the uuid isn't misspelled or contact the tool creator.`)}};v(Fs,"_pattern",/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-4[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/),v(Fs,"_lut",["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"]);let Wi=Fs;class gi{static isTransparent(t){return t.transparent&&t.opacity<1}}const Qi=class qi{constructor(){v(this,"onDisposed",new I),v(this,"list",new Map),v(this,"enabled",!1),v(this,"_clock"),v(this,"update",()=>{if(!this.enabled)return;const t=this._clock.getDelta();for(const[e,s]of this.list)s.enabled&&s.isUpdateable()&&s.update(t);requestAnimationFrame(this.update)}),this._clock=new fn,qi.setupBVH()}add(t,e){if(this.list.has(t))throw new Error("You're trying to add a component that already exists in the components intance. Use Components.get() instead.");Wi.validate(t),this.list.set(t,e)}get(t){const e=t.uuid;if(!this.list.has(e)){const s=new t(this);return this.list.has(e)||this.add(e,s),s}return this.list.get(e)}init(){this.enabled=!0,this._clock.start(),this.update()}dispose(){this.enabled=!1;for(const[t,e]of this.list)e.enabled=!1,e.isDisposeable()&&e.dispose();this._clock.stop(),this.onDisposed.trigger(),this.onDisposed.reset()}static setupBVH(){ss.prototype.computeBoundsTree=Or,ss.prototype.disposeBoundsTree=Ar,U.prototype.raycast=Mr}};v(Qi,"release","1.4.21");let Br=Qi;class Lr{constructor(t){v(this,"_event"),v(this,"_position",new _t),v(this,"onDisposed",new I),v(this,"updateMouseInfo",e=>{this._event=e}),this.dom=t,this.setupEvents(!0)}get position(){if(this._event){const t=this.dom.getBoundingClientRect();this._position.x=this.getPositionX(t,this._event),this._position.y=this.getPositionY(t,this._event)}return this._position}dispose(){this.setupEvents(!1),this.onDisposed.trigger(),this.onDisposed.reset()}getPositionY(t,e){return-((e.clientY-t.top)/(t.bottom-t.top))*2+1}getPositionX(t,e){return(e.clientX-t.left)/(t.right-t.left)*2-1}setupEvents(t){t?this.dom.addEventListener("mousemove",this.updateMouseInfo):this.dom.removeEventListener("mousemove",this.updateMouseInfo)}}class zr{constructor(t,e){v(this,"enabled",!0),v(this,"components"),v(this,"onDisposed",new I),v(this,"mouse"),v(this,"three",new Ys),v(this,"world");const s=e.renderer;if(!s)throw new Error("A renderer is needed for the raycaster to work!");this.world=e,this.mouse=new Lr(s.three.domElement),this.components=t}dispose(){this.mouse.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}castRay(t=Array.from(this.world.meshes)){if(!this.world)throw new Error("A world is needed to cast rays!");const e=this.world.camera.three;return this.three.setFromCamera(this.mouse.position,e),this.intersect(t)}castRayFromVector(t,e,s=Array.from(this.world.meshes)){return this.three.set(t,e),this.intersect(s)}intersect(t=Array.from(this.world.meshes)){const e=this.three.intersectObjects(t),s=this.filterClippingPlanes(e);return s.length>0?s[0]:null}filterClippingPlanes(t){if(!this.world.renderer)throw new Error("Renderer not found!");const e=this.world.renderer.three;if(!e.clippingPlanes)return t;const s=e.clippingPlanes;return t.length<=0||!s||(s==null?void 0:s.length)<=0?t:t.filter(i=>s.every(n=>n.distanceToPoint(i.point)>0))}}const Ki=class ji extends St{constructor(t){super(t),v(this,"enabled",!0),v(this,"list",new Map),v(this,"onDisposed",new I),t.add(ji.uuid,this)}get(t){if(this.list.has(t.uuid))return this.list.get(t.uuid);const e=new zr(this.components,t);return this.list.set(t.uuid,e),t.onDisposed.add(()=>{this.delete(t)}),e}delete(t){const e=this.list.get(t.uuid);e&&e.dispose(),this.list.delete(t.uuid)}dispose(){for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger()}};v(Ki,"uuid","d5d8bdf0-db25-4952-b951-b643af207ace");let yi=Ki;class Fr extends Qs{constructor(t){super(t),v(this,"meshes",new Set),v(this,"onAfterUpdate",new I),v(this,"onBeforeUpdate",new I),v(this,"enabled",!0),v(this,"uuid",Wi.create()),v(this,"onDisposed",new I),v(this,"_scene"),v(this,"_camera"),v(this,"_renderer",null)}get scene(){if(!this._scene)throw new Error("No scene initialized!");return this._scene}set scene(t){this._scene=t,t.worlds.set(this.uuid,this),t.currentWorld=this,t.onWorldChanged.trigger({world:this,action:"added"})}get camera(){if(!this._camera)throw new Error("No camera initialized!");return this._camera}set camera(t){this._camera=t,t.worlds.set(this.uuid,this),t.currentWorld=this,t.onWorldChanged.trigger({world:this,action:"added"})}get renderer(){return this._renderer}set renderer(t){this._renderer=t,t&&(t.worlds.set(this.uuid,this),t.currentWorld=this,t.onWorldChanged.trigger({world:this,action:"added"}))}update(t){this.enabled&&(!this._scene||!this._camera||(this.scene.currentWorld=this,this.camera.currentWorld=this,this.renderer&&(this.renderer.currentWorld=this),this.onBeforeUpdate.trigger(),this.scene.isUpdateable()&&this.scene.update(t),this.camera.isUpdateable()&&this.camera.update(t),this.renderer&&this.renderer.update(t),this.onAfterUpdate.trigger()))}dispose(t=!0){if(this.enabled=!1,this.scene.onWorldChanged.trigger({world:this,action:"removed"}),this.camera.onWorldChanged.trigger({world:this,action:"removed"}),this.renderer&&this.renderer.onWorldChanged.trigger({world:this,action:"removed"}),t){const e=this.components.get(Te);this.scene.dispose(),this.camera.isDisposeable()&&this.camera.dispose(),this.renderer&&this.renderer.dispose();for(const s of this.meshes)e.destroy(s);this.meshes.clear()}this._scene=null,this._camera=null,this._renderer=null,this.onDisposed.trigger()}}class Ir extends Ur{constructor(t){super(t),v(this,"isSetup",!1),v(this,"three"),v(this,"onSetup",new I),v(this,"config",{directionalLight:{color:new we("white"),intensity:1.5,position:new O(5,10,3)},ambientLight:{color:new we("white"),intensity:1}}),this.three=new ve,this.three.background=new we(2107698)}setup(t){this.config={...this.config,...t};const e=new hn(this.config.directionalLight.color,this.config.directionalLight.intensity);e.position.copy(this.config.directionalLight.position);const s=new ln(this.config.ambientLight.color,this.config.ambientLight.intensity);this.three.add(e,s),this.isSetup=!0,this.onSetup.trigger(this)}}class Rr extends Sr{constructor(t,e,s){super(t),v(this,"enabled",!0),v(this,"container"),v(this,"three"),v(this,"_canvas"),v(this,"_parameters"),v(this,"onContainerUpdated",new I),v(this,"resize",o=>{if(this.updateContainer(),!this.container)return;const a=o?o.x:this.container.clientWidth,h=o?o.y:this.container.clientHeight;this.three.setSize(a,h),this.onResize.trigger(new _t(a,h))}),v(this,"resizeEvent",()=>{this.resize()}),v(this,"onContextLost",o=>{o.preventDefault(),this.components.enabled=!1}),v(this,"onContextBack",()=>{this.three.setRenderTarget(null),this.three.dispose(),this.three=new Ms({canvas:this._canvas,antialias:!0,alpha:!0,...this._parameters}),this.components.enabled=!0}),this.container=e||null,this._parameters=s,this.three=new Ms({antialias:!0,alpha:!0,...s}),this.three.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.setupRenderer(),this.setupEvents(!0),this.resize(),this._canvas=this.three.domElement;const i=this.three.getContext(),{canvas:n}=i;n.addEventListener("webglcontextlost",this.onContextLost,!1),n.addEventListener("webglcontextrestored",this.onContextBack,!1)}update(){if(!this.enabled||!this.currentWorld)return;this.onBeforeUpdate.trigger(this);const t=this.currentWorld.scene.three,e=this.currentWorld.camera.three;this.three.render(t,e),this.onAfterUpdate.trigger(this)}dispose(){this.enabled=!1,this.setupEvents(!1),this.three.domElement.remove(),this.three.dispose(),this.onResize.reset(),this.onAfterUpdate.reset(),this.onBeforeUpdate.reset(),this.onDisposed.trigger(),this.onDisposed.reset()}getSize(){return new _t(this.three.domElement.clientWidth,this.three.domElement.clientHeight)}setupEvents(t){const e=this.three.domElement;t?e.addEventListener("resize",this.resizeEvent):e.removeEventListener("resize",this.resizeEvent)}setupRenderer(){this.three.localClippingEnabled=!0,this.container&&this.container.appendChild(this.three.domElement),this.updateContainer()}updateContainer(){if(!this.container){const t=this.three.domElement.parentElement;t&&(this.container=t,this.onContainerUpdated.trigger(t))}}}/*!
 * camera-controls
 * https://github.com/yomotsu/camera-controls
 * (c) 2017 @yomotsu
 * Released under the MIT License.
 */const F={LEFT:1,RIGHT:2,MIDDLE:4},C=Object.freeze({NONE:0,ROTATE:1,TRUCK:2,OFFSET:4,DOLLY:8,ZOOM:16,TOUCH_ROTATE:32,TOUCH_TRUCK:64,TOUCH_OFFSET:128,TOUCH_DOLLY:256,TOUCH_ZOOM:512,TOUCH_DOLLY_TRUCK:1024,TOUCH_DOLLY_OFFSET:2048,TOUCH_DOLLY_ROTATE:4096,TOUCH_ZOOM_TRUCK:8192,TOUCH_ZOOM_OFFSET:16384,TOUCH_ZOOM_ROTATE:32768}),Qt={NONE:0,IN:1,OUT:-1};function Ut(r){return r.isPerspectiveCamera}function Mt(r){return r.isOrthographicCamera}const qt=Math.PI*2,wi=Math.PI/2,Gi=1e-5,le=Math.PI/180;function mt(r,t,e){return Math.max(t,Math.min(e,r))}function N(r,t=Gi){return Math.abs(r)<t}function Y(r,t,e=Gi){return N(r-t,e)}function xi(r,t){return Math.round(r/t)*t}function ce(r){return isFinite(r)?r:r<0?-Number.MAX_VALUE:Number.MAX_VALUE}function de(r){return Math.abs(r)<Number.MAX_VALUE?r:r*(1/0)}function Qe(r,t,e,s,i=1/0,n){s=Math.max(1e-4,s);const o=2/s,a=o*n,h=1/(1+a+.48*a*a+.235*a*a*a);let l=r-t;const c=t,u=i*s;l=mt(l,-u,u),t=r-l;const d=(e.value+o*l)*n;e.value=(e.value-o*d)*h;let p=t+(l+d)*h;return c-r>0==p>c&&(p=c,e.value=(p-c)/n),p}function vi(r,t,e,s,i=1/0,n,o){s=Math.max(1e-4,s);const a=2/s,h=a*n,l=1/(1+h+.48*h*h+.235*h*h*h);let c=t.x,u=t.y,d=t.z,p=r.x-c,y=r.y-u,g=r.z-d;const f=c,_=u,w=d,b=i*s,m=b*b,x=p*p+y*y+g*g;if(x>m){const H=Math.sqrt(x);p=p/H*b,y=y/H*b,g=g/H*b}c=r.x-p,u=r.y-y,d=r.z-g;const P=(e.x+a*p)*n,E=(e.y+a*y)*n,T=(e.z+a*g)*n;e.x=(e.x-a*P)*l,e.y=(e.y-a*E)*l,e.z=(e.z-a*T)*l,o.x=c+(p+P)*l,o.y=u+(y+E)*l,o.z=d+(g+T)*l;const M=f-r.x,A=_-r.y,S=w-r.z,D=o.x-f,B=o.y-_,z=o.z-w;return M*D+A*B+S*z>0&&(o.x=f,o.y=_,o.z=w,e.x=(o.x-f)/n,e.y=(o.y-_)/n,e.z=(o.z-w)/n),o}function ws(r,t){t.set(0,0),r.forEach(e=>{t.x+=e.clientX,t.y+=e.clientY}),t.x/=r.length,t.y/=r.length}function xs(r,t){return Mt(r)?(console.warn(`${t} is not supported in OrthographicCamera`),!0):!1}class kr{constructor(){this._listeners={}}addEventListener(t,e){const s=this._listeners;s[t]===void 0&&(s[t]=[]),s[t].indexOf(e)===-1&&s[t].push(e)}hasEventListener(t,e){const s=this._listeners;return s[t]!==void 0&&s[t].indexOf(e)!==-1}removeEventListener(t,e){const s=this._listeners[t];if(s!==void 0){const i=s.indexOf(e);i!==-1&&s.splice(i,1)}}removeAllEventListeners(t){if(!t){this._listeners={};return}Array.isArray(this._listeners[t])&&(this._listeners[t].length=0)}dispatchEvent(t){const e=this._listeners[t.type];if(e!==void 0){t.target=this;const s=e.slice(0);for(let i=0,n=s.length;i<n;i++)s[i].call(this,t)}}}const Hr="2.7.3",qe=1/8,$i=typeof window<"u",Yr=$i&&/Mac/.test(navigator.platform),Zr=!($i&&"PointerEvent"in window);let L,bi,Ke,vs,it,R,k,Kt,ue,yt,wt,Bt,Ei,Ti,ht,pe,jt,Pi,bs,Ci,Es,Ts,je;class Pe extends kr{static install(t){L=t.THREE,bi=Object.freeze(new L.Vector3(0,0,0)),Ke=Object.freeze(new L.Vector3(0,1,0)),vs=Object.freeze(new L.Vector3(0,0,1)),it=new L.Vector2,R=new L.Vector3,k=new L.Vector3,Kt=new L.Vector3,ue=new L.Vector3,yt=new L.Vector3,wt=new L.Vector3,Bt=new L.Vector3,Ei=new L.Vector3,Ti=new L.Vector3,ht=new L.Spherical,pe=new L.Spherical,jt=new L.Box3,Pi=new L.Box3,bs=new L.Sphere,Ci=new L.Quaternion,Es=new L.Quaternion,Ts=new L.Matrix4,je=new L.Raycaster}static get ACTION(){return C}constructor(t,e){super(),this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.minDistance=Number.EPSILON,this.maxDistance=1/0,this.infinityDolly=!1,this.minZoom=.01,this.maxZoom=1/0,this.smoothTime=.25,this.draggingSmoothTime=.125,this.maxSpeed=1/0,this.azimuthRotateSpeed=1,this.polarRotateSpeed=1,this.dollySpeed=1,this.dollyDragInverted=!1,this.truckSpeed=2,this.dollyToCursor=!1,this.dragToOffset=!1,this.verticalDragToForward=!1,this.boundaryFriction=0,this.restThreshold=.01,this.colliderMeshes=[],this.cancel=()=>{},this._enabled=!0,this._state=C.NONE,this._viewport=null,this._changedDolly=0,this._changedZoom=0,this._hasRested=!0,this._boundaryEnclosesCamera=!1,this._needsUpdate=!0,this._updatedLastTime=!1,this._elementRect=new DOMRect,this._isDragging=!1,this._dragNeedsUpdate=!0,this._activePointers=[],this._lockedPointer=null,this._interactiveArea=new DOMRect(0,0,1,1),this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._isUserControllingOffset=!1,this._isUserControllingZoom=!1,this._lastDollyDirection=Qt.NONE,this._thetaVelocity={value:0},this._phiVelocity={value:0},this._radiusVelocity={value:0},this._targetVelocity=new L.Vector3,this._focalOffsetVelocity=new L.Vector3,this._zoomVelocity={value:0},this._truckInternal=(m,x,P)=>{let E,T;if(Ut(this._camera)){const M=R.copy(this._camera.position).sub(this._target),A=this._camera.getEffectiveFOV()*le,S=M.length()*Math.tan(A*.5);E=this.truckSpeed*m*S/this._elementRect.height,T=this.truckSpeed*x*S/this._elementRect.height}else if(Mt(this._camera)){const M=this._camera;E=m*(M.right-M.left)/M.zoom/this._elementRect.width,T=x*(M.top-M.bottom)/M.zoom/this._elementRect.height}else return;this.verticalDragToForward?(P?this.setFocalOffset(this._focalOffsetEnd.x+E,this._focalOffsetEnd.y,this._focalOffsetEnd.z,!0):this.truck(E,0,!0),this.forward(-T,!0)):P?this.setFocalOffset(this._focalOffsetEnd.x+E,this._focalOffsetEnd.y+T,this._focalOffsetEnd.z,!0):this.truck(E,T,!0)},this._rotateInternal=(m,x)=>{const P=qt*this.azimuthRotateSpeed*m/this._elementRect.height,E=qt*this.polarRotateSpeed*x/this._elementRect.height;this.rotate(P,E,!0)},this._dollyInternal=(m,x,P)=>{const E=Math.pow(.95,-m*this.dollySpeed),T=this._sphericalEnd.radius,M=this._sphericalEnd.radius*E,A=mt(M,this.minDistance,this.maxDistance),S=A-M;this.infinityDolly&&this.dollyToCursor?this._dollyToNoClamp(M,!0):this.infinityDolly&&!this.dollyToCursor?(this.dollyInFixed(S,!0),this._dollyToNoClamp(A,!0)):this._dollyToNoClamp(A,!0),this.dollyToCursor&&(this._changedDolly+=(this.infinityDolly?M:A)-T,this._dollyControlCoord.set(x,P)),this._lastDollyDirection=Math.sign(-m)},this._zoomInternal=(m,x,P)=>{const E=Math.pow(.95,m*this.dollySpeed),T=this._zoom,M=this._zoom*E;this.zoomTo(M,!0),this.dollyToCursor&&(this._changedZoom+=M-T,this._dollyControlCoord.set(x,P))},typeof L>"u"&&console.error("camera-controls: `THREE` is undefined. You must first run `CameraControls.install( { THREE: THREE } )`. Check the docs for further information."),this._camera=t,this._yAxisUpSpace=new L.Quaternion().setFromUnitVectors(this._camera.up,Ke),this._yAxisUpSpaceInverse=this._yAxisUpSpace.clone().invert(),this._state=C.NONE,this._target=new L.Vector3,this._targetEnd=this._target.clone(),this._focalOffset=new L.Vector3,this._focalOffsetEnd=this._focalOffset.clone(),this._spherical=new L.Spherical().setFromVector3(R.copy(this._camera.position).applyQuaternion(this._yAxisUpSpace)),this._sphericalEnd=this._spherical.clone(),this._lastDistance=this._spherical.radius,this._zoom=this._camera.zoom,this._zoomEnd=this._zoom,this._lastZoom=this._zoom,this._nearPlaneCorners=[new L.Vector3,new L.Vector3,new L.Vector3,new L.Vector3],this._updateNearPlaneCorners(),this._boundary=new L.Box3(new L.Vector3(-1/0,-1/0,-1/0),new L.Vector3(1/0,1/0,1/0)),this._cameraUp0=this._camera.up.clone(),this._target0=this._target.clone(),this._position0=this._camera.position.clone(),this._zoom0=this._zoom,this._focalOffset0=this._focalOffset.clone(),this._dollyControlCoord=new L.Vector2,this.mouseButtons={left:C.ROTATE,middle:C.DOLLY,right:C.TRUCK,wheel:Ut(this._camera)?C.DOLLY:Mt(this._camera)?C.ZOOM:C.NONE},this.touches={one:C.TOUCH_ROTATE,two:Ut(this._camera)?C.TOUCH_DOLLY_TRUCK:Mt(this._camera)?C.TOUCH_ZOOM_TRUCK:C.NONE,three:C.TOUCH_TRUCK};const s=new L.Vector2,i=new L.Vector2,n=new L.Vector2,o=m=>{if(!this._enabled||!this._domElement)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const E=this._domElement.getBoundingClientRect(),T=m.clientX/E.width,M=m.clientY/E.height;if(T<this._interactiveArea.left||T>this._interactiveArea.right||M<this._interactiveArea.top||M>this._interactiveArea.bottom)return}const x=m.pointerType!=="mouse"?null:(m.buttons&F.LEFT)===F.LEFT?F.LEFT:(m.buttons&F.MIDDLE)===F.MIDDLE?F.MIDDLE:(m.buttons&F.RIGHT)===F.RIGHT?F.RIGHT:null;if(x!==null){const E=this._findPointerByMouseButton(x);E&&this._disposePointer(E)}if((m.buttons&F.LEFT)===F.LEFT&&this._lockedPointer)return;const P={pointerId:m.pointerId,clientX:m.clientX,clientY:m.clientY,deltaX:0,deltaY:0,mouseButton:x};this._activePointers.push(P),this._domElement.ownerDocument.removeEventListener("pointermove",h,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",c),this._domElement.ownerDocument.addEventListener("pointermove",h,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",c),this._isDragging=!0,g(m)},a=m=>{if(!this._enabled||!this._domElement||this._lockedPointer)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const E=this._domElement.getBoundingClientRect(),T=m.clientX/E.width,M=m.clientY/E.height;if(T<this._interactiveArea.left||T>this._interactiveArea.right||M<this._interactiveArea.top||M>this._interactiveArea.bottom)return}const x=(m.buttons&F.LEFT)===F.LEFT?F.LEFT:(m.buttons&F.MIDDLE)===F.MIDDLE?F.MIDDLE:(m.buttons&F.RIGHT)===F.RIGHT?F.RIGHT:null;if(x!==null){const E=this._findPointerByMouseButton(x);E&&this._disposePointer(E)}const P={pointerId:1,clientX:m.clientX,clientY:m.clientY,deltaX:0,deltaY:0,mouseButton:(m.buttons&F.LEFT)===F.LEFT?F.LEFT:(m.buttons&F.MIDDLE)===F.LEFT?F.MIDDLE:(m.buttons&F.RIGHT)===F.LEFT?F.RIGHT:null};this._activePointers.push(P),this._domElement.ownerDocument.removeEventListener("mousemove",l),this._domElement.ownerDocument.removeEventListener("mouseup",u),this._domElement.ownerDocument.addEventListener("mousemove",l),this._domElement.ownerDocument.addEventListener("mouseup",u),this._isDragging=!0,g(m)},h=m=>{m.cancelable&&m.preventDefault();const x=m.pointerId,P=this._lockedPointer||this._findPointerById(x);if(P){if(P.clientX=m.clientX,P.clientY=m.clientY,P.deltaX=m.movementX,P.deltaY=m.movementY,this._state=0,m.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else(!this._isDragging&&this._lockedPointer||this._isDragging&&(m.buttons&F.LEFT)===F.LEFT)&&(this._state=this._state|this.mouseButtons.left),this._isDragging&&(m.buttons&F.MIDDLE)===F.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),this._isDragging&&(m.buttons&F.RIGHT)===F.RIGHT&&(this._state=this._state|this.mouseButtons.right);f()}},l=m=>{const x=this._lockedPointer||this._findPointerById(1);x&&(x.clientX=m.clientX,x.clientY=m.clientY,x.deltaX=m.movementX,x.deltaY=m.movementY,this._state=0,(this._lockedPointer||(m.buttons&F.LEFT)===F.LEFT)&&(this._state=this._state|this.mouseButtons.left),(m.buttons&F.MIDDLE)===F.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),(m.buttons&F.RIGHT)===F.RIGHT&&(this._state=this._state|this.mouseButtons.right),f())},c=m=>{const x=this._findPointerById(m.pointerId);if(!(x&&x===this._lockedPointer)){if(x&&this._disposePointer(x),m.pointerType==="touch")switch(this._activePointers.length){case 0:this._state=C.NONE;break;case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else this._state=C.NONE;_()}},u=()=>{const m=this._findPointerById(1);m&&m===this._lockedPointer||(m&&this._disposePointer(m),this._state=C.NONE,_())};let d=-1;const p=m=>{if(!this._domElement||!this._enabled||this.mouseButtons.wheel===C.NONE)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const M=this._domElement.getBoundingClientRect(),A=m.clientX/M.width,S=m.clientY/M.height;if(A<this._interactiveArea.left||A>this._interactiveArea.right||S<this._interactiveArea.top||S>this._interactiveArea.bottom)return}if(m.preventDefault(),this.dollyToCursor||this.mouseButtons.wheel===C.ROTATE||this.mouseButtons.wheel===C.TRUCK){const M=performance.now();d-M<1e3&&this._getClientRect(this._elementRect),d=M}const x=Yr?-1:-3,P=m.deltaMode===1?m.deltaY/x:m.deltaY/(x*10),E=this.dollyToCursor?(m.clientX-this._elementRect.x)/this._elementRect.width*2-1:0,T=this.dollyToCursor?(m.clientY-this._elementRect.y)/this._elementRect.height*-2+1:0;switch(this.mouseButtons.wheel){case C.ROTATE:{this._rotateInternal(m.deltaX,m.deltaY),this._isUserControllingRotate=!0;break}case C.TRUCK:{this._truckInternal(m.deltaX,m.deltaY,!1),this._isUserControllingTruck=!0;break}case C.OFFSET:{this._truckInternal(m.deltaX,m.deltaY,!0),this._isUserControllingOffset=!0;break}case C.DOLLY:{this._dollyInternal(-P,E,T),this._isUserControllingDolly=!0;break}case C.ZOOM:{this._zoomInternal(-P,E,T),this._isUserControllingZoom=!0;break}}this.dispatchEvent({type:"control"})},y=m=>{if(!(!this._domElement||!this._enabled)){if(this.mouseButtons.right===Pe.ACTION.NONE){const x=m instanceof PointerEvent?m.pointerId:0,P=this._findPointerById(x);P&&this._disposePointer(P),this._domElement.ownerDocument.removeEventListener("pointermove",h,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",c),this._domElement.ownerDocument.removeEventListener("mousemove",l),this._domElement.ownerDocument.removeEventListener("mouseup",u);return}m.preventDefault()}},g=m=>{if(this._enabled){if(ws(this._activePointers,it),this._getClientRect(this._elementRect),s.copy(it),i.copy(it),this._activePointers.length>=2){const x=it.x-this._activePointers[1].clientX,P=it.y-this._activePointers[1].clientY,E=Math.sqrt(x*x+P*P);n.set(0,E);const T=(this._activePointers[0].clientX+this._activePointers[1].clientX)*.5,M=(this._activePointers[0].clientY+this._activePointers[1].clientY)*.5;i.set(T,M)}if(this._state=0,!m)this._lockedPointer&&(this._state=this._state|this.mouseButtons.left);else if("pointerType"in m&&m.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else!this._lockedPointer&&(m.buttons&F.LEFT)===F.LEFT&&(this._state=this._state|this.mouseButtons.left),(m.buttons&F.MIDDLE)===F.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),(m.buttons&F.RIGHT)===F.RIGHT&&(this._state=this._state|this.mouseButtons.right);((this._state&C.ROTATE)===C.ROTATE||(this._state&C.TOUCH_ROTATE)===C.TOUCH_ROTATE||(this._state&C.TOUCH_DOLLY_ROTATE)===C.TOUCH_DOLLY_ROTATE||(this._state&C.TOUCH_ZOOM_ROTATE)===C.TOUCH_ZOOM_ROTATE)&&(this._sphericalEnd.theta=this._spherical.theta,this._sphericalEnd.phi=this._spherical.phi,this._thetaVelocity.value=0,this._phiVelocity.value=0),((this._state&C.TRUCK)===C.TRUCK||(this._state&C.TOUCH_TRUCK)===C.TOUCH_TRUCK||(this._state&C.TOUCH_DOLLY_TRUCK)===C.TOUCH_DOLLY_TRUCK||(this._state&C.TOUCH_ZOOM_TRUCK)===C.TOUCH_ZOOM_TRUCK)&&(this._targetEnd.copy(this._target),this._targetVelocity.set(0,0,0)),((this._state&C.DOLLY)===C.DOLLY||(this._state&C.TOUCH_DOLLY)===C.TOUCH_DOLLY||(this._state&C.TOUCH_DOLLY_TRUCK)===C.TOUCH_DOLLY_TRUCK||(this._state&C.TOUCH_DOLLY_OFFSET)===C.TOUCH_DOLLY_OFFSET||(this._state&C.TOUCH_DOLLY_ROTATE)===C.TOUCH_DOLLY_ROTATE)&&(this._sphericalEnd.radius=this._spherical.radius,this._radiusVelocity.value=0),((this._state&C.ZOOM)===C.ZOOM||(this._state&C.TOUCH_ZOOM)===C.TOUCH_ZOOM||(this._state&C.TOUCH_ZOOM_TRUCK)===C.TOUCH_ZOOM_TRUCK||(this._state&C.TOUCH_ZOOM_OFFSET)===C.TOUCH_ZOOM_OFFSET||(this._state&C.TOUCH_ZOOM_ROTATE)===C.TOUCH_ZOOM_ROTATE)&&(this._zoomEnd=this._zoom,this._zoomVelocity.value=0),((this._state&C.OFFSET)===C.OFFSET||(this._state&C.TOUCH_OFFSET)===C.TOUCH_OFFSET||(this._state&C.TOUCH_DOLLY_OFFSET)===C.TOUCH_DOLLY_OFFSET||(this._state&C.TOUCH_ZOOM_OFFSET)===C.TOUCH_ZOOM_OFFSET)&&(this._focalOffsetEnd.copy(this._focalOffset),this._focalOffsetVelocity.set(0,0,0)),this.dispatchEvent({type:"controlstart"})}},f=()=>{if(!this._enabled||!this._dragNeedsUpdate)return;this._dragNeedsUpdate=!1,ws(this._activePointers,it);const m=this._domElement&&document.pointerLockElement===this._domElement?this._lockedPointer||this._activePointers[0]:null,x=m?-m.deltaX:i.x-it.x,P=m?-m.deltaY:i.y-it.y;if(i.copy(it),((this._state&C.ROTATE)===C.ROTATE||(this._state&C.TOUCH_ROTATE)===C.TOUCH_ROTATE||(this._state&C.TOUCH_DOLLY_ROTATE)===C.TOUCH_DOLLY_ROTATE||(this._state&C.TOUCH_ZOOM_ROTATE)===C.TOUCH_ZOOM_ROTATE)&&(this._rotateInternal(x,P),this._isUserControllingRotate=!0),(this._state&C.DOLLY)===C.DOLLY||(this._state&C.ZOOM)===C.ZOOM){const E=this.dollyToCursor?(s.x-this._elementRect.x)/this._elementRect.width*2-1:0,T=this.dollyToCursor?(s.y-this._elementRect.y)/this._elementRect.height*-2+1:0,M=this.dollyDragInverted?-1:1;(this._state&C.DOLLY)===C.DOLLY?(this._dollyInternal(M*P*qe,E,T),this._isUserControllingDolly=!0):(this._zoomInternal(M*P*qe,E,T),this._isUserControllingZoom=!0)}if((this._state&C.TOUCH_DOLLY)===C.TOUCH_DOLLY||(this._state&C.TOUCH_ZOOM)===C.TOUCH_ZOOM||(this._state&C.TOUCH_DOLLY_TRUCK)===C.TOUCH_DOLLY_TRUCK||(this._state&C.TOUCH_ZOOM_TRUCK)===C.TOUCH_ZOOM_TRUCK||(this._state&C.TOUCH_DOLLY_OFFSET)===C.TOUCH_DOLLY_OFFSET||(this._state&C.TOUCH_ZOOM_OFFSET)===C.TOUCH_ZOOM_OFFSET||(this._state&C.TOUCH_DOLLY_ROTATE)===C.TOUCH_DOLLY_ROTATE||(this._state&C.TOUCH_ZOOM_ROTATE)===C.TOUCH_ZOOM_ROTATE){const E=it.x-this._activePointers[1].clientX,T=it.y-this._activePointers[1].clientY,M=Math.sqrt(E*E+T*T),A=n.y-M;n.set(0,M);const S=this.dollyToCursor?(i.x-this._elementRect.x)/this._elementRect.width*2-1:0,D=this.dollyToCursor?(i.y-this._elementRect.y)/this._elementRect.height*-2+1:0;(this._state&C.TOUCH_DOLLY)===C.TOUCH_DOLLY||(this._state&C.TOUCH_DOLLY_ROTATE)===C.TOUCH_DOLLY_ROTATE||(this._state&C.TOUCH_DOLLY_TRUCK)===C.TOUCH_DOLLY_TRUCK||(this._state&C.TOUCH_DOLLY_OFFSET)===C.TOUCH_DOLLY_OFFSET?(this._dollyInternal(A*qe,S,D),this._isUserControllingDolly=!0):(this._zoomInternal(A*qe,S,D),this._isUserControllingZoom=!0)}((this._state&C.TRUCK)===C.TRUCK||(this._state&C.TOUCH_TRUCK)===C.TOUCH_TRUCK||(this._state&C.TOUCH_DOLLY_TRUCK)===C.TOUCH_DOLLY_TRUCK||(this._state&C.TOUCH_ZOOM_TRUCK)===C.TOUCH_ZOOM_TRUCK)&&(this._truckInternal(x,P,!1),this._isUserControllingTruck=!0),((this._state&C.OFFSET)===C.OFFSET||(this._state&C.TOUCH_OFFSET)===C.TOUCH_OFFSET||(this._state&C.TOUCH_DOLLY_OFFSET)===C.TOUCH_DOLLY_OFFSET||(this._state&C.TOUCH_ZOOM_OFFSET)===C.TOUCH_ZOOM_OFFSET)&&(this._truckInternal(x,P,!0),this._isUserControllingOffset=!0),this.dispatchEvent({type:"control"})},_=()=>{ws(this._activePointers,it),i.copy(it),this._dragNeedsUpdate=!1,(this._activePointers.length===0||this._activePointers.length===1&&this._activePointers[0]===this._lockedPointer)&&(this._isDragging=!1),this._activePointers.length===0&&this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointermove",h,{passive:!1}),this._domElement.ownerDocument.removeEventListener("mousemove",l),this._domElement.ownerDocument.removeEventListener("pointerup",c),this._domElement.ownerDocument.removeEventListener("mouseup",u),this.dispatchEvent({type:"controlend"}))};this.lockPointer=()=>{!this._enabled||!this._domElement||(this.cancel(),this._lockedPointer={pointerId:-1,clientX:0,clientY:0,deltaX:0,deltaY:0,mouseButton:null},this._activePointers.push(this._lockedPointer),this._domElement.ownerDocument.removeEventListener("pointermove",h,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",c),this._domElement.requestPointerLock(),this._domElement.ownerDocument.addEventListener("pointerlockchange",w),this._domElement.ownerDocument.addEventListener("pointerlockerror",b),this._domElement.ownerDocument.addEventListener("pointermove",h,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",c),g())},this.unlockPointer=()=>{this._lockedPointer!==null&&(this._disposePointer(this._lockedPointer),this._lockedPointer=null),document.exitPointerLock(),this.cancel(),this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointerlockchange",w),this._domElement.ownerDocument.removeEventListener("pointerlockerror",b))};const w=()=>{this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement||this.unlockPointer()},b=()=>{this.unlockPointer()};this._addAllEventListeners=m=>{this._domElement=m,this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none",this._domElement.addEventListener("pointerdown",o),Zr&&this._domElement.addEventListener("mousedown",a),this._domElement.addEventListener("pointercancel",c),this._domElement.addEventListener("wheel",p,{passive:!1}),this._domElement.addEventListener("contextmenu",y)},this._removeAllEventListeners=()=>{this._domElement&&(this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect="",this._domElement.removeEventListener("pointerdown",o),this._domElement.removeEventListener("mousedown",a),this._domElement.removeEventListener("pointercancel",c),this._domElement.removeEventListener("wheel",p,{passive:!1}),this._domElement.removeEventListener("contextmenu",y),this._domElement.ownerDocument.removeEventListener("pointermove",h,{passive:!1}),this._domElement.ownerDocument.removeEventListener("mousemove",l),this._domElement.ownerDocument.removeEventListener("pointerup",c),this._domElement.ownerDocument.removeEventListener("mouseup",u),this._domElement.ownerDocument.removeEventListener("pointerlockchange",w),this._domElement.ownerDocument.removeEventListener("pointerlockerror",b))},this.cancel=()=>{this._state!==C.NONE&&(this._state=C.NONE,this._activePointers.length=0,_())},e&&this.connect(e),this.update(0)}get camera(){return this._camera}set camera(t){this._camera=t,this.updateCameraUp(),this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this._domElement&&(t?(this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none"):(this.cancel(),this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect=""))}get active(){return!this._hasRested}get currentAction(){return this._state}get distance(){return this._spherical.radius}set distance(t){this._spherical.radius===t&&this._sphericalEnd.radius===t||(this._spherical.radius=t,this._sphericalEnd.radius=t,this._needsUpdate=!0)}get azimuthAngle(){return this._spherical.theta}set azimuthAngle(t){this._spherical.theta===t&&this._sphericalEnd.theta===t||(this._spherical.theta=t,this._sphericalEnd.theta=t,this._needsUpdate=!0)}get polarAngle(){return this._spherical.phi}set polarAngle(t){this._spherical.phi===t&&this._sphericalEnd.phi===t||(this._spherical.phi=t,this._sphericalEnd.phi=t,this._needsUpdate=!0)}get boundaryEnclosesCamera(){return this._boundaryEnclosesCamera}set boundaryEnclosesCamera(t){this._boundaryEnclosesCamera=t,this._needsUpdate=!0}set interactiveArea(t){this._interactiveArea.width=mt(t.width,0,1),this._interactiveArea.height=mt(t.height,0,1),this._interactiveArea.x=mt(t.x,0,1-this._interactiveArea.width),this._interactiveArea.y=mt(t.y,0,1-this._interactiveArea.height)}addEventListener(t,e){super.addEventListener(t,e)}removeEventListener(t,e){super.removeEventListener(t,e)}rotate(t,e,s=!1){return this.rotateTo(this._sphericalEnd.theta+t,this._sphericalEnd.phi+e,s)}rotateAzimuthTo(t,e=!1){return this.rotateTo(t,this._sphericalEnd.phi,e)}rotatePolarTo(t,e=!1){return this.rotateTo(this._sphericalEnd.theta,t,e)}rotateTo(t,e,s=!1){this._isUserControllingRotate=!1;const i=mt(t,this.minAzimuthAngle,this.maxAzimuthAngle),n=mt(e,this.minPolarAngle,this.maxPolarAngle);this._sphericalEnd.theta=i,this._sphericalEnd.phi=n,this._sphericalEnd.makeSafe(),this._needsUpdate=!0,s||(this._spherical.theta=this._sphericalEnd.theta,this._spherical.phi=this._sphericalEnd.phi);const o=!s||Y(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Y(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold);return this._createOnRestPromise(o)}dolly(t,e=!1){return this.dollyTo(this._sphericalEnd.radius-t,e)}dollyTo(t,e=!1){return this._isUserControllingDolly=!1,this._lastDollyDirection=Qt.NONE,this._changedDolly=0,this._dollyToNoClamp(mt(t,this.minDistance,this.maxDistance),e)}_dollyToNoClamp(t,e=!1){const s=this._sphericalEnd.radius;if(this.colliderMeshes.length>=1){const n=this._collisionTest(),o=Y(n,this._spherical.radius);if(!(s>t)&&o)return Promise.resolve();this._sphericalEnd.radius=Math.min(t,n)}else this._sphericalEnd.radius=t;this._needsUpdate=!0,e||(this._spherical.radius=this._sphericalEnd.radius);const i=!e||Y(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(i)}dollyInFixed(t,e=!1){this._targetEnd.add(this._getCameraDirection(ue).multiplyScalar(t)),e||this._target.copy(this._targetEnd);const s=!e||Y(this._target.x,this._targetEnd.x,this.restThreshold)&&Y(this._target.y,this._targetEnd.y,this.restThreshold)&&Y(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(s)}zoom(t,e=!1){return this.zoomTo(this._zoomEnd+t,e)}zoomTo(t,e=!1){this._isUserControllingZoom=!1,this._zoomEnd=mt(t,this.minZoom,this.maxZoom),this._needsUpdate=!0,e||(this._zoom=this._zoomEnd);const s=!e||Y(this._zoom,this._zoomEnd,this.restThreshold);return this._changedZoom=0,this._createOnRestPromise(s)}pan(t,e,s=!1){return console.warn("`pan` has been renamed to `truck`"),this.truck(t,e,s)}truck(t,e,s=!1){this._camera.updateMatrix(),yt.setFromMatrixColumn(this._camera.matrix,0),wt.setFromMatrixColumn(this._camera.matrix,1),yt.multiplyScalar(t),wt.multiplyScalar(-e);const i=R.copy(yt).add(wt),n=k.copy(this._targetEnd).add(i);return this.moveTo(n.x,n.y,n.z,s)}forward(t,e=!1){R.setFromMatrixColumn(this._camera.matrix,0),R.crossVectors(this._camera.up,R),R.multiplyScalar(t);const s=k.copy(this._targetEnd).add(R);return this.moveTo(s.x,s.y,s.z,e)}elevate(t,e=!1){return R.copy(this._camera.up).multiplyScalar(t),this.moveTo(this._targetEnd.x+R.x,this._targetEnd.y+R.y,this._targetEnd.z+R.z,e)}moveTo(t,e,s,i=!1){this._isUserControllingTruck=!1;const n=R.set(t,e,s).sub(this._targetEnd);this._encloseToBoundary(this._targetEnd,n,this.boundaryFriction),this._needsUpdate=!0,i||this._target.copy(this._targetEnd);const o=!i||Y(this._target.x,this._targetEnd.x,this.restThreshold)&&Y(this._target.y,this._targetEnd.y,this.restThreshold)&&Y(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(o)}lookInDirectionOf(t,e,s,i=!1){const n=R.set(t,e,s).sub(this._targetEnd).normalize().multiplyScalar(-this._sphericalEnd.radius);return this.setPosition(n.x,n.y,n.z,i)}fitToBox(t,e,{cover:s=!1,paddingLeft:i=0,paddingRight:n=0,paddingBottom:o=0,paddingTop:a=0}={}){const h=[],l=t.isBox3?jt.copy(t):jt.setFromObject(t);l.isEmpty()&&(console.warn("camera-controls: fitTo() cannot be used with an empty box. Aborting"),Promise.resolve());const c=xi(this._sphericalEnd.theta,wi),u=xi(this._sphericalEnd.phi,wi);h.push(this.rotateTo(c,u,e));const d=R.setFromSpherical(this._sphericalEnd).normalize(),p=Ci.setFromUnitVectors(d,vs),y=Y(Math.abs(d.y),1);y&&p.multiply(Es.setFromAxisAngle(Ke,c)),p.multiply(this._yAxisUpSpaceInverse);const g=Pi.makeEmpty();k.copy(l.min).applyQuaternion(p),g.expandByPoint(k),k.copy(l.min).setX(l.max.x).applyQuaternion(p),g.expandByPoint(k),k.copy(l.min).setY(l.max.y).applyQuaternion(p),g.expandByPoint(k),k.copy(l.max).setZ(l.min.z).applyQuaternion(p),g.expandByPoint(k),k.copy(l.min).setZ(l.max.z).applyQuaternion(p),g.expandByPoint(k),k.copy(l.max).setY(l.min.y).applyQuaternion(p),g.expandByPoint(k),k.copy(l.max).setX(l.min.x).applyQuaternion(p),g.expandByPoint(k),k.copy(l.max).applyQuaternion(p),g.expandByPoint(k),g.min.x-=i,g.min.y-=o,g.max.x+=n,g.max.y+=a,p.setFromUnitVectors(vs,d),y&&p.premultiply(Es.invert()),p.premultiply(this._yAxisUpSpace);const f=g.getSize(R),_=g.getCenter(k).applyQuaternion(p);if(Ut(this._camera)){const w=this.getDistanceToFitBox(f.x,f.y,f.z,s);h.push(this.moveTo(_.x,_.y,_.z,e)),h.push(this.dollyTo(w,e)),h.push(this.setFocalOffset(0,0,0,e))}else if(Mt(this._camera)){const w=this._camera,b=w.right-w.left,m=w.top-w.bottom,x=s?Math.max(b/f.x,m/f.y):Math.min(b/f.x,m/f.y);h.push(this.moveTo(_.x,_.y,_.z,e)),h.push(this.zoomTo(x,e)),h.push(this.setFocalOffset(0,0,0,e))}return Promise.all(h)}fitToSphere(t,e){const s=[],i=t instanceof L.Sphere?bs.copy(t):Pe.createBoundingSphere(t,bs);if(s.push(this.moveTo(i.center.x,i.center.y,i.center.z,e)),Ut(this._camera)){const n=this.getDistanceToFitSphere(i.radius);s.push(this.dollyTo(n,e))}else if(Mt(this._camera)){const n=this._camera.right-this._camera.left,o=this._camera.top-this._camera.bottom,a=2*i.radius,h=Math.min(n/a,o/a);s.push(this.zoomTo(h,e))}return s.push(this.setFocalOffset(0,0,0,e)),Promise.all(s)}setLookAt(t,e,s,i,n,o,a=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=Qt.NONE,this._changedDolly=0;const h=k.set(i,n,o),l=R.set(t,e,s);this._targetEnd.copy(h),this._sphericalEnd.setFromVector3(l.sub(h).applyQuaternion(this._yAxisUpSpace)),this.normalizeRotations(),this._needsUpdate=!0,a||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const c=!a||Y(this._target.x,this._targetEnd.x,this.restThreshold)&&Y(this._target.y,this._targetEnd.y,this.restThreshold)&&Y(this._target.z,this._targetEnd.z,this.restThreshold)&&Y(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Y(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&Y(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(c)}lerpLookAt(t,e,s,i,n,o,a,h,l,c,u,d,p,y=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=Qt.NONE,this._changedDolly=0;const g=R.set(i,n,o),f=k.set(t,e,s);ht.setFromVector3(f.sub(g).applyQuaternion(this._yAxisUpSpace));const _=Kt.set(c,u,d),w=k.set(a,h,l);pe.setFromVector3(w.sub(_).applyQuaternion(this._yAxisUpSpace)),this._targetEnd.copy(g.lerp(_,p));const b=pe.theta-ht.theta,m=pe.phi-ht.phi,x=pe.radius-ht.radius;this._sphericalEnd.set(ht.radius+x*p,ht.phi+m*p,ht.theta+b*p),this.normalizeRotations(),this._needsUpdate=!0,y||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const P=!y||Y(this._target.x,this._targetEnd.x,this.restThreshold)&&Y(this._target.y,this._targetEnd.y,this.restThreshold)&&Y(this._target.z,this._targetEnd.z,this.restThreshold)&&Y(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Y(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&Y(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(P)}setPosition(t,e,s,i=!1){return this.setLookAt(t,e,s,this._targetEnd.x,this._targetEnd.y,this._targetEnd.z,i)}setTarget(t,e,s,i=!1){const n=this.getPosition(R),o=this.setLookAt(n.x,n.y,n.z,t,e,s,i);return this._sphericalEnd.phi=mt(this._sphericalEnd.phi,this.minPolarAngle,this.maxPolarAngle),o}setFocalOffset(t,e,s,i=!1){this._isUserControllingOffset=!1,this._focalOffsetEnd.set(t,e,s),this._needsUpdate=!0,i||this._focalOffset.copy(this._focalOffsetEnd);const n=!i||Y(this._focalOffset.x,this._focalOffsetEnd.x,this.restThreshold)&&Y(this._focalOffset.y,this._focalOffsetEnd.y,this.restThreshold)&&Y(this._focalOffset.z,this._focalOffsetEnd.z,this.restThreshold);return this._createOnRestPromise(n)}setOrbitPoint(t,e,s){this._camera.updateMatrixWorld(),yt.setFromMatrixColumn(this._camera.matrixWorldInverse,0),wt.setFromMatrixColumn(this._camera.matrixWorldInverse,1),Bt.setFromMatrixColumn(this._camera.matrixWorldInverse,2);const i=R.set(t,e,s),n=i.distanceTo(this._camera.position),o=i.sub(this._camera.position);yt.multiplyScalar(o.x),wt.multiplyScalar(o.y),Bt.multiplyScalar(o.z),R.copy(yt).add(wt).add(Bt),R.z=R.z+n,this.dollyTo(n,!1),this.setFocalOffset(-R.x,R.y,-R.z,!1),this.moveTo(t,e,s,!1)}setBoundary(t){if(!t){this._boundary.min.set(-1/0,-1/0,-1/0),this._boundary.max.set(1/0,1/0,1/0),this._needsUpdate=!0;return}this._boundary.copy(t),this._boundary.clampPoint(this._targetEnd,this._targetEnd),this._needsUpdate=!0}setViewport(t,e,s,i){if(t===null){this._viewport=null;return}this._viewport=this._viewport||new L.Vector4,typeof t=="number"?this._viewport.set(t,e,s,i):this._viewport.copy(t)}getDistanceToFitBox(t,e,s,i=!1){if(xs(this._camera,"getDistanceToFitBox"))return this._spherical.radius;const n=t/e,o=this._camera.getEffectiveFOV()*le,a=this._camera.aspect;return((i?n>a:n<a)?e:t/a)*.5/Math.tan(o*.5)+s*.5}getDistanceToFitSphere(t){if(xs(this._camera,"getDistanceToFitSphere"))return this._spherical.radius;const e=this._camera.getEffectiveFOV()*le,s=Math.atan(Math.tan(e*.5)*this._camera.aspect)*2,i=1<this._camera.aspect?e:s;return t/Math.sin(i*.5)}getTarget(t,e=!0){return(t&&t.isVector3?t:new L.Vector3).copy(e?this._targetEnd:this._target)}getPosition(t,e=!0){return(t&&t.isVector3?t:new L.Vector3).setFromSpherical(e?this._sphericalEnd:this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(e?this._targetEnd:this._target)}getSpherical(t,e=!0){return(t&&t instanceof L.Spherical?t:new L.Spherical).copy(e?this._sphericalEnd:this._spherical)}getFocalOffset(t,e=!0){return(t&&t.isVector3?t:new L.Vector3).copy(e?this._focalOffsetEnd:this._focalOffset)}normalizeRotations(){this._sphericalEnd.theta=this._sphericalEnd.theta%qt,this._sphericalEnd.theta<0&&(this._sphericalEnd.theta+=qt),this._spherical.theta+=qt*Math.round((this._sphericalEnd.theta-this._spherical.theta)/qt)}reset(t=!1){if(!Y(this._camera.up.x,this._cameraUp0.x)||!Y(this._camera.up.y,this._cameraUp0.y)||!Y(this._camera.up.z,this._cameraUp0.z)){this._camera.up.copy(this._cameraUp0);const s=this.getPosition(R);this.updateCameraUp(),this.setPosition(s.x,s.y,s.z)}const e=[this.setLookAt(this._position0.x,this._position0.y,this._position0.z,this._target0.x,this._target0.y,this._target0.z,t),this.setFocalOffset(this._focalOffset0.x,this._focalOffset0.y,this._focalOffset0.z,t),this.zoomTo(this._zoom0,t)];return Promise.all(e)}saveState(){this._cameraUp0.copy(this._camera.up),this.getTarget(this._target0),this.getPosition(this._position0),this._zoom0=this._zoom,this._focalOffset0.copy(this._focalOffset)}updateCameraUp(){this._yAxisUpSpace.setFromUnitVectors(this._camera.up,Ke),this._yAxisUpSpaceInverse.copy(this._yAxisUpSpace).invert()}applyCameraUp(){const t=R.subVectors(this._target,this._camera.position).normalize(),e=k.crossVectors(t,this._camera.up);this._camera.up.crossVectors(e,t).normalize(),this._camera.updateMatrixWorld();const s=this.getPosition(R);this.updateCameraUp(),this.setPosition(s.x,s.y,s.z)}update(t){const e=this._sphericalEnd.theta-this._spherical.theta,s=this._sphericalEnd.phi-this._spherical.phi,i=this._sphericalEnd.radius-this._spherical.radius,n=Ei.subVectors(this._targetEnd,this._target),o=Ti.subVectors(this._focalOffsetEnd,this._focalOffset),a=this._zoomEnd-this._zoom;if(N(e))this._thetaVelocity.value=0,this._spherical.theta=this._sphericalEnd.theta;else{const c=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.theta=Qe(this._spherical.theta,this._sphericalEnd.theta,this._thetaVelocity,c,1/0,t),this._needsUpdate=!0}if(N(s))this._phiVelocity.value=0,this._spherical.phi=this._sphericalEnd.phi;else{const c=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.phi=Qe(this._spherical.phi,this._sphericalEnd.phi,this._phiVelocity,c,1/0,t),this._needsUpdate=!0}if(N(i))this._radiusVelocity.value=0,this._spherical.radius=this._sphericalEnd.radius;else{const c=this._isUserControllingDolly?this.draggingSmoothTime:this.smoothTime;this._spherical.radius=Qe(this._spherical.radius,this._sphericalEnd.radius,this._radiusVelocity,c,this.maxSpeed,t),this._needsUpdate=!0}if(N(n.x)&&N(n.y)&&N(n.z))this._targetVelocity.set(0,0,0),this._target.copy(this._targetEnd);else{const c=this._isUserControllingTruck?this.draggingSmoothTime:this.smoothTime;vi(this._target,this._targetEnd,this._targetVelocity,c,this.maxSpeed,t,this._target),this._needsUpdate=!0}if(N(o.x)&&N(o.y)&&N(o.z))this._focalOffsetVelocity.set(0,0,0),this._focalOffset.copy(this._focalOffsetEnd);else{const c=this._isUserControllingOffset?this.draggingSmoothTime:this.smoothTime;vi(this._focalOffset,this._focalOffsetEnd,this._focalOffsetVelocity,c,this.maxSpeed,t,this._focalOffset),this._needsUpdate=!0}if(N(a))this._zoomVelocity.value=0,this._zoom=this._zoomEnd;else{const c=this._isUserControllingZoom?this.draggingSmoothTime:this.smoothTime;this._zoom=Qe(this._zoom,this._zoomEnd,this._zoomVelocity,c,1/0,t)}if(this.dollyToCursor){if(Ut(this._camera)&&this._changedDolly!==0){const c=this._spherical.radius-this._lastDistance,u=this._camera,d=this._getCameraDirection(ue),p=R.copy(d).cross(u.up).normalize();p.lengthSq()===0&&(p.x=1);const y=k.crossVectors(p,d),g=this._sphericalEnd.radius*Math.tan(u.getEffectiveFOV()*le*.5),f=(this._sphericalEnd.radius-c-this._sphericalEnd.radius)/this._sphericalEnd.radius,_=Kt.copy(this._targetEnd).add(p.multiplyScalar(this._dollyControlCoord.x*g*u.aspect)).add(y.multiplyScalar(this._dollyControlCoord.y*g)),w=R.copy(this._targetEnd).lerp(_,f),b=this._lastDollyDirection===Qt.IN&&this._spherical.radius<=this.minDistance,m=this._lastDollyDirection===Qt.OUT&&this.maxDistance<=this._spherical.radius;if(this.infinityDolly&&(b||m)){this._sphericalEnd.radius-=c,this._spherical.radius-=c;const P=k.copy(d).multiplyScalar(-c);w.add(P)}this._boundary.clampPoint(w,w);const x=k.subVectors(w,this._targetEnd);this._targetEnd.copy(w),this._target.add(x),this._changedDolly-=c,N(this._changedDolly)&&(this._changedDolly=0)}else if(Mt(this._camera)&&this._changedZoom!==0){const c=this._zoom-this._lastZoom,u=this._camera,d=R.set(this._dollyControlCoord.x,this._dollyControlCoord.y,(u.near+u.far)/(u.near-u.far)).unproject(u),p=k.set(0,0,-1).applyQuaternion(u.quaternion),y=Kt.copy(d).add(p.multiplyScalar(-d.dot(u.up))),g=-(this._zoom-c-this._zoom)/this._zoom,f=this._getCameraDirection(ue),_=this._targetEnd.dot(f),w=R.copy(this._targetEnd).lerp(y,g),b=w.dot(f),m=f.multiplyScalar(b-_);w.sub(m),this._boundary.clampPoint(w,w);const x=k.subVectors(w,this._targetEnd);this._targetEnd.copy(w),this._target.add(x),this._changedZoom-=c,N(this._changedZoom)&&(this._changedZoom=0)}}this._camera.zoom!==this._zoom&&(this._camera.zoom=this._zoom,this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0),this._dragNeedsUpdate=!0;const h=this._collisionTest();this._spherical.radius=Math.min(this._spherical.radius,h),this._spherical.makeSafe(),this._camera.position.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(this._target),this._camera.lookAt(this._target),(!N(this._focalOffset.x)||!N(this._focalOffset.y)||!N(this._focalOffset.z))&&(this._camera.updateMatrixWorld(),yt.setFromMatrixColumn(this._camera.matrix,0),wt.setFromMatrixColumn(this._camera.matrix,1),Bt.setFromMatrixColumn(this._camera.matrix,2),yt.multiplyScalar(this._focalOffset.x),wt.multiplyScalar(-this._focalOffset.y),Bt.multiplyScalar(this._focalOffset.z),R.copy(yt).add(wt).add(Bt),this._camera.position.add(R)),this._boundaryEnclosesCamera&&this._encloseToBoundary(this._camera.position.copy(this._target),R.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse),1);const l=this._needsUpdate;return l&&!this._updatedLastTime?(this._hasRested=!1,this.dispatchEvent({type:"wake"}),this.dispatchEvent({type:"update"})):l?(this.dispatchEvent({type:"update"}),N(e,this.restThreshold)&&N(s,this.restThreshold)&&N(i,this.restThreshold)&&N(n.x,this.restThreshold)&&N(n.y,this.restThreshold)&&N(n.z,this.restThreshold)&&N(o.x,this.restThreshold)&&N(o.y,this.restThreshold)&&N(o.z,this.restThreshold)&&N(a,this.restThreshold)&&!this._hasRested&&(this._hasRested=!0,this.dispatchEvent({type:"rest"}))):!l&&this._updatedLastTime&&this.dispatchEvent({type:"sleep"}),this._lastDistance=this._spherical.radius,this._lastZoom=this._zoom,this._updatedLastTime=l,this._needsUpdate=!1,l}toJSON(){return JSON.stringify({enabled:this._enabled,minDistance:this.minDistance,maxDistance:ce(this.maxDistance),minZoom:this.minZoom,maxZoom:ce(this.maxZoom),minPolarAngle:this.minPolarAngle,maxPolarAngle:ce(this.maxPolarAngle),minAzimuthAngle:ce(this.minAzimuthAngle),maxAzimuthAngle:ce(this.maxAzimuthAngle),smoothTime:this.smoothTime,draggingSmoothTime:this.draggingSmoothTime,dollySpeed:this.dollySpeed,truckSpeed:this.truckSpeed,dollyToCursor:this.dollyToCursor,verticalDragToForward:this.verticalDragToForward,target:this._targetEnd.toArray(),position:R.setFromSpherical(this._sphericalEnd).add(this._targetEnd).toArray(),zoom:this._zoomEnd,focalOffset:this._focalOffsetEnd.toArray(),target0:this._target0.toArray(),position0:this._position0.toArray(),zoom0:this._zoom0,focalOffset0:this._focalOffset0.toArray()})}fromJSON(t,e=!1){const s=JSON.parse(t);this.enabled=s.enabled,this.minDistance=s.minDistance,this.maxDistance=de(s.maxDistance),this.minZoom=s.minZoom,this.maxZoom=de(s.maxZoom),this.minPolarAngle=s.minPolarAngle,this.maxPolarAngle=de(s.maxPolarAngle),this.minAzimuthAngle=de(s.minAzimuthAngle),this.maxAzimuthAngle=de(s.maxAzimuthAngle),this.smoothTime=s.smoothTime,this.draggingSmoothTime=s.draggingSmoothTime,this.dollySpeed=s.dollySpeed,this.truckSpeed=s.truckSpeed,this.dollyToCursor=s.dollyToCursor,this.verticalDragToForward=s.verticalDragToForward,this._target0.fromArray(s.target0),this._position0.fromArray(s.position0),this._zoom0=s.zoom0,this._focalOffset0.fromArray(s.focalOffset0),this.moveTo(s.target[0],s.target[1],s.target[2],e),ht.setFromVector3(R.fromArray(s.position).sub(this._targetEnd).applyQuaternion(this._yAxisUpSpace)),this.rotateTo(ht.theta,ht.phi,e),this.dollyTo(ht.radius,e),this.zoomTo(s.zoom,e),this.setFocalOffset(s.focalOffset[0],s.focalOffset[1],s.focalOffset[2],e),this._needsUpdate=!0}connect(t){if(this._domElement){console.warn("camera-controls is already connected.");return}t.setAttribute("data-camera-controls-version",Hr),this._addAllEventListeners(t),this._getClientRect(this._elementRect)}disconnect(){this.cancel(),this._removeAllEventListeners(),this._domElement&&(this._domElement.removeAttribute("data-camera-controls-version"),this._domElement=void 0)}dispose(){this.removeAllEventListeners(),this.disconnect()}_getTargetDirection(t){return t.setFromSpherical(this._spherical).divideScalar(this._spherical.radius).applyQuaternion(this._yAxisUpSpaceInverse)}_getCameraDirection(t){return this._getTargetDirection(t).negate()}_findPointerById(t){return this._activePointers.find(e=>e.pointerId===t)}_findPointerByMouseButton(t){return this._activePointers.find(e=>e.mouseButton===t)}_disposePointer(t){this._activePointers.splice(this._activePointers.indexOf(t),1)}_encloseToBoundary(t,e,s){const i=e.lengthSq();if(i===0)return t;const n=k.copy(e).add(t),o=this._boundary.clampPoint(n,Kt).sub(n),a=o.lengthSq();if(a===0)return t.add(e);if(a===i)return t;if(s===0)return t.add(e).add(o);{const h=1+s*a/e.dot(o);return t.add(k.copy(e).multiplyScalar(h)).add(o.multiplyScalar(1-s))}}_updateNearPlaneCorners(){if(Ut(this._camera)){const t=this._camera,e=t.near,s=t.getEffectiveFOV()*le,i=Math.tan(s*.5)*e,n=i*t.aspect;this._nearPlaneCorners[0].set(-n,-i,0),this._nearPlaneCorners[1].set(n,-i,0),this._nearPlaneCorners[2].set(n,i,0),this._nearPlaneCorners[3].set(-n,i,0)}else if(Mt(this._camera)){const t=this._camera,e=1/t.zoom,s=t.left*e,i=t.right*e,n=t.top*e,o=t.bottom*e;this._nearPlaneCorners[0].set(s,n,0),this._nearPlaneCorners[1].set(i,n,0),this._nearPlaneCorners[2].set(i,o,0),this._nearPlaneCorners[3].set(s,o,0)}}_collisionTest(){let t=1/0;if(!(this.colliderMeshes.length>=1)||xs(this._camera,"_collisionTest"))return t;const e=this._getTargetDirection(ue);Ts.lookAt(bi,e,this._camera.up);for(let s=0;s<4;s++){const i=k.copy(this._nearPlaneCorners[s]);i.applyMatrix4(Ts);const n=Kt.addVectors(this._target,i);je.set(n,e),je.far=this._spherical.radius+1;const o=je.intersectObjects(this.colliderMeshes);o.length!==0&&o[0].distance<t&&(t=o[0].distance)}return t}_getClientRect(t){if(!this._domElement)return;const e=this._domElement.getBoundingClientRect();return t.x=e.left,t.y=e.top,this._viewport?(t.x+=this._viewport.x,t.y+=e.height-this._viewport.w-this._viewport.y,t.width=this._viewport.z,t.height=this._viewport.w):(t.width=e.width,t.height=e.height),t}_createOnRestPromise(t){return t?Promise.resolve():(this._hasRested=!1,this.dispatchEvent({type:"transitionstart"}),new Promise(e=>{const s=()=>{this.removeEventListener("rest",s),e()};this.addEventListener("rest",s)}))}_addAllEventListeners(t){}_removeAllEventListeners(){}get dampingFactor(){return console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead."),0}set dampingFactor(t){console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead.")}get draggingDampingFactor(){return console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead."),0}set draggingDampingFactor(t){console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead.")}static createBoundingSphere(t,e=new L.Sphere){const s=e,i=s.center;jt.makeEmpty(),t.traverseVisible(o=>{o.isMesh&&jt.expandByObject(o)}),jt.getCenter(i);let n=0;return t.traverseVisible(o=>{if(!o.isMesh)return;const a=o,h=a.geometry.clone();h.applyMatrix4(a.matrixWorld);const l=h.attributes.position;for(let c=0,u=l.count;c<u;c++)R.fromBufferAttribute(l,c),n=Math.max(n,i.distanceToSquared(R))}),s.radius=Math.sqrt(n),s}}class Ce extends Dr{constructor(t){super(t),v(this,"onBeforeUpdate",new I),v(this,"onAfterUpdate",new I),v(this,"onAspectUpdated",new I),v(this,"onDisposed",new I),v(this,"three"),v(this,"_allControls",new Map),v(this,"updateAspect",()=>{var e;if(!(!this.currentWorld||!this.currentWorld.renderer)&&(e=this.currentWorld.renderer)!=null&&e.isResizeable()){const s=this.currentWorld.renderer.getSize();this.three.aspect=s.width/s.height,this.three.updateProjectionMatrix(),this.onAspectUpdated.trigger()}}),this.three=this.setupCamera(),this.setupEvents(!0),this.onWorldChanged.add(({action:e,world:s})=>{if(e==="added"){const i=this.newCameraControls();this._allControls.set(s.uuid,i)}if(e==="removed"){const i=this._allControls.get(s.uuid);i&&(i.dispose(),this._allControls.delete(s.uuid))}})}get controls(){if(!this.currentWorld)throw new Error("This camera needs a world to work!");const t=this._allControls.get(this.currentWorld.uuid);if(!t)throw new Error("Controls not found!");return t}get enabled(){return this.currentWorld===null?!1:this.controls.enabled}set enabled(t){this.controls.enabled=t}dispose(){this.setupEvents(!1),this.enabled=!1,this.onAspectUpdated.reset(),this.onBeforeUpdate.reset(),this.onAfterUpdate.reset(),this.three.removeFromParent(),this.onDisposed.trigger(),this.onDisposed.reset();for(const[t,e]of this._allControls)e.dispose()}update(t){this.enabled&&(this.onBeforeUpdate.trigger(this),this.controls.update(t),this.onAfterUpdate.trigger(this))}setupCamera(){const t=window.innerWidth/window.innerHeight,e=new cn(60,t,1,1e3);return e.position.set(50,50,50),e.lookAt(new O(0,0,0)),e}newCameraControls(){if(!this.currentWorld)throw new Error("This camera needs a world to work!");if(!this.currentWorld.renderer)throw new Error("This camera needs a renderer to work!");Pe.install({THREE:Ce.getSubsetOfThree()});const{domElement:t}=this.currentWorld.renderer.three,e=new Pe(this.three,t);return e.smoothTime=.2,e.dollyToCursor=!0,e.infinityDolly=!0,e}setupEvents(t){t?window.addEventListener("resize",this.updateAspect):window.removeEventListener("resize",this.updateAspect)}static getSubsetOfThree(){return{MOUSE:dn,Vector2:_t,Vector3:O,Vector4:un,Quaternion:ft,Matrix4:et,Spherical:pn,Box3:ot,Sphere:ki,Raycaster:Ys,MathUtils:mn}}}const Ji=class tn extends St{constructor(t){super(t),v(this,"onAfterUpdate",new I),v(this,"onBeforeUpdate",new I),v(this,"onDisposed",new I),v(this,"list",new Map),v(this,"enabled",!0),t.add(tn.uuid,this)}create(){const t=new Fr(this.components),e=t.uuid;if(this.list.has(e))throw new Error("There is already a world with this name!");return this.list.set(e,t),t}delete(t){this.list.delete(t.uuid),t.dispose()}dispose(){this.enabled=!1;for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger()}update(t){if(this.enabled)for(const[e,s]of this.list)s.update(t)}};v(Ji,"uuid","fdb61dc4-2ec1-4966-b83d-54ea795fad4a");let en=Ji;class Vr{constructor(t,e,s){v(this,"onDisposed",new I),v(this,"world"),v(this,"components"),v(this,"_grid"),v(this,"_fade",3),v(this,"updateZoom",()=>{this.world.camera instanceof Ce&&(this.material.uniforms.uZoom.value=this.world.camera.three.zoom)}),this.world=e;const{color:i,size1:n,size2:o,distance:a}=s;this.components=t;const h=new Vs(2,2,1,1),l=new _n({side:Me,uniforms:{uSize1:{value:n},uSize2:{value:o},uColor:{value:i},uDistance:{value:a},uFade:{value:this._fade},uZoom:{value:1}},transparent:!0,vertexShader:`
            
            varying vec3 worldPosition;
            
            uniform float uDistance;
            
            void main() {
            
                    vec3 pos = position.xzy * uDistance;
                    pos.xz += cameraPosition.xz;
                    
                    worldPosition = pos;
                    
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
            
            }
            `,fragmentShader:`
            
            varying vec3 worldPosition;
            
            uniform float uZoom;
            uniform float uFade;
            uniform float uSize1;
            uniform float uSize2;
            uniform vec3 uColor;
            uniform float uDistance;
                
                
                
                float getGrid(float size) {
                
                    vec2 r = worldPosition.xz / size;
                    
                    
                    vec2 grid = abs(fract(r - 0.5) - 0.5) / fwidth(r);
                    float line = min(grid.x, grid.y);
                    
                
                    return 1.0 - min(line, 1.0);
                }
                
            void main() {
            
                    
                    float d = 1.0 - min(distance(cameraPosition.xz, worldPosition.xz) / uDistance, 1.0);
                    
                    float g1 = getGrid(uSize1);
                    float g2 = getGrid(uSize2);
                    
                    // Ortho camera fades the grid away when zooming out
                    float minZoom = step(0.2, uZoom);
                    float zoomFactor = pow(min(uZoom, 1.), 2.) * minZoom;
                    
                    gl_FragColor = vec4(uColor.rgb, mix(g2, g1, g1) * pow(d, uFade));
                    gl_FragColor.a = mix(0.5 * gl_FragColor.a, gl_FragColor.a, g2) * zoomFactor;
                    
                    if ( gl_FragColor.a <= 0.0 ) discard;
                    
            
            }
            
            `,extensions:{derivatives:!0}});this._grid=new U(h,l),this._grid.frustumCulled=!1,e.scene.three.add(this._grid),this.setupEvents(!0)}get visible(){return this._grid.visible}set visible(t){t?this.world.scene.three.add(this._grid):this._grid.removeFromParent()}get material(){return this._grid.material}get fade(){return this._fade===3}set fade(t){this._fade=t?3:0,this.material.uniforms.uFade.value=this._fade}[Symbol.dispose](){throw new Error("Method not implemented.")}get(){return this._grid}dispose(){this.setupEvents(!1),this.components.get(Te).destroy(this._grid),this.onDisposed.trigger(),this.onDisposed.reset(),this.world=null,this.components=null}setupEvents(t){if(!(this.world.camera instanceof Ce))return;const e=this.world.camera.controls;t?e.addEventListener("update",this.updateZoom):e.removeEventListener("update",this.updateZoom)}}class sn extends St{constructor(){super(...arguments),v(this,"list",new Map),v(this,"onDisposed",new I),v(this,"config",{color:new we(12303291),size1:1,size2:10,distance:500}),v(this,"enabled",!0)}create(t){if(this.list.has(t.uuid))throw new Error("This world already has a grid!");const e=new Vr(this.components,t,this.config);this.list.set(t.uuid,e),t.onDisposed.add(()=>{this.delete(t)})}delete(t){const e=this.list.get(t.uuid);e&&e.dispose(),this.list.delete(t.uuid)}dispose(){for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger()}}v(sn,"uuid","d1e814d5-b81c-4452-87a2-f039375e0489");const Lt=new Ys,J=new O,Ct=new O,W=new ft,Mi={X:new O(1,0,0),Y:new O(0,1,0),Z:new O(0,0,1)},Ps={type:"change"},Oi={type:"mouseDown"},Ai={type:"mouseUp",mode:null},Di={type:"objectChange"};class Nr extends Ee{constructor(t,e){super(),e===void 0&&(console.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.'),e=document),this.isTransformControls=!0,this.visible=!1,this.domElement=e,this.domElement.style.touchAction="none";const s=new jr;this._gizmo=s,this.add(s);const i=new Gr;this._plane=i,this.add(i);const n=this;function o(w,b){let m=b;Object.defineProperty(n,w,{get:function(){return m!==void 0?m:b},set:function(x){m!==x&&(m=x,i[w]=x,s[w]=x,n.dispatchEvent({type:w+"-changed",value:x}),n.dispatchEvent(Ps))}}),n[w]=b,i[w]=b,s[w]=b}o("camera",t),o("object",void 0),o("enabled",!0),o("axis",null),o("mode","translate"),o("translationSnap",null),o("rotationSnap",null),o("scaleSnap",null),o("space","world"),o("size",1),o("dragging",!1),o("showX",!0),o("showY",!0),o("showZ",!0);const a=new O,h=new O,l=new ft,c=new ft,u=new O,d=new ft,p=new O,y=new O,g=new O,f=0,_=new O;o("worldPosition",a),o("worldPositionStart",h),o("worldQuaternion",l),o("worldQuaternionStart",c),o("cameraPosition",u),o("cameraQuaternion",d),o("pointStart",p),o("pointEnd",y),o("rotationAxis",g),o("rotationAngle",f),o("eye",_),this._offset=new O,this._startNorm=new O,this._endNorm=new O,this._cameraScale=new O,this._parentPosition=new O,this._parentQuaternion=new ft,this._parentQuaternionInv=new ft,this._parentScale=new O,this._worldScaleStart=new O,this._worldQuaternionInv=new ft,this._worldScale=new O,this._positionStart=new O,this._quaternionStart=new ft,this._scaleStart=new O,this._getPointer=Xr.bind(this),this._onPointerDown=Qr.bind(this),this._onPointerHover=Wr.bind(this),this._onPointerMove=qr.bind(this),this._onPointerUp=Kr.bind(this),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp)}updateMatrixWorld(){this.object!==void 0&&(this.object.updateMatrixWorld(),this.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(this._parentPosition,this._parentQuaternion,this._parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this._worldScale),this._parentQuaternionInv.copy(this._parentQuaternion).invert(),this._worldQuaternionInv.copy(this.worldQuaternion).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this._cameraScale),this.camera.isOrthographicCamera?this.camera.getWorldDirection(this.eye).negate():this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize(),super.updateMatrixWorld(this)}pointerHover(t){if(this.object===void 0||this.dragging===!0)return;Lt.setFromCamera(t,this.camera);const e=Cs(this._gizmo.picker[this.mode],Lt);e?this.axis=e.object.name:this.axis=null}pointerDown(t){if(!(this.object===void 0||this.dragging===!0||t.button!==0)&&this.axis!==null){Lt.setFromCamera(t,this.camera);const e=Cs(this._plane,Lt,!0);e&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(e.point).sub(this.worldPositionStart)),this.dragging=!0,Oi.mode=this.mode,this.dispatchEvent(Oi)}}pointerMove(t){const e=this.axis,s=this.mode,i=this.object;let n=this.space;if(s==="scale"?n="local":(e==="E"||e==="XYZE"||e==="XYZ")&&(n="world"),i===void 0||e===null||this.dragging===!1||t.button!==-1)return;Lt.setFromCamera(t,this.camera);const o=Cs(this._plane,Lt,!0);if(o){if(this.pointEnd.copy(o.point).sub(this.worldPositionStart),s==="translate")this._offset.copy(this.pointEnd).sub(this.pointStart),n==="local"&&e!=="XYZ"&&this._offset.applyQuaternion(this._worldQuaternionInv),e.indexOf("X")===-1&&(this._offset.x=0),e.indexOf("Y")===-1&&(this._offset.y=0),e.indexOf("Z")===-1&&(this._offset.z=0),n==="local"&&e!=="XYZ"?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),i.position.copy(this._offset).add(this._positionStart),this.translationSnap&&(n==="local"&&(i.position.applyQuaternion(W.copy(this._quaternionStart).invert()),e.search("X")!==-1&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),e.search("Y")!==-1&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),e.search("Z")!==-1&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.position.applyQuaternion(this._quaternionStart)),n==="world"&&(i.parent&&i.position.add(J.setFromMatrixPosition(i.parent.matrixWorld)),e.search("X")!==-1&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),e.search("Y")!==-1&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),e.search("Z")!==-1&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.parent&&i.position.sub(J.setFromMatrixPosition(i.parent.matrixWorld))));else if(s==="scale"){if(e.search("XYZ")!==-1){let a=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(a*=-1),Ct.set(a,a,a)}else J.copy(this.pointStart),Ct.copy(this.pointEnd),J.applyQuaternion(this._worldQuaternionInv),Ct.applyQuaternion(this._worldQuaternionInv),Ct.divide(J),e.search("X")===-1&&(Ct.x=1),e.search("Y")===-1&&(Ct.y=1),e.search("Z")===-1&&(Ct.z=1);i.scale.copy(this._scaleStart).multiply(Ct),this.scaleSnap&&(e.search("X")!==-1&&(i.scale.x=Math.round(i.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),e.search("Y")!==-1&&(i.scale.y=Math.round(i.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),e.search("Z")!==-1&&(i.scale.z=Math.round(i.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(s==="rotate"){this._offset.copy(this.pointEnd).sub(this.pointStart);const a=20/this.worldPosition.distanceTo(J.setFromMatrixPosition(this.camera.matrixWorld));let h=!1;e==="XYZE"?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(J.copy(this.rotationAxis).cross(this.eye))*a):(e==="X"||e==="Y"||e==="Z")&&(this.rotationAxis.copy(Mi[e]),J.copy(Mi[e]),n==="local"&&J.applyQuaternion(this.worldQuaternion),J.cross(this.eye),J.length()===0?h=!0:this.rotationAngle=this._offset.dot(J.normalize())*a),(e==="E"||h)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),n==="local"&&e!=="E"&&e!=="XYZE"?(i.quaternion.copy(this._quaternionStart),i.quaternion.multiply(W.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),i.quaternion.copy(W.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),i.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(Ps),this.dispatchEvent(Di)}}pointerUp(t){t.button===0&&(this.dragging&&this.axis!==null&&(Ai.mode=this.mode,this.dispatchEvent(Ai)),this.dragging=!1,this.axis=null)}dispose(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.traverse(function(t){t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})}attach(t){return this.object=t,this.visible=!0,this}detach(){return this.object=void 0,this.visible=!1,this.axis=null,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(Ps),this.dispatchEvent(Di),this.pointStart.copy(this.pointEnd))}getRaycaster(){return Lt}getMode(){return this.mode}setMode(t){this.mode=t}setTranslationSnap(t){this.translationSnap=t}setRotationSnap(t){this.rotationSnap=t}setScaleSnap(t){this.scaleSnap=t}setSize(t){this.size=t}setSpace(t){this.space=t}}function Xr(r){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:r.button};{const t=this.domElement.getBoundingClientRect();return{x:(r.clientX-t.left)/t.width*2-1,y:-(r.clientY-t.top)/t.height*2+1,button:r.button}}}function Wr(r){if(this.enabled)switch(r.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(r));break}}function Qr(r){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(r.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(r)),this.pointerDown(this._getPointer(r)))}function qr(r){this.enabled&&this.pointerMove(this._getPointer(r))}function Kr(r){this.enabled&&(this.domElement.releasePointerCapture(r.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(r)))}function Cs(r,t,e){const s=t.intersectObject(r,!0);for(let i=0;i<s.length;i++)if(s[i].object.visible||e)return s[i];return!1}const Ge=new an,V=new O(0,1,0),Si=new O(0,0,0),Ui=new et,$e=new ft,es=new ft,xt=new O,Bi=new et,ge=new O(1,0,0),zt=new O(0,1,0),ye=new O(0,0,1),Je=new O,me=new O,fe=new O;class jr extends Ee{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const t=new Jt({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),e=new wn({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),s=t.clone();s.opacity=.15;const i=e.clone();i.opacity=.5;const n=t.clone();n.color.setHex(16711680);const o=t.clone();o.color.setHex(65280);const a=t.clone();a.color.setHex(255);const h=t.clone();h.color.setHex(16711680),h.opacity=.5;const l=t.clone();l.color.setHex(65280),l.opacity=.5;const c=t.clone();c.color.setHex(255),c.opacity=.5;const u=t.clone();u.opacity=.25;const d=t.clone();d.color.setHex(16776960),d.opacity=.25,t.clone().color.setHex(16776960);const p=t.clone();p.color.setHex(7895160);const y=new tt(0,.04,.1,12);y.translate(0,.05,0);const g=new $(.08,.08,.08);g.translate(0,.04,0);const f=new ss;f.setAttribute("position",new $s([0,0,0,1,0,0],3));const _=new tt(.0075,.0075,.5,3);_.translate(0,.25,0);function w(z,H){const Z=new se(z,.0075,3,64,H*Math.PI*2);return Z.rotateY(Math.PI/2),Z.rotateX(Math.PI/2),Z}function b(){const z=new ss;return z.setAttribute("position",new $s([0,0,0,1,1,1],3)),z}const m={X:[[new U(y,n),[.5,0,0],[0,0,-Math.PI/2]],[new U(y,n),[-.5,0,0],[0,0,Math.PI/2]],[new U(_,n),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new U(y,o),[0,.5,0]],[new U(y,o),[0,-.5,0],[Math.PI,0,0]],[new U(_,o)]],Z:[[new U(y,a),[0,0,.5],[Math.PI/2,0,0]],[new U(y,a),[0,0,-.5],[-Math.PI/2,0,0]],[new U(_,a),null,[Math.PI/2,0,0]]],XYZ:[[new U(new Se(.1,0),u.clone()),[0,0,0]]],XY:[[new U(new $(.15,.15,.01),c.clone()),[.15,.15,0]]],YZ:[[new U(new $(.15,.15,.01),h.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new U(new $(.15,.15,.01),l.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},x={X:[[new U(new tt(.2,0,.6,4),s),[.3,0,0],[0,0,-Math.PI/2]],[new U(new tt(.2,0,.6,4),s),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new U(new tt(.2,0,.6,4),s),[0,.3,0]],[new U(new tt(.2,0,.6,4),s),[0,-.3,0],[0,0,Math.PI]]],Z:[[new U(new tt(.2,0,.6,4),s),[0,0,.3],[Math.PI/2,0,0]],[new U(new tt(.2,0,.6,4),s),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new U(new Se(.2,0),s)]],XY:[[new U(new $(.2,.2,.01),s),[.15,.15,0]]],YZ:[[new U(new $(.2,.2,.01),s),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new U(new $(.2,.2,.01),s),[.15,0,.15],[-Math.PI/2,0,0]]]},P={START:[[new U(new Se(.01,2),i),null,null,null,"helper"]],END:[[new U(new Se(.01,2),i),null,null,null,"helper"]],DELTA:[[new Tt(b(),i),null,null,null,"helper"]],X:[[new Tt(f,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Tt(f,i.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Tt(f,i.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},E={XYZE:[[new U(w(.5,1),p),null,[0,Math.PI/2,0]]],X:[[new U(w(.5,.5),n)]],Y:[[new U(w(.5,.5),o),null,[0,0,-Math.PI/2]]],Z:[[new U(w(.5,.5),a),null,[0,Math.PI/2,0]]],E:[[new U(w(.75,1),d),null,[0,Math.PI/2,0]]]},T={AXIS:[[new Tt(f,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},M={XYZE:[[new U(new xn(.25,10,8),s)]],X:[[new U(new se(.5,.1,4,24),s),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new U(new se(.5,.1,4,24),s),[0,0,0],[Math.PI/2,0,0]]],Z:[[new U(new se(.5,.1,4,24),s),[0,0,0],[0,0,-Math.PI/2]]],E:[[new U(new se(.75,.1,2,24),s)]]},A={X:[[new U(g,n),[.5,0,0],[0,0,-Math.PI/2]],[new U(_,n),[0,0,0],[0,0,-Math.PI/2]],[new U(g,n),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new U(g,o),[0,.5,0]],[new U(_,o)],[new U(g,o),[0,-.5,0],[0,0,Math.PI]]],Z:[[new U(g,a),[0,0,.5],[Math.PI/2,0,0]],[new U(_,a),[0,0,0],[Math.PI/2,0,0]],[new U(g,a),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new U(new $(.15,.15,.01),c),[.15,.15,0]]],YZ:[[new U(new $(.15,.15,.01),h),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new U(new $(.15,.15,.01),l),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new U(new $(.1,.1,.1),u.clone())]]},S={X:[[new U(new tt(.2,0,.6,4),s),[.3,0,0],[0,0,-Math.PI/2]],[new U(new tt(.2,0,.6,4),s),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new U(new tt(.2,0,.6,4),s),[0,.3,0]],[new U(new tt(.2,0,.6,4),s),[0,-.3,0],[0,0,Math.PI]]],Z:[[new U(new tt(.2,0,.6,4),s),[0,0,.3],[Math.PI/2,0,0]],[new U(new tt(.2,0,.6,4),s),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new U(new $(.2,.2,.01),s),[.15,.15,0]]],YZ:[[new U(new $(.2,.2,.01),s),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new U(new $(.2,.2,.01),s),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new U(new $(.2,.2,.2),s),[0,0,0]]]},D={X:[[new Tt(f,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Tt(f,i.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Tt(f,i.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function B(z){const H=new Ee;for(const Z in z)for(let at=z[Z].length;at--;){const q=z[Z][at][0].clone(),Oe=z[Z][at][1],Ae=z[Z][at][2],De=z[Z][at][3],nn=z[Z][at][4];q.name=Z,q.tag=nn,Oe&&q.position.set(Oe[0],Oe[1],Oe[2]),Ae&&q.rotation.set(Ae[0],Ae[1],Ae[2]),De&&q.scale.set(De[0],De[1],De[2]),q.updateMatrix();const js=q.geometry.clone();js.applyMatrix4(q.matrix),q.geometry=js,q.renderOrder=1/0,q.position.set(0,0,0),q.rotation.set(0,0,0),q.scale.set(1,1,1),H.add(q)}return H}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=B(m)),this.add(this.gizmo.rotate=B(E)),this.add(this.gizmo.scale=B(A)),this.add(this.picker.translate=B(x)),this.add(this.picker.rotate=B(M)),this.add(this.picker.scale=B(S)),this.add(this.helper.translate=B(P)),this.add(this.helper.rotate=B(T)),this.add(this.helper.scale=B(D)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(t){const e=(this.mode==="scale"?"local":this.space)==="local"?this.worldQuaternion:es;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let s=[];s=s.concat(this.picker[this.mode].children),s=s.concat(this.gizmo[this.mode].children),s=s.concat(this.helper[this.mode].children);for(let i=0;i<s.length;i++){const n=s[i];n.visible=!0,n.rotation.set(0,0,0),n.position.copy(this.worldPosition);let o;if(this.camera.isOrthographicCamera?o=(this.camera.top-this.camera.bottom)/this.camera.zoom:o=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),n.scale.set(1,1,1).multiplyScalar(o*this.size/4),n.tag==="helper"){n.visible=!1,n.name==="AXIS"?(n.visible=!!this.axis,this.axis==="X"&&(W.setFromEuler(Ge.set(0,0,0)),n.quaternion.copy(e).multiply(W),Math.abs(V.copy(ge).applyQuaternion(e).dot(this.eye))>.9&&(n.visible=!1)),this.axis==="Y"&&(W.setFromEuler(Ge.set(0,0,Math.PI/2)),n.quaternion.copy(e).multiply(W),Math.abs(V.copy(zt).applyQuaternion(e).dot(this.eye))>.9&&(n.visible=!1)),this.axis==="Z"&&(W.setFromEuler(Ge.set(0,Math.PI/2,0)),n.quaternion.copy(e).multiply(W),Math.abs(V.copy(ye).applyQuaternion(e).dot(this.eye))>.9&&(n.visible=!1)),this.axis==="XYZE"&&(W.setFromEuler(Ge.set(0,Math.PI/2,0)),V.copy(this.rotationAxis),n.quaternion.setFromRotationMatrix(Ui.lookAt(Si,V,zt)),n.quaternion.multiply(W),n.visible=this.dragging),this.axis==="E"&&(n.visible=!1)):n.name==="START"?(n.position.copy(this.worldPositionStart),n.visible=this.dragging):n.name==="END"?(n.position.copy(this.worldPosition),n.visible=this.dragging):n.name==="DELTA"?(n.position.copy(this.worldPositionStart),n.quaternion.copy(this.worldQuaternionStart),J.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),J.applyQuaternion(this.worldQuaternionStart.clone().invert()),n.scale.copy(J),n.visible=this.dragging):(n.quaternion.copy(e),this.dragging?n.position.copy(this.worldPositionStart):n.position.copy(this.worldPosition),this.axis&&(n.visible=this.axis.search(n.name)!==-1));continue}n.quaternion.copy(e),this.mode==="translate"||this.mode==="scale"?(n.name==="X"&&Math.abs(V.copy(ge).applyQuaternion(e).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="Y"&&Math.abs(V.copy(zt).applyQuaternion(e).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="Z"&&Math.abs(V.copy(ye).applyQuaternion(e).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="XY"&&Math.abs(V.copy(ye).applyQuaternion(e).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="YZ"&&Math.abs(V.copy(ge).applyQuaternion(e).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="XZ"&&Math.abs(V.copy(zt).applyQuaternion(e).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1)):this.mode==="rotate"&&($e.copy(e),V.copy(this.eye).applyQuaternion(W.copy(e).invert()),n.name.search("E")!==-1&&n.quaternion.setFromRotationMatrix(Ui.lookAt(this.eye,Si,zt)),n.name==="X"&&(W.setFromAxisAngle(ge,Math.atan2(-V.y,V.z)),W.multiplyQuaternions($e,W),n.quaternion.copy(W)),n.name==="Y"&&(W.setFromAxisAngle(zt,Math.atan2(V.x,V.z)),W.multiplyQuaternions($e,W),n.quaternion.copy(W)),n.name==="Z"&&(W.setFromAxisAngle(ye,Math.atan2(V.y,V.x)),W.multiplyQuaternions($e,W),n.quaternion.copy(W))),n.visible=n.visible&&(n.name.indexOf("X")===-1||this.showX),n.visible=n.visible&&(n.name.indexOf("Y")===-1||this.showY),n.visible=n.visible&&(n.name.indexOf("Z")===-1||this.showZ),n.visible=n.visible&&(n.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),n.material._color=n.material._color||n.material.color.clone(),n.material._opacity=n.material._opacity||n.material.opacity,n.material.color.copy(n.material._color),n.material.opacity=n.material._opacity,this.enabled&&this.axis&&(n.name===this.axis||this.axis.split("").some(function(a){return n.name===a}))&&(n.material.color.setHex(16776960),n.material.opacity=1)}super.updateMatrixWorld(t)}}class Gr extends U{constructor(){super(new Vs(1e5,1e5,2,2),new Jt({visible:!1,wireframe:!0,side:Me,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(t){let e=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(e="local"),Je.copy(ge).applyQuaternion(e==="local"?this.worldQuaternion:es),me.copy(zt).applyQuaternion(e==="local"?this.worldQuaternion:es),fe.copy(ye).applyQuaternion(e==="local"?this.worldQuaternion:es),V.copy(me),this.mode){case"translate":case"scale":switch(this.axis){case"X":V.copy(this.eye).cross(Je),xt.copy(Je).cross(V);break;case"Y":V.copy(this.eye).cross(me),xt.copy(me).cross(V);break;case"Z":V.copy(this.eye).cross(fe),xt.copy(fe).cross(V);break;case"XY":xt.copy(fe);break;case"YZ":xt.copy(Je);break;case"XZ":V.copy(fe),xt.copy(me);break;case"XYZ":case"E":xt.set(0,0,0);break}break;case"rotate":default:xt.set(0,0,0)}xt.length()===0?this.quaternion.copy(this.cameraQuaternion):(Bi.lookAt(J.set(0,0,0),xt,V),this.quaternion.setFromRotationMatrix(Bi)),super.updateMatrixWorld(t)}}class Ks{constructor(t,e,s,i,n,o=5,a=!0){if(v(this,"onDraggingStarted",new I),v(this,"onDraggingEnded",new I),v(this,"onDisposed",new I),v(this,"normal"),v(this,"origin"),v(this,"three",new Zs),v(this,"_helper"),v(this,"_visible",!0),v(this,"_enabled",!0),v(this,"components"),v(this,"world"),v(this,"_controlsActive",!1),v(this,"_arrowBoundBox",new U),v(this,"_planeMesh"),v(this,"_controls"),v(this,"_hiddenMaterial",new Jt({visible:!1})),v(this,"update",async()=>{this._enabled&&this.three.setFromNormalAndCoplanarPoint(this.normal,this._helper.position)}),v(this,"changeDrag",h=>{this._visible=!h.value,this.preventCameraMovement(),this.notifyDraggingChanged(h)}),this.components=t,this.world=e,!e.renderer)throw new Error("The given world must have a renderer!");this.normal=i,this.origin=s,e.renderer.setPlane(!0,this.three),this._planeMesh=Ks.newPlaneMesh(o,n),this._helper=this.newHelper(),this._controls=this.newTransformControls(),this.three.setFromNormalAndCoplanarPoint(i,s),a&&this.toggleControls(!0)}get enabled(){return this._enabled}set enabled(t){if(!this.world.renderer)throw new Error("No renderer found for clipping plane!");this._enabled=t,this.world.renderer.setPlane(t,this.three)}get visible(){return this._visible}set visible(t){this._visible=t,this._controls.visible=t,this._helper.visible=t,this.toggleControls(t)}get meshes(){return[this._planeMesh,this._arrowBoundBox]}get planeMaterial(){return this._planeMesh.material}set planeMaterial(t){this._planeMesh.material=t}get size(){return this._planeMesh.scale.x}set size(t){this._planeMesh.scale.set(t,t,t)}get helper(){return this._helper}async setFromNormalAndCoplanarPoint(t,e){this.reset(),this.normal.equals(t)||(this.normal.copy(t),this._helper.lookAt(t)),this.origin.copy(e),this._helper.position.copy(e),this._helper.updateMatrix(),await this.update()}dispose(){this._enabled=!1,this.onDraggingStarted.reset(),this.onDraggingEnded.reset(),this._helper.removeFromParent(),this.world.renderer&&this.world.renderer.setPlane(!1,this.three),this._arrowBoundBox.removeFromParent(),this._arrowBoundBox.geometry.dispose(),this._planeMesh.geometry.dispose(),this._controls.removeFromParent(),this._controls.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}reset(){const t=new O(1,0,0),e=new O;this.normal.equals(t)||(this.normal.copy(t),this._helper.lookAt(t)),this.origin.copy(e),this._helper.position.copy(e),this._helper.updateMatrix()}toggleControls(t){if(t){if(this._controlsActive)return;this._controls.addEventListener("change",this.update),this._controls.addEventListener("dragging-changed",this.changeDrag)}else this._controls.removeEventListener("change",this.update),this._controls.removeEventListener("dragging-changed",this.changeDrag);this._controlsActive=t}newTransformControls(){if(!this.world.renderer)throw new Error("No renderer found for clipping plane!");const t=this.world.camera.three,e=this.world.renderer.three.domElement,s=new Nr(t,e);return this.initializeControls(s),this.world.scene.three.add(s),s}initializeControls(t){t.attach(this._helper),t.showX=!1,t.showY=!1,t.setSpace("local"),this.createArrowBoundingBox(),t.children[0].children[0].add(this._arrowBoundBox)}createArrowBoundingBox(){this._arrowBoundBox.geometry=new tt(.18,.18,1.2),this._arrowBoundBox.material=this._hiddenMaterial,this._arrowBoundBox.rotateX(Math.PI/2),this._arrowBoundBox.updateMatrix(),this._arrowBoundBox.geometry.applyMatrix4(this._arrowBoundBox.matrix)}notifyDraggingChanged(t){t.value?this.onDraggingStarted.trigger():this.onDraggingEnded.trigger()}preventCameraMovement(){this.world.camera.enabled=this._visible}newHelper(){const t=new Ee;return t.lookAt(this.normal),t.position.copy(this.origin),this._planeMesh.position.z+=.01,t.add(this._planeMesh),this.world.scene.three.add(t),t}static newPlaneMesh(t,e){const s=new Vs(1),i=new U(s,e);return i.scale.set(t,t,t),i}}const $r=class Is extends St{constructor(t){super(t),v(this,"onAfterCreate",new I),v(this,"onAfterDelete",new I),v(this,"onBeforeDrag",new I),v(this,"onAfterDrag",new I),v(this,"onBeforeCreate",new I),v(this,"onBeforeCancel",new I),v(this,"onAfterCancel",new I),v(this,"onBeforeDelete",new I),v(this,"onDisposed",new I),v(this,"orthogonalY",!1),v(this,"toleranceOrthogonalY",.7),v(this,"planes",[]),v(this,"PlaneType"),v(this,"_material",new Jt({color:16776960,side:Me,transparent:!0,opacity:.2})),v(this,"_size",5),v(this,"_enabled",!1),v(this,"_visible",!1),v(this,"_onStartDragging",()=>{this.onBeforeDrag.trigger()}),v(this,"_onEndDragging",()=>{this.onAfterDrag.trigger()}),this.components.add(Is.uuid,this),this.PlaneType=Ks}get enabled(){return this._enabled}set enabled(t){this._enabled=t;for(const e of this.planes)e.enabled=t;this.updateMaterialsAndPlanes()}get visible(){return this._visible}set visible(t){this._visible=t;for(const e of this.planes)e.visible=t}get material(){return this._material}set material(t){this._material=t;for(const e of this.planes)e.planeMaterial=t}get size(){return this._size}set size(t){this._size=t;for(const e of this.planes)e.size=t}endCreation(){}cancelCreation(){}dispose(){this._enabled=!1;for(const t of this.planes)t.dispose();this.planes.length=0,this._material.dispose(),this.onBeforeCreate.reset(),this.onBeforeCancel.reset(),this.onBeforeDelete.reset(),this.onBeforeDrag.reset(),this.onAfterCreate.reset(),this.onAfterCancel.reset(),this.onAfterDelete.reset(),this.onAfterDrag.reset(),this.onDisposed.trigger(Is.uuid),this.onDisposed.reset()}create(t){if(!this.enabled)return;const e=this.components.get(yi).get(t).castRay();e&&this.createPlaneFromIntersection(t,e)}createFromNormalAndCoplanarPoint(t,e,s){const i=this.newPlane(t,s,e);return this.updateMaterialsAndPlanes(),i}delete(t,e){this.enabled&&(e||(e=this.pickPlane(t)),e&&this.deletePlane(e))}deleteAll(){for(;this.planes.length>0;){const t=this.planes[0];this.delete(t.world,t)}}deletePlane(t){const e=this.planes.indexOf(t);if(e!==-1){if(this.planes.splice(e,1),!t.world.renderer)throw new Error("Renderer not found for this plane's world!");t.world.renderer.setPlane(!1,t.three),t.dispose(),this.updateMaterialsAndPlanes(),this.onAfterDelete.trigger(t)}}pickPlane(t){const e=this.components.get(yi).get(t),s=this.getAllPlaneMeshes(),i=e.castRay(s);if(i){const n=i.object;return this.planes.find(o=>o.meshes.includes(n))}}getAllPlaneMeshes(){const t=[];for(const e of this.planes)t.push(...e.meshes);return t}createPlaneFromIntersection(t,e){var s;if(!t.renderer)throw new Error("The given world must have a renderer!");const i=e.point.distanceTo(new O(0,0,0)),n=(s=e.face)==null?void 0:s.normal;if(!i||!n)return;const o=this.getWorldNormal(e,n),a=this.newPlane(t,e.point,o.negate());t.renderer.setPlane(!0,a.three),this.updateMaterialsAndPlanes()}getWorldNormal(t,e){const s=t.object;let i=t.object.matrixWorld.clone();if(s instanceof be&&t.instanceId!==void 0){const a=new et;s.getMatrixAt(t.instanceId,a),i=a.multiply(i)}const n=new gn().getNormalMatrix(i),o=e.clone().applyMatrix3(n).normalize();return this.normalizePlaneDirectionY(o),o}normalizePlaneDirectionY(t){this.orthogonalY&&(t.y>this.toleranceOrthogonalY&&(t.x=0,t.y=1,t.z=0),t.y<-this.toleranceOrthogonalY&&(t.x=0,t.y=-1,t.z=0))}newPlane(t,e,s){const i=this.newPlaneInstance(t,e,s);return i.onDraggingStarted.add(this._onStartDragging),i.onDraggingEnded.add(this._onEndDragging),this.planes.push(i),this.onAfterCreate.trigger(i),i}newPlaneInstance(t,e,s){return new this.PlaneType(this.components,t,e,s,this._material)}updateMaterialsAndPlanes(){const t=this.components.get(en);for(const[e,s]of t.list){if(!s.renderer)continue;s.renderer.updateClippingPlanes();const{clippingPlanes:i}=s.renderer;for(const n of s.meshes)if(Array.isArray(n.material))for(const o of n.material)o.clippingPlanes=i;else n.material.clippingPlanes=i}}};v($r,"uuid","66290bc5-18c4-4cd1-9379-2e17a0617611");const Jr=class Rs extends St{constructor(t){super(t),v(this,"enabled",!0),v(this,"_originalBackground",new Map),v(this,"onDisposed",new I),v(this,"list",{}),v(this,"_originals",{}),this.components.add(Rs.uuid,this)}set(t,e=Object.keys(this.list)){for(const s of e){const{material:i,meshes:n}=this.list[s];for(const o of n)if(t)this._originals[o.uuid]||(this._originals[o.uuid]={material:o.material}),o instanceof be&&o.instanceColor&&(this._originals[o.uuid].instances=o.instanceColor,o.instanceColor=null),o.material=i;else{if(!this._originals[o.uuid])continue;o.material=this._originals[o.uuid].material;const a=this._originals[o.uuid].instances;o instanceof be&&a&&(o.instanceColor=a)}}}dispose(){for(const t in this.list){const{material:e}=this.list[t];e.dispose()}this.list={},this._originals={},this.onDisposed.trigger(Rs.uuid),this.onDisposed.reset(),this._originalBackground.clear()}setBackgroundColor(t,e){const s=e.scene.three;s instanceof ve&&(this._originalBackground.has(e.uuid)||this._originalBackground.set(e.uuid,s.background),this._originalBackground&&(s.background=t))}resetBackgroundColor(t){const e=t.scene.three;if(!(e instanceof ve))return;const s=this._originalBackground.get(t.uuid);s&&(e.background=s)}addMaterial(t,e){if(this.list[t])throw new Error("This ID already exists!");this.list[t]={material:e,meshes:new Set}}addMeshes(t,e){if(!this.list[t])throw new Error("This ID doesn't exists!");for(const s of e)this.list[t].meshes.add(s)}removeMeshes(t,e){if(!this.list[t])throw new Error("This ID doesn't exists!");for(const s of e)this.list[t].meshes.delete(s)}};v(Jr,"uuid","24989d27-fa2f-4797-8b08-35918f74e502");function to(r,t,e,s){return new Promise((i,n)=>{function o(){const a=r.clientWaitSync(t,e,0);if(a===r.WAIT_FAILED){n();return}if(a===r.TIMEOUT_EXPIRED){setTimeout(o,s);return}i()}o()})}async function eo(r,t,e,s,i,n,o){const a=r.fenceSync(r.SYNC_GPU_COMMANDS_COMPLETE,0);r.flush(),await to(r,a,0,10),r.deleteSync(a),r.bindBuffer(t,e),r.getBufferSubData(t,s,i,n,o),r.bindBuffer(t,null)}async function so(r,t,e,s,i,n,o,a){const h=r.createBuffer();return r.bindBuffer(r.PIXEL_PACK_BUFFER,h),r.bufferData(r.PIXEL_PACK_BUFFER,a.byteLength,r.STREAM_READ),r.readPixels(t,e,s,i,n,o,0),r.bindBuffer(r.PIXEL_PACK_BUFFER,null),await eo(r,r.PIXEL_PACK_BUFFER,h,0,a),r.deleteBuffer(h),a}class io{constructor(t,e,s){if(v(this,"onDisposed",new I),v(this,"onViewUpdated",new I),v(this,"enabled",!0),v(this,"needsUpdate",!1),v(this,"renderDebugFrame",!1),v(this,"components"),v(this,"world"),v(this,"renderer"),v(this,"autoUpdate",!0),v(this,"updateInterval",1e3),v(this,"worker"),v(this,"scene",new ve),v(this,"_width",512),v(this,"_height",512),v(this,"_availableColor",1),v(this,"renderTarget"),v(this,"bufferSize"),v(this,"_buffer"),v(this,"updateVisibility",async o=>{if(!this.enabled||!this.needsUpdate&&!o)return;const a=this.world.camera.three;a.updateMatrix(),this.renderer.setSize(this._width,this._height),this.renderer.setRenderTarget(this.renderTarget),this.renderer.render(this.scene,a);const h=this.renderer.getContext();await so(h,0,0,this._width,this._height,h.RGBA,h.UNSIGNED_BYTE,this._buffer),this.renderer.setRenderTarget(null),this.renderDebugFrame&&this.renderer.render(this.scene,a),this.worker.postMessage({buffer:this._buffer}),this.needsUpdate=!1}),!e.renderer)throw new Error("The given world must have a renderer!");this.components=t,this.applySettings(s),this.world=e,this.renderer=new Ms,this.renderTarget=new vn(this._width,this._height),this.bufferSize=this._width*this._height*4,this._buffer=new Uint8Array(this.bufferSize),this.renderer.clippingPlanes=e.renderer.clippingPlanes;const i=`
      addEventListener("message", (event) => {
        const { buffer } = event.data;
        const colors = new Map();
        for (let i = 0; i < buffer.length; i += 4) {
          const r = buffer[i];
          const g = buffer[i + 1];
          const b = buffer[i + 2];
          const code = "" + r + "-" + g + "-" + b;
          if(colors.has(code)) {
            colors.set(code, colors.get(code) + 1);
          } else {
            colors.set(code, 1);
          }
        }
        postMessage({ colors });
      });
    `,n=new Blob([i],{type:"application/javascript"});this.worker=new Worker(URL.createObjectURL(n))}dispose(){this.enabled=!1;for(const t of this.scene.children)t.removeFromParent();this.onViewUpdated.reset(),this.worker.terminate(),this.renderer.dispose(),this.renderTarget.dispose(),this._buffer=null,this.onDisposed.reset()}getAvailableColor(){let t=BigInt(this._availableColor.toString());const e=[];do e.unshift(Number(t%256n)),t/=256n;while(t);for(;e.length!==3;)e.unshift(0);const[s,i,n]=e,o=`${s}-${i}-${n}`;return{r:s,g:i,b:n,code:o}}increaseColor(){if(this._availableColor===256*256*256){console.warn("Color can't be increased over 256 x 256 x 256!");return}this._availableColor++}decreaseColor(){if(this._availableColor===1){console.warn("Color can't be decreased under 0!");return}this._availableColor--}applySettings(t){t&&(t.updateInterval!==void 0&&(this.updateInterval=t.updateInterval),t.height!==void 0&&(this._height=t.height),t.width!==void 0&&(this._width=t.width),t.autoUpdate!==void 0&&(this.autoUpdate=t.autoUpdate))}}class no extends io{constructor(t,e,s){super(t,e,s),v(this,"threshold",100),v(this,"onViewUpdated",new I),v(this,"colorMeshes",new Map),v(this,"isProcessing",!1),v(this,"_colorCodeMeshMap",new Map),v(this,"_meshIDColorCodeMap",new Map),v(this,"_currentVisibleMeshes",new Set),v(this,"_recentlyHiddenMeshes",new Set),v(this,"_transparentMat",new Jt({transparent:!0,opacity:0})),v(this,"handleWorkerMessage",async i=>{if(this.isProcessing)return;const n=i.data.colors;this._recentlyHiddenMeshes=new Set(this._currentVisibleMeshes),this._currentVisibleMeshes.clear();for(const[o,a]of n){if(a<this.threshold)continue;const h=this._colorCodeMeshMap.get(o);h&&(this._currentVisibleMeshes.add(h),this._recentlyHiddenMeshes.delete(h))}this.onViewUpdated.trigger({seen:this._currentVisibleMeshes,unseen:this._recentlyHiddenMeshes})}),this.worker.addEventListener("message",this.handleWorkerMessage),this.autoUpdate&&window.setInterval(async()=>{this.isProcessing||await this.updateVisibility()},this.updateInterval),this.onViewUpdated.add(({seen:i,unseen:n})=>{for(const o of i)o.visible=!0;for(const o of n)o.visible=!1})}dispose(){super.dispose(),this._currentVisibleMeshes.clear(),this._recentlyHiddenMeshes.clear(),this._meshIDColorCodeMap.clear(),this._transparentMat.dispose(),this._colorCodeMeshMap.clear();const t=this.components.get(Te);for(const e in this.colorMeshes){const s=this.colorMeshes.get(e);s&&t.destroy(s,!0)}this.colorMeshes.clear()}add(t){if(!this.enabled)return;if(this.isProcessing){console.log("Culler processing not finished yet.");return}this.isProcessing=!0;const e=t instanceof be,{geometry:s,material:i}=t,{colorMaterial:n,code:o}=this.getAvailableMaterial();let a;if(Array.isArray(i)){let c=!0;const u=[];for(const d of i)gi.isTransparent(d)?u.push(this._transparentMat):(c=!1,u.push(n));if(c){n.dispose(),this.isProcessing=!1;return}a=u}else if(gi.isTransparent(i)){n.dispose(),this.isProcessing=!1;return}else a=n;this._colorCodeMeshMap.set(o,t),this._meshIDColorCodeMap.set(t.uuid,o);const h=e?t.count:1,l=new be(s,a,h);e?l.instanceMatrix=t.instanceMatrix:l.setMatrixAt(0,new et),t.visible=!1,l.applyMatrix4(t.matrix),l.updateMatrix(),this.scene.add(l),this.colorMeshes.set(t.uuid,l),this.increaseColor(),this.isProcessing=!1}remove(t){if(this.isProcessing){console.log("Culler processing not finished yet.");return}this.isProcessing=!0;const e=this.components.get(Te);this._currentVisibleMeshes.delete(t),this._recentlyHiddenMeshes.delete(t);const s=this.colorMeshes.get(t.uuid),i=this._meshIDColorCodeMap.get(t.uuid);if(!s||!i){this.isProcessing=!1,console.log(t.visible);return}this._colorCodeMeshMap.delete(i),this._meshIDColorCodeMap.delete(t.uuid),this.colorMeshes.delete(t.uuid),s.geometry=void 0,s.material=[],e.destroy(s,!0),this._recentlyHiddenMeshes.delete(t),this._currentVisibleMeshes.delete(t),this.isProcessing=!1}getAvailableMaterial(){const{r:t,g:e,b:s,code:i}=this.getAvailableColor(),n=as.enabled;as.enabled=!1;const o=new we(`rgb(${t}, ${e}, ${s})`);if(!this.world.renderer)throw new Error("Renderer not found in the world!");const a=this.world.renderer.clippingPlanes,h=new Jt({color:o,clippingPlanes:a,side:Me});return as.enabled=n,{colorMaterial:h,code:i}}}const ro=class ks extends St{constructor(t){super(t),v(this,"_enabled",!0),v(this,"list",new Map),v(this,"onDisposed",new I),t.add(ks.uuid,this)}get enabled(){return this._enabled}set enabled(t){this._enabled=t;for(const[e,s]of this.list)s.enabled=t}create(t,e){if(this.list.has(t.uuid))return this.list.get(t.uuid);const s=new no(this.components,t,e);return this.list.set(t.uuid,s),s}remove(t){const e=this.list.get(t.uuid);e&&e.dispose(),this.list.delete(t.uuid)}dispose(){this.enabled=!1,this.onDisposed.trigger(ks.uuid),this.onDisposed.reset();for(const[t,e]of this.list)e.dispose();this.list.clear()}};v(ro,"uuid","69f2a50d-c266-44fc-b1bd-fa4d34be89e6");class oo extends Ee{constructor(t=document.createElement("div")){super(),this.isCSS2DObject=!0,this.element=t,this.element.style.position="absolute",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.center=new _t(.5,.5),this.addEventListener("removed",function(){this.traverse(function(e){e.element instanceof Element&&e.element.parentNode!==null&&e.element.parentNode.removeChild(e.element)})})}copy(t,e){return super.copy(t,e),this.element=t.element.cloneNode(!0),this.center=t.center,this}}const Gt=new O,Li=new et,zi=new et,Fi=new O,Ii=new O;class ao{constructor(t={}){const e=this;let s,i,n,o;const a={objects:new WeakMap},h=t.element!==void 0?t.element:document.createElement("div");h.style.overflow="hidden",this.domElement=h,this.getSize=function(){return{width:s,height:i}},this.render=function(p,y){p.matrixWorldAutoUpdate===!0&&p.updateMatrixWorld(),y.parent===null&&y.matrixWorldAutoUpdate===!0&&y.updateMatrixWorld(),Li.copy(y.matrixWorldInverse),zi.multiplyMatrices(y.projectionMatrix,Li),l(p,p,y),d(p)},this.setSize=function(p,y){s=p,i=y,n=s/2,o=i/2,h.style.width=p+"px",h.style.height=y+"px"};function l(p,y,g){if(p.isCSS2DObject){Gt.setFromMatrixPosition(p.matrixWorld),Gt.applyMatrix4(zi);const f=p.visible===!0&&Gt.z>=-1&&Gt.z<=1&&p.layers.test(g.layers)===!0;if(p.element.style.display=f===!0?"":"none",f===!0){p.onBeforeRender(e,y,g);const w=p.element;w.style.transform="translate("+-100*p.center.x+"%,"+-100*p.center.y+"%)translate("+(Gt.x*n+n)+"px,"+(-Gt.y*o+o)+"px)",w.parentNode!==h&&h.appendChild(w),p.onAfterRender(e,y,g)}const _={distanceToCameraSquared:c(g,p)};a.objects.set(p,_)}for(let f=0,_=p.children.length;f<_;f++)l(p.children[f],y,g)}function c(p,y){return Fi.setFromMatrixPosition(p.matrixWorld),Ii.setFromMatrixPosition(y.matrixWorld),Fi.distanceToSquared(Ii)}function u(p){const y=[];return p.traverse(function(g){g.isCSS2DObject&&y.push(g)}),y}function d(p){const y=u(p).sort(function(f,_){if(f.renderOrder!==_.renderOrder)return _.renderOrder-f.renderOrder;const w=a.objects.get(f).distanceToCameraSquared,b=a.objects.get(_).distanceToCameraSquared;return w-b}),g=y.length;for(let f=0,_=y.length;f<_;f++)y[f].element.style.zIndex=g-f}}}class ho extends Rr{constructor(e,s,i){super(e,s,i);G(this,"three2D",new ao);this.onAfterUpdate.add(()=>{if(this.onBeforeUpdate.trigger(this),!this.enabled||!this.currentWorld)return;const n=this.currentWorld.scene.three,o=this.currentWorld.camera.three;n instanceof ve&&this.three2D.render(n,o)}),this.onDisposed.add(()=>{this.three2D.domElement.remove()}),this.onResize.add(({x:n,y:o})=>{this.three2D.setSize(n,o)}),this.onContainerUpdated.add(n=>{n.appendChild(this.three2D.domElement)}),this.setupHtmlRenderer(),this.resize()}setupHtmlRenderer(){this.three2D.domElement.style.position="absolute",this.three2D.domElement.style.top="0px",this.three2D.domElement.style.pointerEvents="none",this.container&&this.container.appendChild(this.three2D.domElement)}}class Ri{constructor(t,e,s){G(this,"three");G(this,"world");G(this,"onDisposed",new I);this.world=t;let i;e?i=e:(i=document.createElement("div"),i.className="w-[15px] h-[15px] border-3 border-solid border-red-600"),this.three=new oo(i);const n=s||t.scene.three;n.add(this.three),console.log(n),this.visible=!0}set visible(t){this.three.visible=t}get visible(){return this.three.visible}toggleVisibility(){this.visible=!this.visible}dispose(){this.three.removeFromParent(),this.three.element.remove(),this.onDisposed.trigger(),this.onDisposed.reset()}}const ns=class ns extends St{constructor(e){super(e);G(this,"enabled",!0);G(this,"clusterOnZoom",!0);G(this,"clusterThreshold",50);G(this,"list",new Set);G(this,"clusterLabels",new Set);G(this,"currentKeys",new Set);G(this,"_color","white");G(this,"_markerKey",0);G(this,"_clusterKey",0);G(this,"isNavigating",!1);G(this,"_setupWorlds",new Set);e.add(ns.uuid,this)}get color(){return this._color}set color(e){this._color=e;for(const s of this.list)s.label.three.element.style.color=e}create(e,s,i){this.setupEvents(e,!0);const n=document.createElement("span");n.innerHTML=s,n.style.color=this._color;const o=new Ri(e,n);o.three.position.copy(i),this.list.add({label:o,key:this._markerKey.toString(),merged:!1,static:!1}),this._markerKey++}clear(e){const s=[...this.list];for(const i of s)e&&i.type!==e||(i.label.dispose(),this.list.delete(i));this.list.clear(),this._markerKey=0}dispose(){for(const e of this.list)e.label.dispose();this.list.clear(),this._markerKey=0;for(const e of this.clusterLabels)e.label.dispose();this.clusterLabels.clear(),this._clusterKey=0,this.currentKeys.clear()}setupEvents(e,s){s&&this._setupWorlds.has(e.uuid)||e.camera.hasCameraControls()&&(s?(e.camera.controls.addEventListener("sleep",()=>{this.manageCluster()}),e.camera.controls.addEventListener("rest",()=>{this.isNavigating&&(this.manageCluster(),this.isNavigating=!1)})):(e.camera.controls.removeEventListener("sleep",()=>{this.manageCluster()}),e.camera.controls.removeEventListener("rest",()=>{this.isNavigating&&(this.manageCluster(),this.isNavigating=!1)})))}resetMarkers(){for(const e of this.list)e.merged=!1;for(const e of this.clusterLabels)e.label.dispose();this.clusterLabels.clear(),this._clusterKey=0}removeMergeMarkers(){for(const e of this.list)e.merged?e.label.dispose():e.label.world.scene.three.add(e.label.three);for(const e of this.clusterLabels)if(e.markerKeys.length===1){const s=Array.from(this.list).find(i=>i.key===e.markerKeys[0]);s&&(s.label.world.scene.three.add(s.label.three),s.merged=!1),e.label.dispose(),this.clusterLabels.delete(e)}}manageCluster(){this.resetMarkers();for(const e of this.list)if(!e.merged&&!e.static){this.currentKeys.clear();for(const s of this.list)s.static||e.key!==s.key&&!s.merged&&this.distance(e.label,s.label)<this.clusterThreshold&&(this.currentKeys.add(s.key),s.merged=!0);if(this.currentKeys.size>0){this.currentKeys.add(e.key),e.merged=!0;const s=Array.from(this.currentKeys),i=this.getAveragePositionFromLabels(s),n=new Ri(e.label.world,this.createClusterElement(this._clusterKey.toString())),{element:o}=n.three;o.textContent=s.length.toString(),n.three.position.copy(i),this.clusterLabels.add({key:this._clusterKey.toString(),markerKeys:s,label:n}),this._clusterKey++}}this.removeMergeMarkers()}getAveragePositionFromLabels(e){const s=e.map(i=>{const n=Array.from(this.list).find(o=>o.key===i);return n?n.label.three.position:new O});return s.reduce((i,n)=>i.add(n),new O).divideScalar(s.length)}createClusterElement(e){const s=document.createElement("div");return s.textContent=e,s.style.color="#000000",s.style.background="#FFFFFF",s.style.fontSize="1.2rem",s.style.fontWeight="500",s.style.pointerEvents="auto",s.style.borderRadius="50%",s.style.padding="5px 11px",s.style.textAlign="center",s.style.cursor="pointer",s.addEventListener("pointerdown",()=>{this.navigateToCluster(e)}),s.addEventListener("pointerover",()=>{s.style.background="#BCF124"}),s.addEventListener("pointerout",()=>{s.style.background="#FFFFFF"}),s}getScreenPosition(e){const s=new O;if(!e.world.renderer)throw new Error("Renderer not found!");const i=e.three.position.clone();i.project(e.world.camera.three);const n=e.world.renderer.getSize();return s.x=i.x*n.x/2+n.x/2,s.y=-(i.y*n.y/2)+n.y/2,s}distance(e,s){const i=this.getScreenPosition(e),n=this.getScreenPosition(s),o=i.x-n.x,a=i.y-n.y,h=Math.sqrt(o*o+a*a)*.5;return h===0?this.clusterThreshold+1:h}navigateToCluster(e){const s=[],i=Array.from(this.clusterLabels).find(d=>d.key===e);if(!i)return;const n=i.label.world.camera;if(!n.hasCameraControls()){console.warn("Zoom to clusters only supported with Camera Controls!");return}for(const d of i.markerKeys){const p=Array.from(this.list).find(y=>y.key===d);p&&s.push(p.label.three.position)}i.label.dispose(),this.clusterLabels.delete(i);const o=this.createBox3FromPoints(s),a=new O;o.getSize(a);const h=new O;o.getCenter(h);const l=new $(a.x,a.y,a.z);l.translate(h.x,h.y,h.z);const c=new U(l);c.geometry.computeBoundingSphere(),c.geometry.boundingSphere&&n.controls.fitToSphere(c,!0),this.isNavigating=!0,l.dispose(),c.clear(),s.length=0}createBox3FromPoints(e){const s=new ot;for(const i of e)s.expandByPoint(i);return s}};G(ns,"uuid","fdb61dc4-2ec1-4966-b83d-54ea795fad4a");let Hs=ns;const lo=document.getElementById("container"),Ft=new Br,co=Ft.get(en),ee=co.create();ee.scene=new Ir(Ft);ee.renderer=new ho(Ft,lo);ee.camera=new Ce(Ft);Ft.init();ee.camera.controls.setLookAt(5,5,5,0,0,0);const uo=Ft.get(sn);uo.create(ee);const po=Ft.get(Hs);po.create(ee,"Helloooo!",new O);
