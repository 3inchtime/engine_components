var L=Object.defineProperty;var _=(l,n,t)=>n in l?L(l,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[n]=t;var i=(l,n,t)=>(_(l,typeof n!="symbol"?n+"":n,t),t);import{V as m,f as C,i as E,b as S}from"./unzipit.module-DoMll51G.js";import{i as F,E as x,d as M,j as A,R as P,W as N,A as W}from"./N8AO-DNqyA7wK.js";import{M as b}from"./mark-CFP8TpRZ.js";import"./serializer-mvlfGVOZ.js";import"./stream-serializer-CIKXTIZE.js";import"./_commonjsHelpers-Cpj98o6Y.js";const g=class g extends F{constructor(t){super(t);i(this,"enabled",!0);i(this,"threshold",50);i(this,"autoCluster",!0);i(this,"list",new Map);i(this,"clusterLabels",new Set);i(this,"currentKeys",new Set);i(this,"_color","white");i(this,"_markerKey",0);i(this,"_clusterKey",0);i(this,"isNavigating",!1);i(this,"_setupWorlds",new Set);t.add(g.uuid,this)}get color(){return this._color}set color(t){this._color=t;for(const[e,r]of this.list)r.label.three.element.style.color=t}create(t,e,r){this.setupEvents(t,!0);const s=document.createElement("span");s.innerHTML=e,s.style.color=this._color;const o=new b(t,s);o.three.position.copy(r);const a=this._markerKey.toString();return this.list.set(a,{key:a,label:o,merged:!1,static:!1}),this._markerKey++,a}delete(t){const e=this.list.get(t);e&&e.label.dispose(),this.list.delete(t)}clear(t){const e=[...this.list.keys()];for(const r of e){const s=this.list.get(r);t&&s.type!==t||(s.label.dispose(),this.list.delete(r))}this.list.clear(),this._markerKey=0}dispose(){for(const[t,e]of this.list)e.label.dispose();this.list.clear(),this._markerKey=0;for(const t of this.clusterLabels)t.label.dispose();this.clusterLabels.clear(),this._clusterKey=0,this.currentKeys.clear()}setupEvents(t,e){e&&this._setupWorlds.has(t.uuid)||t.camera.hasCameraControls()&&(e?(t.camera.controls.addEventListener("sleep",()=>{this.manageCluster()}),t.camera.controls.addEventListener("rest",()=>{this.isNavigating&&(this.manageCluster(),this.isNavigating=!1)})):(t.camera.controls.removeEventListener("sleep",()=>{this.manageCluster()}),t.camera.controls.removeEventListener("rest",()=>{this.isNavigating&&(this.manageCluster(),this.isNavigating=!1)})))}resetMarkers(){for(const[t,e]of this.list)e.merged=!1;for(const t of this.clusterLabels)t.label.dispose();this.clusterLabels.clear(),this._clusterKey=0}removeMergeMarkers(){for(const[t,e]of this.list)e.merged?e.label.dispose():e.label.world.scene.three.add(e.label.three);for(const t of this.clusterLabels)if(t.markerKeys.length===1){const e=this.list.get(t.markerKeys[0]);e&&(e.label.world.scene.three.add(e.label.three),e.merged=!1),t.label.dispose(),this.clusterLabels.delete(t)}}manageCluster(){if(this.autoCluster){this.resetMarkers();for(const[t,e]of this.list)if(!e.merged&&!e.static){this.currentKeys.clear();for(const[r,s]of this.list)s.static||e.key!==s.key&&!s.merged&&this.distance(e.label,s.label)<this.threshold&&(this.currentKeys.add(s.key),s.merged=!0);if(this.currentKeys.size>0){this.currentKeys.add(e.key),e.merged=!0;const r=Array.from(this.currentKeys),s=this.getAveragePositionFromLabels(r),o=new b(e.label.world,this.createClusterElement(this._clusterKey.toString())),{element:a}=o.three;a.textContent=r.length.toString(),o.three.position.copy(s),this.clusterLabels.add({key:this._clusterKey.toString(),markerKeys:r,label:o}),this._clusterKey++}}this.removeMergeMarkers()}}getAveragePositionFromLabels(t){const e=t.map(r=>{const s=this.list.get(r);return s?s.label.three.position:new m});return e.reduce((r,s)=>r.add(s),new m).divideScalar(e.length)}createClusterElement(t){const e=document.createElement("div");return e.textContent=t,e.style.color="#000000",e.style.background="#FFFFFF",e.style.fontSize="1.2rem",e.style.fontWeight="500",e.style.pointerEvents="auto",e.style.borderRadius="50%",e.style.padding="5px 11px",e.style.textAlign="center",e.style.cursor="pointer",e.addEventListener("pointerdown",()=>{this.navigateToCluster(t)}),e.addEventListener("pointerover",()=>{e.style.background="#BCF124"}),e.addEventListener("pointerout",()=>{e.style.background="#FFFFFF"}),e}getScreenPosition(t){const e=new m;if(!t.world.renderer)throw new Error("Renderer not found!");const r=t.three.position.clone();r.project(t.world.camera.three);const s=t.world.renderer.getSize();return e.x=r.x*s.x/2+s.x/2,e.y=-(r.y*s.y/2)+s.y/2,e}distance(t,e){const r=this.getScreenPosition(t),s=this.getScreenPosition(e),o=r.x-s.x,a=r.y-s.y,h=Math.sqrt(o*o+a*a)*.5;return h===0?this.threshold+1:h}navigateToCluster(t){const e=[],r=Array.from(this.clusterLabels).find(f=>f.key===t);if(!r)return;const s=r.label.world.camera;if(!s.hasCameraControls()){console.warn("Zoom to clusters only supported with Camera Controls!");return}for(const f of r.markerKeys){const p=this.list.get(f);if(p){const{x:v,y:w,z:K}=p.label.three.position;e.push(v,w,K)}}r.label.dispose(),this.clusterLabels.delete(r);const o=new C,a=new Float32Array(e),h=new E(a,3);o.setAttribute("position",h);const u=new S(o);u.geometry.computeBoundingSphere(),u.geometry.boundingSphere&&s.controls.fitToSphere(u,!0),this.isNavigating=!0,o.dispose(),u.clear(),e.length=0}};i(g,"uuid","4079eb91-79b0-4ede-bcf2-15b837129236");let y=g;const z=document.getElementById("container"),c=new x,B=c.get(M),d=B.create();d.scene=new A(c);d.renderer=new P(c,z);d.camera=new N(c);c.init();d.camera.controls.setLookAt(5,5,5,0,0,0);const R=c.get(W);R.create(d);const k=c.get(y);k.threshold=10;for(let l=0;l<20;l++){const n=Math.random()*5,t=Math.random()*5,e=Math.random()*5;k.create(d,"ðŸš€",new m(n,t,e))}
